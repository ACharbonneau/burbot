---
title: "2018_burbot_resp_analysis"
author: "Amanda" # Code and assistance generously shared from Vanessa Lo  
date: "1/17/2019"
output: html_document
---

## Load functions

First, load the functions you'll need and set the working directory:
```{r Load functions}
library(ggplot2);library(plyr);library(dplyr);library(reshape2);library(gtools);library(lubridate);library(magrittr);library(stringr);library(scales); library(tidyr)

setwd("/Users/amanda/Documents/Davis/BurbotExperiment/2018_burbot_resp/Respirometry/")
```


## Readclean
Create a function called "readclean" to read in the raw autoresp text files. The function skips the first 37 lines, renames the columns, and sets the datetime column. 
```{r}
readcleancannibal = function(x) { y = read.delim(x, skip=37, stringsAsFactors=F, fileEncoding="latin1") 
z = y[,c(1,2,4,6,7,10,13,16)]
names(z) <- c("DateTime","Phase","Salinity","Temp","CH1O2.sat","CH2O2.sat","CH3O2.sat","CH4O2.sat")
z$DateTime <- as.POSIXct(z$DateTime, format = "%m/%d/%Y/%I:%M:%S %p")
z}

readcleanplanktivore = function(x) { y = read.delim(x, skip=37, stringsAsFactors=F, fileEncoding="latin1") 
z = y[,c(1,2,4,6,7,10,13,16)]
names(z) <- c("DateTime","Phase","Salinity","Temp","CH1O2.sat","CH2O2.sat","CH3O2.sat","CH4O2.sat")
z$DateTime <- as.POSIXct(z$DateTime, format = "%d.%m.%Y/%I:%M:%S %p")
z}

# For cannibal text files, format = "%m/%d/%Y/%I:%M:%S %p"
# For planktivore text files, format = "%d.%m.%Y/%I:%M:%S %p" 

```


## Data

### Cannibals

#### D1_B1_C

```{r}
# Load txt file
RMR_raw <- readcleancannibal("2018_burbot_resp_D1_B1_C_raw.txt")

# Assign names for this trial: 

"Fish1" <- "D1_B1_C1"
"Fish2" <- "D1_B1_C2"
"Fish3" <- "D1_B1_C3"
"Fish4" <- "D1_B1_C4"

# Create a new column with the time in minutes from the start of the file: 


RMR_raw$Time.m <- sapply(seq_along(RMR_raw$DateTime),
function(i) as.numeric(difftime(RMR_raw$DateTime[i], RMR_raw$DateTime[1], units='mins')))


# Pull measure periods. Grep finds all of the data in the Phase column that contains the letter M. 

RMR <- RMR_raw[grep("M", RMR_raw$Phase), ]


# Pull out first value of each phase for graphing later
Phase.start <- ddply(RMR, "Phase", head, 1)
Phase.start <- Phase.start[,1:2]

# Change the column names of the chambers to the appropriate FishID:
Name.vec <- c(Fish1, Fish2, Fish3, Fish4)
names(RMR)[5:8] <- Name.vec


# Reshape the data so all O2 saturation values are in a single column:

RMR.2 <- melt(RMR, measure = Name.vec)

# Rename the columns. 
names(RMR.2) <-c("DateTime","Phase","Salinity","Temp","Time.m","FishID","O2.sat")

# Plot the measurement periods of all fish from this trial:
p=ggplot(data=RMR.2, aes(x=Time.m, y=O2.sat, group=Phase))
p+geom_point(aes(color=FishID))+theme_bw()


# Separate out individual fish for graphing/analysis:

## Separate each fish to it's own RMR file: 
Fish1_RMR <- filter(RMR.2, FishID == Fish1)
Fish2_RMR <- filter(RMR.2, FishID == Fish2)
Fish3_RMR <- filter(RMR.2, FishID == Fish3)
Fish4_RMR <- filter(RMR.2, FishID == Fish4)

# Determine length of measurment period because they vary between trials. I chose measurement period 5 so it's not in the first few measurement periods where we were switching them manually but not the last measurement period either in case it was cut short. 
(nrow(Fish1_RMR[Fish1_RMR$Phase == "M5",]))/60

# Determine total time in chambers (in hours) because this also slightly varied between trials. 
(nrow(RMR_raw))/60/60

```


```{r, eval=FALSE}
## Plot individual measurement periods for each fish: 

p=ggplot(data=Fish1_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase), group=1)+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish1) 

p=ggplot(data=Fish2_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish2) 

p=ggplot(data=Fish3_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish3) 

p=ggplot(data=Fish4_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish4) 

##Plot individual measurement periods with the line of best fit: 

p=ggplot(data=Fish1_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish1) 

p=ggplot(data=Fish2_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish2) 

p=ggplot(data=Fish3_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish3) 

p=ggplot(data=Fish4_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish4) 
```

```{r}
# Calculate slopes of lines for each fish and convert slope from minutes to hours:
O2slopel1 <- dlply(Fish1_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope1 <- ldply(O2slopel1, function(d) coef(d))
names(O2slope1) <- c("Phase", "Intercept","Slope")
O2slope1<- mutate(O2slope1, FishID = Fish1)
O2slope1<-ddply(O2slope1, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel2 <- dlply(Fish2_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope2 <- ldply(O2slopel2, function(d) coef(d))
names(O2slope2) <- c("Phase", "Intercept","Slope")
O2slope2 <- mutate(O2slope2, FishID = Fish2)
O2slope2<-ddply(O2slope2, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel3 <- dlply(Fish3_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope3 <- ldply(O2slopel3, function(d) coef(d))
names(O2slope3) <- c("Phase", "Intercept","Slope")
O2slope3 <- mutate(O2slope3, FishID = Fish3)
O2slope3<-ddply(O2slope3, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel4 <- dlply(Fish4_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope4 <- ldply(O2slopel4, function(d) coef(d))
names(O2slope4) <- c("Phase", "Intercept","Slope")
O2slope4 <- mutate(O2slope4, FishID = Fish4)
O2slope4<-ddply(O2slope4, .(Phase), mutate, Slope.hour=Slope*60)


# Calculating the fit of each slope: 
O2.r2.1 <- dlply(Fish1_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit1<-ldply(O2.r2.1, function(d) d$r.squared)
slopefit1
names(slopefit1) <-c("Phase","r2")

O2.r2.2 <- dlply(Fish2_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit2<-ldply(O2.r2.2, function(d) d$r.squared)
slopefit2
names(slopefit2) <-c("Phase","r2")

O2.r2.3 <- dlply(Fish3_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit3<-ldply(O2.r2.3, function(d) d$r.squared)
slopefit3
names(slopefit3) <-c("Phase","r2")

O2.r2.4 <- dlply(Fish4_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit4<-ldply(O2.r2.4, function(d) d$r.squared)
slopefit4
names(slopefit4) <-c("Phase","r2")


# merge together slope and r2:
O2slope.r2.1<-merge(O2slope1, slopefit1, by=c("Phase"))
O2slope.r2.1<- O2slope.r2.1[mixedorder(O2slope.r2.1$Phase),]
O2slope.r2.1

O2slope.r2.2<-merge(O2slope2, slopefit2, by=c("Phase"))
O2slope.r2.2<- O2slope.r2.2[mixedorder(O2slope.r2.2$Phase),]
O2slope.r2.2

O2slope.r2.3<-merge(O2slope3, slopefit3, by=c("Phase"))
O2slope.r2.3<- O2slope.r2.3[mixedorder(O2slope.r2.3$Phase),]
O2slope.r2.3

O2slope.r2.4<-merge(O2slope4, slopefit4, by=c("Phase"))
O2slope.r2.4<- O2slope.r2.4[mixedorder(O2slope.r2.4$Phase),]
O2slope.r2.4

# bind all slope and r2 dataframes and sort the phases so they're in order:
slopes.r2.all <- rbind(O2slope.r2.1,O2slope.r2.2,O2slope.r2.3,O2slope.r2.4)
slopes.r2.all <- merge(slopes.r2.all, Phase.start, by=c("Phase"))
phase.sort <- unique(mixedsort(slopes.r2.all$Phase))
slopes.r2.all$Phase <- factor(slopes.r2.all$Phase, levels = phase.sort)


# Add mean temperature for that trial to the slopes.r2.all file. 
slopes.r2.all$meanTemp <- mean(RMR$Temp)

# Add in time from start of file

trial.first<- ddply(slopes.r2.all,"DateTime", head,1)
slopes.r2.all$Time.m <- difftime(slopes.r2.all$DateTime, head(trial.first$DateTime,1), units="mins", tz = "America/Los_Angeles")

# As you go through the text files from autoresp, you can consecutively add all of the slopes data, etc. to the slopes.all file, which is your big giant master file with all the data. After I calculate the slopes & r2 etc. for each file, then load the morphometrics data file and merge them together based on FishId. Bind days together first, then everything. 

slopes.all <- slopes.r2.all # Note that you only run this line for the very first batch to generate the slopes.all file! 


# Plot
ggplot(slopes.r2.all, aes(x=DateTime, y=(-1*Slope)))+
  geom_point(aes(color=FishID))+
  theme_bw()

# Above this point is to generate all of the slopes. But, we just want one representative slope for every fish. So I am averaging the three lowest slopes. Everything below is to generate just that one representative slope: 

# Sort based on slope value for every fish: 

Fish1_sorted_slopes <- O2slope.r2.1[order(-O2slope.r2.1$Slope.hour),]

Fish2_sorted_slopes <- O2slope.r2.2[order(-O2slope.r2.2$Slope.hour),]

Fish3_sorted_slopes <- O2slope.r2.3[order(-O2slope.r2.3$Slope.hour),]

Fish4_sorted_slopes <- O2slope.r2.4[order(-O2slope.r2.4$Slope.hour),]

# Remove the first two measurement periods. We don't want to include the first chunk of time immediately post-handling because thats a priori information that the fish was stressed. 

Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M1', Phase))
Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M2', Phase))
Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M1   ', Phase))
Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M2   ', Phase))

Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M1', Phase))
Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M2', Phase))
Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M1   ', Phase))
Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M2   ', Phase))

Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M1', Phase))
Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M2', Phase))
Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M1   ', Phase))
Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M2   ', Phase))

Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M1', Phase))
Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M2', Phase))
Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M1   ', Phase))
Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M2   ', Phase))

# Average lowest three

Fish1avgslopehour <- mean(head(Fish1_sorted_slopes$Slope.hour, 3))
Fish1avgslope <- mean(head(Fish1_sorted_slopes$Slope, 3))
Fish1avgR2 <- mean(head(Fish1_sorted_slopes$r2, 3))

Fish1finalRMR <- matrix(c(Fish1, Fish1avgslope, Fish1avgslopehour, Fish1avgR2), nrow=1, ncol=4)

Fish2avgslopehour <- mean(head(Fish2_sorted_slopes$Slope.hour, 3))
Fish2avgslope <- mean(head(Fish2_sorted_slopes$Slope, 3))
Fish2avgR2 <- mean(head(Fish2_sorted_slopes$r2, 3))

Fish2finalRMR <- matrix(c(Fish2, Fish2avgslope, Fish2avgslopehour, Fish2avgR2), nrow=1, ncol=4)

Fish3avgslopehour <- mean(head(Fish3_sorted_slopes$Slope.hour, 3))
Fish3avgslope <- mean(head(Fish3_sorted_slopes$Slope, 3))
Fish3avgR2 <- mean(head(Fish3_sorted_slopes$r2, 3))

Fish3finalRMR <- matrix(c(Fish3, Fish3avgslope, Fish3avgslopehour, Fish3avgR2), nrow=1, ncol=4)

Fish4avgslopehour <- mean(head(Fish4_sorted_slopes$Slope.hour, 3))
Fish4avgslope <- mean(head(Fish4_sorted_slopes$Slope, 3))
Fish4avgR2 <- mean(head(Fish4_sorted_slopes$r2, 3))

Fish4finalRMR <- matrix(c(Fish4, Fish4avgslope, Fish4avgslopehour, Fish4avgR2), nrow=1, ncol=4)

# Bind all averaged slopes from this trial together: 
average.slopes <- rbind(Fish1finalRMR, Fish2finalRMR, Fish3finalRMR, Fish4finalRMR)

#Add mean temp of this trial to final file: 
average.slopes <- cbind(average.slopes, mean(RMR$Temp))
colnames(average.slopes) <- c("FishID", "FinalSlope", "FinalSlopeHour", "FinalR2", "meanTemp")

slopes.all.final <- average.slopes # Note that you only run this line for the very first batch to generate the slopes.all file! 

# SO, you want the slopes.all.final slopes for the averaged of the lowest three. The slopes.all file has all of the measurement periods for every fish. 

```


#### D1_B2_C

```{r}
# Load txt file
RMR_raw <- readcleancannibal("2018_burbot_resp_D1_B2_C_raw.txt")

# Assign names for this trial: 

"Fish1" <- "D1_B2_C1"
"Fish2" <- "D1_B2_C2"
"Fish3" <- "D1_B2_C3"
"Fish4" <- "D1_B2_C4"

# Create a new column with the time in minutes from the start of the file: 

RMR_raw$Time.m <- sapply(seq_along(RMR_raw$DateTime),
function(i) as.numeric(difftime(RMR_raw$DateTime[i], RMR_raw$DateTime[1], units='mins')))


# Pull measure periods. Grep finds all of the data in the Phase column that contains the letter M. 

RMR <- RMR_raw[grep("M", RMR_raw$Phase), ]


# Pull out first value of each phase for graphing later
Phase.start <- ddply(RMR, "Phase", head, 1)
Phase.start <- Phase.start[,1:2]

# Change the column names of the chambers to the appropriate FishID:
Name.vec <- c(Fish1, Fish2, Fish3, Fish4)
names(RMR)[5:8] <- Name.vec


# Reshape the data so all O2 saturation values are in a single column:

RMR.2 <- melt(RMR, measure = Name.vec)

# Rename the columns. 
names(RMR.2) <-c("DateTime","Phase","Salinity","Temp","Time.m","FishID","O2.sat")

# Plot the measurement periods of all fish from this trial:
p=ggplot(data=RMR.2, aes(x=Time.m, y=O2.sat, group=Phase))
p+geom_point(aes(color=FishID))+theme_bw()


# Separate out individual fish for graphing/analysis:

## Separate each fish to it's own RMR file: 
Fish1_RMR <- filter(RMR.2, FishID == Fish1)
Fish2_RMR <- filter(RMR.2, FishID == Fish2)
Fish3_RMR <- filter(RMR.2, FishID == Fish3)
Fish4_RMR <- filter(RMR.2, FishID == Fish4)

# Determine length of measurment period in minutes because they vary between trials (ugh). I chose measurement period 5 so it's not in the first few measurement periods where we were switching them manually but not the last measurement period either in case it was cut short. 
(nrow(Fish1_RMR[Fish1_RMR$Phase == "M5",]))/60

# Determine total time in chambers (in hours) because this also slightly varied between trials (ugh). 
(nrow(RMR_raw))/60/60

```

```{r, eval=FALSE}
## Plot individual measurement periods for each fish: 
p=ggplot(data=Fish1_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase), group=1)+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish1) 

p=ggplot(data=Fish2_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish2) 

p=ggplot(data=Fish3_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish3) 

p=ggplot(data=Fish4_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish4) 

##Plot individual measurement periods with the line of best fit: 

p=ggplot(data=Fish1_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish1) 

p=ggplot(data=Fish2_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish2) 

p=ggplot(data=Fish3_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish3) 

p=ggplot(data=Fish4_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish4) 
```

```{r}
# Calculate slopes of lines for each fish and convert slope from minutes to hours:
O2slopel1 <- dlply(Fish1_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope1 <- ldply(O2slopel1, function(d) coef(d))
names(O2slope1) <- c("Phase", "Intercept","Slope")
O2slope1<- mutate(O2slope1, FishID = Fish1)
O2slope1<-ddply(O2slope1, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel2 <- dlply(Fish2_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope2 <- ldply(O2slopel2, function(d) coef(d))
names(O2slope2) <- c("Phase", "Intercept","Slope")
O2slope2 <- mutate(O2slope2, FishID = Fish2)
O2slope2<-ddply(O2slope2, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel3 <- dlply(Fish3_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope3 <- ldply(O2slopel3, function(d) coef(d))
names(O2slope3) <- c("Phase", "Intercept","Slope")
O2slope3 <- mutate(O2slope3, FishID = Fish3)
O2slope3<-ddply(O2slope3, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel4 <- dlply(Fish4_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope4 <- ldply(O2slopel4, function(d) coef(d))
names(O2slope4) <- c("Phase", "Intercept","Slope")
O2slope4 <- mutate(O2slope4, FishID = Fish4)
O2slope4<-ddply(O2slope4, .(Phase), mutate, Slope.hour=Slope*60)


# Calculating the fit of each slope: 
O2.r2.1 <- dlply(Fish1_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit1<-ldply(O2.r2.1, function(d) d$r.squared)
slopefit1
names(slopefit1) <-c("Phase","r2")

O2.r2.2 <- dlply(Fish2_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit2<-ldply(O2.r2.2, function(d) d$r.squared)
slopefit2
names(slopefit2) <-c("Phase","r2")

O2.r2.3 <- dlply(Fish3_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit3<-ldply(O2.r2.3, function(d) d$r.squared)
slopefit3
names(slopefit3) <-c("Phase","r2")

O2.r2.4 <- dlply(Fish4_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit4<-ldply(O2.r2.4, function(d) d$r.squared)
slopefit4
names(slopefit4) <-c("Phase","r2")


# merge together slope and r2:
O2slope.r2.1<-merge(O2slope1, slopefit1, by=c("Phase"))
O2slope.r2.1<- O2slope.r2.1[mixedorder(O2slope.r2.1$Phase),]
O2slope.r2.1

O2slope.r2.2<-merge(O2slope2, slopefit2, by=c("Phase"))
O2slope.r2.2<- O2slope.r2.2[mixedorder(O2slope.r2.2$Phase),]
O2slope.r2.2

O2slope.r2.3<-merge(O2slope3, slopefit3, by=c("Phase"))
O2slope.r2.3<- O2slope.r2.3[mixedorder(O2slope.r2.3$Phase),]
O2slope.r2.3

O2slope.r2.4<-merge(O2slope4, slopefit4, by=c("Phase"))
O2slope.r2.4<- O2slope.r2.4[mixedorder(O2slope.r2.4$Phase),]
O2slope.r2.4

# bind all slope and r2 dataframes and sort the phases so they're in order:
slopes.r2.all <- rbind(O2slope.r2.1,O2slope.r2.2,O2slope.r2.3,O2slope.r2.4)
slopes.r2.all <- merge(slopes.r2.all, Phase.start, by=c("Phase"))
phase.sort <- unique(mixedsort(slopes.r2.all$Phase))
slopes.r2.all$Phase <- factor(slopes.r2.all$Phase, levels = phase.sort)

# Add mean temperature for that trial to the slopes.r2.all file. 
slopes.r2.all$meanTemp <- mean(RMR$Temp)

# Add in time from start of file

trial.first<- ddply(slopes.r2.all,"DateTime", head,1)
slopes.r2.all$Time.m <- difftime(slopes.r2.all$DateTime, head(trial.first$DateTime,1), units="mins", tz = "America/Los_Angeles")

# As you go through the text files from autoresp, you can consecutively add all of the slopes data, etc. to the slopes.all file, which is your big giant master file with all the data. After I calculate the slopes & r2 etc. for each file, then load the morphometrics data file and merge them together based on FishId. Bind days together first, then everything. 
slopes.all <- rbind(slopes.all, slopes.r2.all)


# Plot
ggplot(slopes.r2.all, aes(x=DateTime, y=(-1*Slope)))+
  geom_point(aes(color=FishID))+
  theme_bw()


# Sort based on slope value for every fish: 

Fish1_sorted_slopes <- O2slope.r2.1[order(-O2slope.r2.1$Slope.hour),]

Fish2_sorted_slopes <- O2slope.r2.2[order(-O2slope.r2.2$Slope.hour),]

Fish3_sorted_slopes <- O2slope.r2.3[order(-O2slope.r2.3$Slope.hour),]

Fish4_sorted_slopes <- O2slope.r2.4[order(-O2slope.r2.4$Slope.hour),]

# Remove the first two measurement periods. We don't want to include the first chunk of time immediately post-handling because thats a priori information that the fish was stressed. 

Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M1', Phase))
Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M2', Phase))
Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M1   ', Phase))
Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M2   ', Phase))

Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M1', Phase))
Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M2', Phase))
Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M1   ', Phase))
Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M2   ', Phase))

Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M1', Phase))
Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M2', Phase))
Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M1   ', Phase))
Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M2   ', Phase))

Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M1', Phase))
Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M2', Phase))
Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M1   ', Phase))
Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M2   ', Phase))

# Average lowest three

Fish1avgslopehour <- mean(head(Fish1_sorted_slopes$Slope.hour, 3))
Fish1avgslope <- mean(head(Fish1_sorted_slopes$Slope, 3))
Fish1avgR2 <- mean(head(Fish1_sorted_slopes$r2, 3))

Fish1finalRMR <- matrix(c(Fish1, Fish1avgslope, Fish1avgslopehour, Fish1avgR2), nrow=1, ncol=4)

Fish2avgslopehour <- mean(head(Fish2_sorted_slopes$Slope.hour, 3))
Fish2avgslope <- mean(head(Fish2_sorted_slopes$Slope, 3))
Fish2avgR2 <- mean(head(Fish2_sorted_slopes$r2, 3))

Fish2finalRMR <- matrix(c(Fish2, Fish2avgslope, Fish2avgslopehour, Fish2avgR2), nrow=1, ncol=4)

Fish3avgslopehour <- mean(head(Fish3_sorted_slopes$Slope.hour, 3))
Fish3avgslope <- mean(head(Fish3_sorted_slopes$Slope, 3))
Fish3avgR2 <- mean(head(Fish3_sorted_slopes$r2, 3))

Fish3finalRMR <- matrix(c(Fish3, Fish3avgslope, Fish3avgslopehour, Fish3avgR2), nrow=1, ncol=4)

Fish4avgslopehour <- mean(head(Fish4_sorted_slopes$Slope.hour, 3))
Fish4avgslope <- mean(head(Fish4_sorted_slopes$Slope, 3))
Fish4avgR2 <- mean(head(Fish4_sorted_slopes$r2, 3))

Fish4finalRMR <- matrix(c(Fish4, Fish4avgslope, Fish4avgslopehour, Fish4avgR2), nrow=1, ncol=4)

# Bind all fish from this trial together: 
average.slopes <- rbind(Fish1finalRMR, Fish2finalRMR, Fish3finalRMR, Fish4finalRMR)


#Add mean temp of this trial to final file: 
average.slopes <- cbind(average.slopes, mean(RMR$Temp))
colnames(average.slopes) <- c("FishID", "FinalSlope", "FinalSlopeHour", "FinalR2", "meanTemp")


slopes.all.final <- rbind(average.slopes, slopes.all.final)
```

#### D1_B3_C

```{r}
# Load txt file
RMR_raw <- readcleancannibal("2018_burbot_resp_D1_B3_C_raw.txt")

# Assign names for this trial: 

"Fish1" <- "D1_B3_C1"
"Fish2" <- "D1_B3_C2"
"Fish3" <- "D1_B3_C3"
"Fish4" <- "D1_B3_C4"

# Create a new column with the time in minutes from the start of the file: 

RMR_raw$Time.m <- sapply(seq_along(RMR_raw$DateTime),
function(i) as.numeric(difftime(RMR_raw$DateTime[i], RMR_raw$DateTime[1], units='mins')))


# Pull measure periods. Grep finds all of the data in the Phase column that contains the letter M. 

RMR <- RMR_raw[grep("M", RMR_raw$Phase), ]


# Pull out first value of each phase for graphing later
Phase.start <- ddply(RMR, "Phase", head, 1)
Phase.start <- Phase.start[,1:2]

# Change the column names of the chambers to the appropriate FishID:
Name.vec <- c(Fish1, Fish2, Fish3, Fish4)
names(RMR)[5:8] <- Name.vec


# Reshape the data so all O2 saturation values are in a single column:

RMR.2 <- melt(RMR, measure = Name.vec)

# Rename the columns. 
names(RMR.2) <-c("DateTime","Phase","Salinity","Temp","Time.m","FishID","O2.sat")

# Plot the measurement periods of all fish from this trial:
p=ggplot(data=RMR.2, aes(x=Time.m, y=O2.sat, group=Phase))
p+geom_point(aes(color=FishID))+theme_bw()


# Separate out individual fish for graphing/analysis:

## Separate each fish to it's own RMR file: 
Fish1_RMR <- filter(RMR.2, FishID == Fish1)
Fish2_RMR <- filter(RMR.2, FishID == Fish2)
Fish3_RMR <- filter(RMR.2, FishID == Fish3)
Fish4_RMR <- filter(RMR.2, FishID == Fish4)

# Determine length of measurment period because they vary between trials (ugh). I chose measurement period 5 so it's not in the first few measurement periods where we were switching them manually but not the last measurement period either in case it was cut short. 
(nrow(Fish1_RMR[Fish1_RMR$Phase == "M5",]))/60

# Determine total time in chambers (in hours) because this also slightly varied between trials (ugh). 
(nrow(RMR_raw))/60/60

```

```{r, eval=FALSE}
## Plot individual measurement periods for each fish: 
p=ggplot(data=Fish1_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase), group=1)+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish1) 

p=ggplot(data=Fish2_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish2) 

p=ggplot(data=Fish3_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish3) 

p=ggplot(data=Fish4_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish4) 

##Plot individual measurement periods with the line of best fit: 

p=ggplot(data=Fish1_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish1) 

p=ggplot(data=Fish2_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish2) 

p=ggplot(data=Fish3_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish3) 

p=ggplot(data=Fish4_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish4) 
```


```{r}
# Calculate slopes of lines for each fish and convert slope from minutes to hours:
O2slopel1 <- dlply(Fish1_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope1 <- ldply(O2slopel1, function(d) coef(d))
names(O2slope1) <- c("Phase", "Intercept","Slope")
O2slope1<- mutate(O2slope1, FishID = Fish1)
O2slope1<-ddply(O2slope1, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel2 <- dlply(Fish2_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope2 <- ldply(O2slopel2, function(d) coef(d))
names(O2slope2) <- c("Phase", "Intercept","Slope")
O2slope2 <- mutate(O2slope2, FishID = Fish2)
O2slope2<-ddply(O2slope2, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel3 <- dlply(Fish3_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope3 <- ldply(O2slopel3, function(d) coef(d))
names(O2slope3) <- c("Phase", "Intercept","Slope")
O2slope3 <- mutate(O2slope3, FishID = Fish3)
O2slope3<-ddply(O2slope3, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel4 <- dlply(Fish4_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope4 <- ldply(O2slopel4, function(d) coef(d))
names(O2slope4) <- c("Phase", "Intercept","Slope")
O2slope4 <- mutate(O2slope4, FishID = Fish4)
O2slope4<-ddply(O2slope4, .(Phase), mutate, Slope.hour=Slope*60)


# Calculating the fit of each slope: 
O2.r2.1 <- dlply(Fish1_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit1<-ldply(O2.r2.1, function(d) d$r.squared)
slopefit1
names(slopefit1) <-c("Phase","r2")

O2.r2.2 <- dlply(Fish2_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit2<-ldply(O2.r2.2, function(d) d$r.squared)
slopefit2
names(slopefit2) <-c("Phase","r2")

O2.r2.3 <- dlply(Fish3_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit3<-ldply(O2.r2.3, function(d) d$r.squared)
slopefit3
names(slopefit3) <-c("Phase","r2")

O2.r2.4 <- dlply(Fish4_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit4<-ldply(O2.r2.4, function(d) d$r.squared)
slopefit4
names(slopefit4) <-c("Phase","r2")


# merge together slope and r2:
O2slope.r2.1<-merge(O2slope1, slopefit1, by=c("Phase"))
O2slope.r2.1<- O2slope.r2.1[mixedorder(O2slope.r2.1$Phase),]
O2slope.r2.1

O2slope.r2.2<-merge(O2slope2, slopefit2, by=c("Phase"))
O2slope.r2.2<- O2slope.r2.2[mixedorder(O2slope.r2.2$Phase),]
O2slope.r2.2

O2slope.r2.3<-merge(O2slope3, slopefit3, by=c("Phase"))
O2slope.r2.3<- O2slope.r2.3[mixedorder(O2slope.r2.3$Phase),]
O2slope.r2.3

O2slope.r2.4<-merge(O2slope4, slopefit4, by=c("Phase"))
O2slope.r2.4<- O2slope.r2.4[mixedorder(O2slope.r2.4$Phase),]
O2slope.r2.4

# bind all slope and r2 dataframes and sort the phases so they're in order:
slopes.r2.all <- rbind(O2slope.r2.1,O2slope.r2.2,O2slope.r2.3,O2slope.r2.4)
slopes.r2.all <- merge(slopes.r2.all, Phase.start, by=c("Phase"))
phase.sort <- unique(mixedsort(slopes.r2.all$Phase))
slopes.r2.all$Phase <- factor(slopes.r2.all$Phase, levels = phase.sort)

# Add mean temperature for that trial to the slopes.r2.all file. 
slopes.r2.all$meanTemp <- mean(RMR$Temp)

# Add in time from start of file

trial.first<- ddply(slopes.r2.all,"DateTime", head,1)
slopes.r2.all$Time.m <- difftime(slopes.r2.all$DateTime, head(trial.first$DateTime,1), units="mins", tz = "America/Los_Angeles")

# As you go through the text files from autoresp, you can consecutively add all of the slopes data, etc. to the slopes.all file, which is your big giant master file with all the data. After I calculate the slopes & r2 etc. for each file, then load the morphometrics data file and merge them together based on FishId. Bind days together first, then everything. 
slopes.all <- rbind(slopes.all, slopes.r2.all)


# Plot
ggplot(slopes.r2.all, aes(x=DateTime, y=(-1*Slope)))+
  geom_point(aes(color=FishID))+
  theme_bw()


# Sort based on slope value for every fish: 

Fish1_sorted_slopes <- O2slope.r2.1[order(-O2slope.r2.1$Slope.hour),]

Fish2_sorted_slopes <- O2slope.r2.2[order(-O2slope.r2.2$Slope.hour),]

Fish3_sorted_slopes <- O2slope.r2.3[order(-O2slope.r2.3$Slope.hour),]

Fish4_sorted_slopes <- O2slope.r2.4[order(-O2slope.r2.4$Slope.hour),]

# Remove the first two measurement periods. We don't want to include the first chunk of time immediately post-handling because thats a priori information that the fish was stressed. 

Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M1', Phase))
Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M2', Phase))
Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M1   ', Phase))
Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M2   ', Phase))

Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M1', Phase))
Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M2', Phase))
Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M1   ', Phase))
Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M2   ', Phase))

Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M1', Phase))
Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M2', Phase))
Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M1   ', Phase))
Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M2   ', Phase))

Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M1', Phase))
Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M2', Phase))
Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M1   ', Phase))
Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M2   ', Phase))

# Average lowest three

Fish1avgslopehour <- mean(head(Fish1_sorted_slopes$Slope.hour, 3))
Fish1avgslope <- mean(head(Fish1_sorted_slopes$Slope, 3))
Fish1avgR2 <- mean(head(Fish1_sorted_slopes$r2, 3))

Fish1finalRMR <- matrix(c(Fish1, Fish1avgslope, Fish1avgslopehour, Fish1avgR2), nrow=1, ncol=4)

Fish2avgslopehour <- mean(head(Fish2_sorted_slopes$Slope.hour, 3))
Fish2avgslope <- mean(head(Fish2_sorted_slopes$Slope, 3))
Fish2avgR2 <- mean(head(Fish2_sorted_slopes$r2, 3))

Fish2finalRMR <- matrix(c(Fish2, Fish2avgslope, Fish2avgslopehour, Fish2avgR2), nrow=1, ncol=4)

Fish3avgslopehour <- mean(head(Fish3_sorted_slopes$Slope.hour, 3))
Fish3avgslope <- mean(head(Fish3_sorted_slopes$Slope, 3))
Fish3avgR2 <- mean(head(Fish3_sorted_slopes$r2, 3))

Fish3finalRMR <- matrix(c(Fish3, Fish3avgslope, Fish3avgslopehour, Fish3avgR2), nrow=1, ncol=4)

Fish4avgslopehour <- mean(head(Fish4_sorted_slopes$Slope.hour, 3))
Fish4avgslope <- mean(head(Fish4_sorted_slopes$Slope, 3))
Fish4avgR2 <- mean(head(Fish4_sorted_slopes$r2, 3))

Fish4finalRMR <- matrix(c(Fish4, Fish4avgslope, Fish4avgslopehour, Fish4avgR2), nrow=1, ncol=4)

# Bind all fish from this trial together: 
average.slopes <- rbind(Fish1finalRMR, Fish2finalRMR, Fish3finalRMR, Fish4finalRMR)

#Add mean temp of this trial to final file: 
average.slopes <- cbind(average.slopes, mean(RMR$Temp))
colnames(average.slopes) <- c("FishID", "FinalSlope", "FinalSlopeHour", "FinalR2", "meanTemp")

slopes.all.final <- rbind(average.slopes, slopes.all.final)


```

#### D2_B1_C

```{r}
# Load txt file
RMR_raw <- readcleancannibal("2018_burbot_resp_D2_B1_C_raw.txt")

# Assign names for this trial: 

"Fish1" <- "D2_B1_C1"
"Fish2" <- "D2_B1_C2"
"Fish3" <- "D2_B1_C3"
"Fish4" <- "D2_B1_C4"

# Create a new column with the time in minutes from the start of the file: 

RMR_raw$Time.m <- sapply(seq_along(RMR_raw$DateTime),
function(i) as.numeric(difftime(RMR_raw$DateTime[i], RMR_raw$DateTime[1], units='mins')))


# Pull measure periods. Grep finds all of the data in the Phase column that contains the letter M. 

RMR <- RMR_raw[grep("M", RMR_raw$Phase), ]

# Pull out first value of each phase for graphing later
Phase.start <- ddply(RMR, "Phase", head, 1)
Phase.start <- Phase.start[,1:2]


# Change the column names of the chambers to the appropriate FishID:
Name.vec <- c(Fish1, Fish2, Fish3, Fish4)
names(RMR)[5:8] <- Name.vec


# Reshape the data so all O2 saturation values are in a single column:

RMR.2 <- melt(RMR, measure = Name.vec)

# Rename the columns. 
names(RMR.2) <-c("DateTime","Phase","Salinity","Temp","Time.m","FishID","O2.sat")

# Plot the measurement periods of all fish from this trial:
p=ggplot(data=RMR.2, aes(x=Time.m, y=O2.sat, group=Phase))
p+geom_point(aes(color=FishID))+theme_bw()


# Separate out individual fish for graphing/analysis:

## Separate each fish to it's own RMR file: 
Fish1_RMR <- filter(RMR.2, FishID == Fish1)
Fish2_RMR <- filter(RMR.2, FishID == Fish2)
Fish3_RMR <- filter(RMR.2, FishID == Fish3)
Fish4_RMR <- filter(RMR.2, FishID == Fish4)

# Determine length of measurment period because they vary between trials (ugh). I chose measurement period 5 so it's not in the first few measurement periods where we were switching them manually but not the last measurement period either in case it was cut short. 
(nrow(Fish1_RMR[Fish1_RMR$Phase == "M5",]))/60

# Determine total time in chambers (in hours) because this also slightly varied between trials (ugh). 
(nrow(RMR_raw))/60/60

```

```{r, eval=FALSE}
## Plot individual measurement periods for each fish: 
p=ggplot(data=Fish1_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase), group=1)+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish1) 

p=ggplot(data=Fish2_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish2) 

p=ggplot(data=Fish3_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish3) 

p=ggplot(data=Fish4_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish4) 

##Plot individual measurement periods with the line of best fit: 

p=ggplot(data=Fish1_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish1) 

p=ggplot(data=Fish2_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish2) 

p=ggplot(data=Fish3_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish3) 

p=ggplot(data=Fish4_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish4) 

```

```{r}
# Calculate slopes of lines for each fish and convert slope from minutes to hours:
O2slopel1 <- dlply(Fish1_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope1 <- ldply(O2slopel1, function(d) coef(d))
names(O2slope1) <- c("Phase", "Intercept","Slope")
O2slope1<- mutate(O2slope1, FishID = Fish1)
O2slope1<-ddply(O2slope1, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel2 <- dlply(Fish2_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope2 <- ldply(O2slopel2, function(d) coef(d))
names(O2slope2) <- c("Phase", "Intercept","Slope")
O2slope2 <- mutate(O2slope2, FishID = Fish2)
O2slope2<-ddply(O2slope2, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel3 <- dlply(Fish3_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope3 <- ldply(O2slopel3, function(d) coef(d))
names(O2slope3) <- c("Phase", "Intercept","Slope")
O2slope3 <- mutate(O2slope3, FishID = Fish3)
O2slope3<-ddply(O2slope3, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel4 <- dlply(Fish4_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope4 <- ldply(O2slopel4, function(d) coef(d))
names(O2slope4) <- c("Phase", "Intercept","Slope")
O2slope4 <- mutate(O2slope4, FishID = Fish4)
O2slope4<-ddply(O2slope4, .(Phase), mutate, Slope.hour=Slope*60)


# Calculating the fit of each slope: 
O2.r2.1 <- dlply(Fish1_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit1<-ldply(O2.r2.1, function(d) d$r.squared)
slopefit1
names(slopefit1) <-c("Phase","r2")

O2.r2.2 <- dlply(Fish2_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit2<-ldply(O2.r2.2, function(d) d$r.squared)
slopefit2
names(slopefit2) <-c("Phase","r2")

O2.r2.3 <- dlply(Fish3_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit3<-ldply(O2.r2.3, function(d) d$r.squared)
slopefit3
names(slopefit3) <-c("Phase","r2")

O2.r2.4 <- dlply(Fish4_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit4<-ldply(O2.r2.4, function(d) d$r.squared)
slopefit4
names(slopefit4) <-c("Phase","r2")


# merge together slope and r2:
O2slope.r2.1<-merge(O2slope1, slopefit1, by=c("Phase"))
O2slope.r2.1<- O2slope.r2.1[mixedorder(O2slope.r2.1$Phase),]
O2slope.r2.1

O2slope.r2.2<-merge(O2slope2, slopefit2, by=c("Phase"))
O2slope.r2.2<- O2slope.r2.2[mixedorder(O2slope.r2.2$Phase),]
O2slope.r2.2

O2slope.r2.3<-merge(O2slope3, slopefit3, by=c("Phase"))
O2slope.r2.3<- O2slope.r2.3[mixedorder(O2slope.r2.3$Phase),]
O2slope.r2.3

O2slope.r2.4<-merge(O2slope4, slopefit4, by=c("Phase"))
O2slope.r2.4<- O2slope.r2.4[mixedorder(O2slope.r2.4$Phase),]
O2slope.r2.4

# bind all slope and r2 dataframes and sort the phases so they're in order:
slopes.r2.all <- rbind(O2slope.r2.1,O2slope.r2.2,O2slope.r2.3,O2slope.r2.4)
slopes.r2.all <- merge(slopes.r2.all, Phase.start, by=c("Phase"))
phase.sort <- unique(mixedsort(slopes.r2.all$Phase))
slopes.r2.all$Phase <- factor(slopes.r2.all$Phase, levels = phase.sort)

# Add mean temperature for that trial to the slopes.r2.all file. 
slopes.r2.all$meanTemp <- mean(RMR$Temp)

# Add in time from start of file

trial.first<- ddply(slopes.r2.all,"DateTime", head,1)
slopes.r2.all$Time.m <- difftime(slopes.r2.all$DateTime, head(trial.first$DateTime,1), units="mins", tz = "America/Los_Angeles")

# As you go through the text files from autoresp, you can consecutively add all of the slopes data, etc. to the slopes.all file, which is your big giant master file with all the data. After I calculate the slopes & r2 etc. for each file, then load the morphometrics data file and merge them together based on FishId. Bind days together first, then everything. 
slopes.all <- rbind(slopes.all, slopes.r2.all)


# Plot
ggplot(slopes.r2.all, aes(x=DateTime, y=(-1*Slope)))+
  geom_point(aes(color=FishID))+
  theme_bw()


# Sort based on slope value for every fish: 

Fish1_sorted_slopes <- O2slope.r2.1[order(-O2slope.r2.1$Slope.hour),]

Fish2_sorted_slopes <- O2slope.r2.2[order(-O2slope.r2.2$Slope.hour),]

Fish3_sorted_slopes <- O2slope.r2.3[order(-O2slope.r2.3$Slope.hour),]

Fish4_sorted_slopes <- O2slope.r2.4[order(-O2slope.r2.4$Slope.hour),]

# Remove the first two measurement periods. We don't want to include the first chunk of time immediately post-handling because thats a priori information that the fish was stressed. 

Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M1', Phase))
Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M2', Phase))
Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M1   ', Phase))
Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M2   ', Phase))

Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M1', Phase))
Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M2', Phase))
Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M1   ', Phase))
Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M2   ', Phase))

Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M1', Phase))
Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M2', Phase))
Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M1   ', Phase))
Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M2   ', Phase))

Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M1', Phase))
Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M2', Phase))
Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M1   ', Phase))
Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M2   ', Phase))

# Average lowest three

Fish1avgslopehour <- mean(head(Fish1_sorted_slopes$Slope.hour, 3))
Fish1avgslope <- mean(head(Fish1_sorted_slopes$Slope, 3))
Fish1avgR2 <- mean(head(Fish1_sorted_slopes$r2, 3))

Fish1finalRMR <- matrix(c(Fish1, Fish1avgslope, Fish1avgslopehour, Fish1avgR2), nrow=1, ncol=4)

Fish2avgslopehour <- mean(head(Fish2_sorted_slopes$Slope.hour, 3))
Fish2avgslope <- mean(head(Fish2_sorted_slopes$Slope, 3))
Fish2avgR2 <- mean(head(Fish2_sorted_slopes$r2, 3))

Fish2finalRMR <- matrix(c(Fish2, Fish2avgslope, Fish2avgslopehour, Fish2avgR2), nrow=1, ncol=4)

Fish3avgslopehour <- mean(head(Fish3_sorted_slopes$Slope.hour, 3))
Fish3avgslope <- mean(head(Fish3_sorted_slopes$Slope, 3))
Fish3avgR2 <- mean(head(Fish3_sorted_slopes$r2, 3))

Fish3finalRMR <- matrix(c(Fish3, Fish3avgslope, Fish3avgslopehour, Fish3avgR2), nrow=1, ncol=4)

Fish4avgslopehour <- mean(head(Fish4_sorted_slopes$Slope.hour, 3))
Fish4avgslope <- mean(head(Fish4_sorted_slopes$Slope, 3))
Fish4avgR2 <- mean(head(Fish4_sorted_slopes$r2, 3))

Fish4finalRMR <- matrix(c(Fish4, Fish4avgslope, Fish4avgslopehour, Fish4avgR2), nrow=1, ncol=4)

# Bind all fish from this trial together: 
average.slopes <- rbind(Fish1finalRMR, Fish2finalRMR, Fish3finalRMR, Fish4finalRMR)

#Add mean temp of this trial to final file: 
average.slopes <- cbind(average.slopes, mean(RMR$Temp))
colnames(average.slopes) <- c("FishID", "FinalSlope", "FinalSlopeHour", "FinalR2", "meanTemp")

slopes.all.final <- rbind(average.slopes, slopes.all.final)

```

#### D2_B2_C

```{r}
# Load txt file
RMR_raw <- readcleancannibal("2018_burbot_resp_D2_B2_C_raw.txt")

# Assign names for this trial: 

"Fish1" <- "D2_B2_C1"
"Fish2" <- "D2_B2_C2"
"Fish3" <- "D2_B2_C3"
"Fish4" <- "D2_B2_C4"

# Create a new column with the time in minutes from the start of the file: 

RMR_raw$Time.m <- sapply(seq_along(RMR_raw$DateTime),
function(i) as.numeric(difftime(RMR_raw$DateTime[i], RMR_raw$DateTime[1], units='mins')))


# Pull measure periods. Grep finds all of the data in the Phase column that contains the letter M. 

RMR <- RMR_raw[grep("M", RMR_raw$Phase), ]

# Pull out first value of each phase for graphing later
Phase.start <- ddply(RMR, "Phase", head, 1)
Phase.start <- Phase.start[,1:2]


# Change the column names of the chambers to the appropriate FishID:
Name.vec <- c(Fish1, Fish2, Fish3, Fish4)
names(RMR)[5:8] <- Name.vec


# Reshape the data so all O2 saturation values are in a single column:

RMR.2 <- melt(RMR, measure = Name.vec)

# Rename the columns. 
names(RMR.2) <-c("DateTime","Phase","Salinity","Temp","Time.m","FishID","O2.sat")

# Plot the measurement periods of all fish from this trial:
p=ggplot(data=RMR.2, aes(x=Time.m, y=O2.sat, group=Phase))
p+geom_point(aes(color=FishID))+theme_bw()


# Separate out individual fish for graphing/analysis:

## Separate each fish to it's own RMR file: 
Fish1_RMR <- filter(RMR.2, FishID == Fish1)
Fish2_RMR <- filter(RMR.2, FishID == Fish2)
Fish3_RMR <- filter(RMR.2, FishID == Fish3)
Fish4_RMR <- filter(RMR.2, FishID == Fish4)

# Determine length of measurment period because they vary between trials (ugh). I chose measurement period 5 so it's not in the first few measurement periods where we were switching them manually but not the last measurement period either in case it was cut short. 
(nrow(Fish1_RMR[Fish1_RMR$Phase == "M5",]))/60

# Determine total time in chambers (in hours) because this also slightly varied between trials (ugh). 
(nrow(RMR_raw))/60/60

```

```{r, eval=FALSE}
## Plot individual measurement periods for each fish: 
p=ggplot(data=Fish1_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase), group=1)+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish1) 

p=ggplot(data=Fish2_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish2) 

p=ggplot(data=Fish3_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish3) 

p=ggplot(data=Fish4_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish4) 

##Plot individual measurement periods with the line of best fit: 

p=ggplot(data=Fish1_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish1) 

p=ggplot(data=Fish2_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish2) 

p=ggplot(data=Fish3_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish3) 

p=ggplot(data=Fish4_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish4) 
```

```{r}
# Calculate slopes of lines for each fish and convert slope from minutes to hours:
O2slopel1 <- dlply(Fish1_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope1 <- ldply(O2slopel1, function(d) coef(d))
names(O2slope1) <- c("Phase", "Intercept","Slope")
O2slope1<- mutate(O2slope1, FishID = Fish1)
O2slope1<-ddply(O2slope1, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel2 <- dlply(Fish2_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope2 <- ldply(O2slopel2, function(d) coef(d))
names(O2slope2) <- c("Phase", "Intercept","Slope")
O2slope2 <- mutate(O2slope2, FishID = Fish2)
O2slope2<-ddply(O2slope2, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel3 <- dlply(Fish3_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope3 <- ldply(O2slopel3, function(d) coef(d))
names(O2slope3) <- c("Phase", "Intercept","Slope")
O2slope3 <- mutate(O2slope3, FishID = Fish3)
O2slope3<-ddply(O2slope3, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel4 <- dlply(Fish4_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope4 <- ldply(O2slopel4, function(d) coef(d))
names(O2slope4) <- c("Phase", "Intercept","Slope")
O2slope4 <- mutate(O2slope4, FishID = Fish4)
O2slope4<-ddply(O2slope4, .(Phase), mutate, Slope.hour=Slope*60)


# Calculating the fit of each slope: 
O2.r2.1 <- dlply(Fish1_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit1<-ldply(O2.r2.1, function(d) d$r.squared)
slopefit1
names(slopefit1) <-c("Phase","r2")

O2.r2.2 <- dlply(Fish2_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit2<-ldply(O2.r2.2, function(d) d$r.squared)
slopefit2
names(slopefit2) <-c("Phase","r2")

O2.r2.3 <- dlply(Fish3_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit3<-ldply(O2.r2.3, function(d) d$r.squared)
slopefit3
names(slopefit3) <-c("Phase","r2")

O2.r2.4 <- dlply(Fish4_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit4<-ldply(O2.r2.4, function(d) d$r.squared)
slopefit4
names(slopefit4) <-c("Phase","r2")


# merge together slope and r2:
O2slope.r2.1<-merge(O2slope1, slopefit1, by=c("Phase"))
O2slope.r2.1<- O2slope.r2.1[mixedorder(O2slope.r2.1$Phase),]
O2slope.r2.1

O2slope.r2.2<-merge(O2slope2, slopefit2, by=c("Phase"))
O2slope.r2.2<- O2slope.r2.2[mixedorder(O2slope.r2.2$Phase),]
O2slope.r2.2

O2slope.r2.3<-merge(O2slope3, slopefit3, by=c("Phase"))
O2slope.r2.3<- O2slope.r2.3[mixedorder(O2slope.r2.3$Phase),]
O2slope.r2.3

O2slope.r2.4<-merge(O2slope4, slopefit4, by=c("Phase"))
O2slope.r2.4<- O2slope.r2.4[mixedorder(O2slope.r2.4$Phase),]
O2slope.r2.4

# bind all slope and r2 dataframes and sort the phases so they're in order:
slopes.r2.all <- rbind(O2slope.r2.1,O2slope.r2.2,O2slope.r2.3,O2slope.r2.4)
slopes.r2.all <- merge(slopes.r2.all, Phase.start, by=c("Phase"))
phase.sort <- unique(mixedsort(slopes.r2.all$Phase))
slopes.r2.all$Phase <- factor(slopes.r2.all$Phase, levels = phase.sort)

# Add mean temperature for that trial to the slopes.r2.all file. 
slopes.r2.all$meanTemp <- mean(RMR$Temp)

# Add in time from start of file

trial.first<- ddply(slopes.r2.all,"DateTime", head,1)
slopes.r2.all$Time.m <- difftime(slopes.r2.all$DateTime, head(trial.first$DateTime,1), units="mins", tz = "America/Los_Angeles")

# As you go through the text files from autoresp, you can consecutively add all of the slopes data, etc. to the slopes.all file, which is your big giant master file with all the data. After I calculate the slopes & r2 etc. for each file, then load the morphometrics data file and merge them together based on FishId. Bind days together first, then everything. 
slopes.all <- rbind(slopes.all, slopes.r2.all)

# Plot
ggplot(slopes.r2.all, aes(x=DateTime, y=(-1*Slope)))+
  geom_point(aes(color=FishID))+
  theme_bw()


# Sort based on slope value for every fish: 

Fish1_sorted_slopes <- O2slope.r2.1[order(-O2slope.r2.1$Slope.hour),]

Fish2_sorted_slopes <- O2slope.r2.2[order(-O2slope.r2.2$Slope.hour),]

Fish3_sorted_slopes <- O2slope.r2.3[order(-O2slope.r2.3$Slope.hour),]

Fish4_sorted_slopes <- O2slope.r2.4[order(-O2slope.r2.4$Slope.hour),]

# Remove the first two measurement periods. We don't want to include the first chunk of time immediately post-handling because thats a priori information that the fish was stressed. 

Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M1', Phase))
Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M2', Phase))
Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M1   ', Phase))
Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M2   ', Phase))

Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M1', Phase))
Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M2', Phase))
Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M1   ', Phase))
Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M2   ', Phase))

Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M1', Phase))
Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M2', Phase))
Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M1   ', Phase))
Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M2   ', Phase))

Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M1', Phase))
Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M2', Phase))
Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M1   ', Phase))
Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M2   ', Phase))

# Average lowest three

Fish1avgslopehour <- mean(head(Fish1_sorted_slopes$Slope.hour, 3))
Fish1avgslope <- mean(head(Fish1_sorted_slopes$Slope, 3))
Fish1avgR2 <- mean(head(Fish1_sorted_slopes$r2, 3))

Fish1finalRMR <- matrix(c(Fish1, Fish1avgslope, Fish1avgslopehour, Fish1avgR2), nrow=1, ncol=4)

Fish2avgslopehour <- mean(head(Fish2_sorted_slopes$Slope.hour, 3))
Fish2avgslope <- mean(head(Fish2_sorted_slopes$Slope, 3))
Fish2avgR2 <- mean(head(Fish2_sorted_slopes$r2, 3))

Fish2finalRMR <- matrix(c(Fish2, Fish2avgslope, Fish2avgslopehour, Fish2avgR2), nrow=1, ncol=4)

Fish3avgslopehour <- mean(head(Fish3_sorted_slopes$Slope.hour, 3))
Fish3avgslope <- mean(head(Fish3_sorted_slopes$Slope, 3))
Fish3avgR2 <- mean(head(Fish3_sorted_slopes$r2, 3))

Fish3finalRMR <- matrix(c(Fish3, Fish3avgslope, Fish3avgslopehour, Fish3avgR2), nrow=1, ncol=4)

Fish4avgslopehour <- mean(head(Fish4_sorted_slopes$Slope.hour, 3))
Fish4avgslope <- mean(head(Fish4_sorted_slopes$Slope, 3))
Fish4avgR2 <- mean(head(Fish4_sorted_slopes$r2, 3))

Fish4finalRMR <- matrix(c(Fish4, Fish4avgslope, Fish4avgslopehour, Fish4avgR2), nrow=1, ncol=4)

# Bind all fish from this trial together: 
average.slopes <- rbind(Fish1finalRMR, Fish2finalRMR, Fish3finalRMR, Fish4finalRMR)

#Add mean temp of this trial to final file: 
average.slopes <- cbind(average.slopes, mean(RMR$Temp))
colnames(average.slopes) <- c("FishID", "FinalSlope", "FinalSlopeHour", "FinalR2", "meanTemp")

slopes.all.final <- rbind(average.slopes, slopes.all.final)

```

#### D2_B3_C

```{r}
# Load txt file
RMR_raw <- readcleancannibal("2018_burbot_resp_D2_B3_C_raw.txt")

# Assign names for this trial: 

"Fish1" <- "D2_B3_C1"
"Fish2" <- "D2_B3_C2"
"Fish3" <- "D2_B3_C3"
"Fish4" <- "D2_B3_C4"

# Create a new column with the time in minutes from the start of the file: 

RMR_raw$Time.m <- sapply(seq_along(RMR_raw$DateTime),
function(i) as.numeric(difftime(RMR_raw$DateTime[i], RMR_raw$DateTime[1], units='mins')))


# Pull measure periods. Grep finds all of the data in the Phase column that contains the letter M. 

RMR <- RMR_raw[grep("M", RMR_raw$Phase), ]

# Pull out first value of each phase for graphing later
Phase.start <- ddply(RMR, "Phase", head, 1)
Phase.start <- Phase.start[,1:2]

# Change the column names of the chambers to the appropriate FishID:
Name.vec <- c(Fish1, Fish2, Fish3, Fish4)
names(RMR)[5:8] <- Name.vec


# Reshape the data so all O2 saturation values are in a single column:

RMR.2 <- melt(RMR, measure = Name.vec)

# Rename the columns. 
names(RMR.2) <-c("DateTime","Phase","Salinity","Temp","Time.m","FishID","O2.sat")

# Plot the measurement periods of all fish from this trial:
p=ggplot(data=RMR.2, aes(x=Time.m, y=O2.sat, group=Phase))
p+geom_point(aes(color=FishID))+theme_bw()


# Separate out individual fish for graphing/analysis:

## Separate each fish to it's own RMR file: 
Fish1_RMR <- filter(RMR.2, FishID == Fish1)
Fish2_RMR <- filter(RMR.2, FishID == Fish2)
Fish3_RMR <- filter(RMR.2, FishID == Fish3)
Fish4_RMR <- filter(RMR.2, FishID == Fish4)

# Determine length of measurment period because they vary between trials (ugh). I chose measurement period 5 so it's not in the first few measurement periods where we were switching them manually but not the last measurement period either in case it was cut short. 
(nrow(Fish1_RMR[Fish1_RMR$Phase == "M5   ",]))/60

# Determine total time in chambers (in hours) because this also slightly varied between trials (ugh). 
(nrow(RMR_raw))/60/60
```

```{r eval=FALSE}
## Plot individual measurement periods for each fish: 
p=ggplot(data=Fish1_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase), group=1)+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish1) 

p=ggplot(data=Fish2_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish2) 

p=ggplot(data=Fish3_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish3) 

p=ggplot(data=Fish4_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish4) 

##Plot individual measurement periods with the line of best fit: 

p=ggplot(data=Fish1_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish1) 

p=ggplot(data=Fish2_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish2) 

p=ggplot(data=Fish3_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish3) 

p=ggplot(data=Fish4_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish4) 
```

```{r}
# Calculate slopes of lines for each fish and convert slope from minutes to hours:
O2slopel1 <- dlply(Fish1_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope1 <- ldply(O2slopel1, function(d) coef(d))
names(O2slope1) <- c("Phase", "Intercept","Slope")
O2slope1<- mutate(O2slope1, FishID = Fish1)
O2slope1<-ddply(O2slope1, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel2 <- dlply(Fish2_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope2 <- ldply(O2slopel2, function(d) coef(d))
names(O2slope2) <- c("Phase", "Intercept","Slope")
O2slope2 <- mutate(O2slope2, FishID = Fish2)
O2slope2<-ddply(O2slope2, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel3 <- dlply(Fish3_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope3 <- ldply(O2slopel3, function(d) coef(d))
names(O2slope3) <- c("Phase", "Intercept","Slope")
O2slope3 <- mutate(O2slope3, FishID = Fish3)
O2slope3<-ddply(O2slope3, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel4 <- dlply(Fish4_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope4 <- ldply(O2slopel4, function(d) coef(d))
names(O2slope4) <- c("Phase", "Intercept","Slope")
O2slope4 <- mutate(O2slope4, FishID = Fish4)
O2slope4<-ddply(O2slope4, .(Phase), mutate, Slope.hour=Slope*60)


# Calculating the fit of each slope: 
O2.r2.1 <- dlply(Fish1_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit1<-ldply(O2.r2.1, function(d) d$r.squared)
slopefit1
names(slopefit1) <-c("Phase","r2")

O2.r2.2 <- dlply(Fish2_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit2<-ldply(O2.r2.2, function(d) d$r.squared)
slopefit2
names(slopefit2) <-c("Phase","r2")

O2.r2.3 <- dlply(Fish3_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit3<-ldply(O2.r2.3, function(d) d$r.squared)
slopefit3
names(slopefit3) <-c("Phase","r2")

O2.r2.4 <- dlply(Fish4_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit4<-ldply(O2.r2.4, function(d) d$r.squared)
slopefit4
names(slopefit4) <-c("Phase","r2")


# merge together slope and r2:
O2slope.r2.1<-merge(O2slope1, slopefit1, by=c("Phase"))
O2slope.r2.1<- O2slope.r2.1[mixedorder(O2slope.r2.1$Phase),]
O2slope.r2.1

O2slope.r2.2<-merge(O2slope2, slopefit2, by=c("Phase"))
O2slope.r2.2<- O2slope.r2.2[mixedorder(O2slope.r2.2$Phase),]
O2slope.r2.2

O2slope.r2.3<-merge(O2slope3, slopefit3, by=c("Phase"))
O2slope.r2.3<- O2slope.r2.3[mixedorder(O2slope.r2.3$Phase),]
O2slope.r2.3

O2slope.r2.4<-merge(O2slope4, slopefit4, by=c("Phase"))
O2slope.r2.4<- O2slope.r2.4[mixedorder(O2slope.r2.4$Phase),]
O2slope.r2.4

# bind all slope and r2 dataframes and sort the phases so they're in order:
slopes.r2.all <- rbind(O2slope.r2.1,O2slope.r2.2,O2slope.r2.3,O2slope.r2.4)
slopes.r2.all <- merge(slopes.r2.all, Phase.start, by=c("Phase"))
phase.sort <- unique(mixedsort(slopes.r2.all$Phase))
slopes.r2.all$Phase <- factor(slopes.r2.all$Phase, levels = phase.sort)

# Add mean temperature for that trial to the slopes.r2.all file. 
slopes.r2.all$meanTemp <- mean(RMR$Temp)

# Add in time from start of file

trial.first<- ddply(slopes.r2.all,"DateTime", head,1)
slopes.r2.all$Time.m <- difftime(slopes.r2.all$DateTime, head(trial.first$DateTime,1), units="mins", tz = "America/Los_Angeles")

# As you go through the text files from autoresp, you can consecutively add all of the slopes data, etc. to the slopes.all file, which is your big giant master file with all the data. After I calculate the slopes & r2 etc. for each file, then load the morphometrics data file and merge them together based on FishId. Bind days together first, then everything. 
slopes.all <- rbind(slopes.all, slopes.r2.all)


# Plot
ggplot(slopes.r2.all, aes(x=DateTime, y=(-1*Slope)))+
  geom_point(aes(color=FishID))+
  theme_bw()

# Sort based on slope value for every fish: 

Fish1_sorted_slopes <- O2slope.r2.1[order(-O2slope.r2.1$Slope.hour),]

Fish2_sorted_slopes <- O2slope.r2.2[order(-O2slope.r2.2$Slope.hour),]

Fish3_sorted_slopes <- O2slope.r2.3[order(-O2slope.r2.3$Slope.hour),]

Fish4_sorted_slopes <- O2slope.r2.4[order(-O2slope.r2.4$Slope.hour),]

# Remove the first two measurement periods. We don't want to include the first chunk of time immediately post-handling because thats a priori information that the fish was stressed. 

Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M1', Phase))
Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M2', Phase))
Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M1   ', Phase))
Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M2   ', Phase))

Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M1', Phase))
Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M2', Phase))
Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M1   ', Phase))
Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M2   ', Phase))

Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M1', Phase))
Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M2', Phase))
Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M1   ', Phase))
Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M2   ', Phase))

Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M1', Phase))
Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M2', Phase))
Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M1   ', Phase))
Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M2   ', Phase))

# Average lowest three

Fish1avgslopehour <- mean(head(Fish1_sorted_slopes$Slope.hour, 3))
Fish1avgslope <- mean(head(Fish1_sorted_slopes$Slope, 3))
Fish1avgR2 <- mean(head(Fish1_sorted_slopes$r2, 3))

Fish1finalRMR <- matrix(c(Fish1, Fish1avgslope, Fish1avgslopehour, Fish1avgR2), nrow=1, ncol=4)

Fish2avgslopehour <- mean(head(Fish2_sorted_slopes$Slope.hour, 3))
Fish2avgslope <- mean(head(Fish2_sorted_slopes$Slope, 3))
Fish2avgR2 <- mean(head(Fish2_sorted_slopes$r2, 3))

Fish2finalRMR <- matrix(c(Fish2, Fish2avgslope, Fish2avgslopehour, Fish2avgR2), nrow=1, ncol=4)

Fish3avgslopehour <- mean(head(Fish3_sorted_slopes$Slope.hour, 3))
Fish3avgslope <- mean(head(Fish3_sorted_slopes$Slope, 3))
Fish3avgR2 <- mean(head(Fish3_sorted_slopes$r2, 3))

Fish3finalRMR <- matrix(c(Fish3, Fish3avgslope, Fish3avgslopehour, Fish3avgR2), nrow=1, ncol=4)

Fish4avgslopehour <- mean(head(Fish4_sorted_slopes$Slope.hour, 3))
Fish4avgslope <- mean(head(Fish4_sorted_slopes$Slope, 3))
Fish4avgR2 <- mean(head(Fish4_sorted_slopes$r2, 3))

Fish4finalRMR <- matrix(c(Fish4, Fish4avgslope, Fish4avgslopehour, Fish4avgR2), nrow=1, ncol=4)

# Bind all fish from this trial together: 
average.slopes <- rbind(Fish1finalRMR, Fish2finalRMR, Fish3finalRMR, Fish4finalRMR)

#Add mean temp of this trial to final file: 
average.slopes <- cbind(average.slopes, mean(RMR$Temp))
colnames(average.slopes) <- c("FishID", "FinalSlope", "FinalSlopeHour", "FinalR2", "meanTemp")

slopes.all.final <- rbind(average.slopes, slopes.all.final)

```

#### D3_B1_C

```{r}
# Load txt file
RMR_raw <- readcleancannibal("2018_burbot_resp_D3_B1_C_raw.txt")

# Assign names for this trial: 

"Fish1" <- "D3_B1_C1"
"Fish2" <- "D3_B1_C2"
"Fish3" <- "D3_B1_C3"
"Fish4" <- "D3_B1_C4"

# Create a new column with the time in minutes from the start of the file: 

RMR_raw$Time.m <- sapply(seq_along(RMR_raw$DateTime),
function(i) as.numeric(difftime(RMR_raw$DateTime[i], RMR_raw$DateTime[1], units='mins')))


# Pull measure periods. Grep finds all of the data in the Phase column that contains the letter M. 

RMR <- RMR_raw[grep("M", RMR_raw$Phase), ]


# Pull out first value of each phase for graphing later
Phase.start <- ddply(RMR, "Phase", head, 1)
Phase.start <- Phase.start[,1:2]


# Change the column names of the chambers to the appropriate FishID:
Name.vec <- c(Fish1, Fish2, Fish3, Fish4)
names(RMR)[5:8] <- Name.vec


# Reshape the data so all O2 saturation values are in a single column:

RMR.2 <- melt(RMR, measure = Name.vec)

# Rename the columns. 
names(RMR.2) <-c("DateTime","Phase","Salinity","Temp","Time.m","FishID","O2.sat")

# Plot the measurement periods of all fish from this trial:
p=ggplot(data=RMR.2, aes(x=Time.m, y=O2.sat, group=Phase))
p+geom_point(aes(color=FishID))+theme_bw()


# Separate out individual fish for graphing/analysis:

## Separate each fish to it's own RMR file: 
Fish1_RMR <- filter(RMR.2, FishID == Fish1)
Fish2_RMR <- filter(RMR.2, FishID == Fish2)
Fish3_RMR <- filter(RMR.2, FishID == Fish3)
Fish4_RMR <- filter(RMR.2, FishID == Fish4)

# Determine length of measurment period because they vary between trials (ugh). I chose measurement period 5 so it's not in the first few measurement periods where we were switching them manually but not the last measurement period either in case it was cut short. 
(nrow(Fish1_RMR[Fish1_RMR$Phase == "M5",]))/60

# Determine total time in chambers (in hours) because this also slightly varied between trials (ugh). 
(nrow(RMR_raw))/60/60
```

```{r eval=FALSE}
## Plot individual measurement periods for each fish: 
p=ggplot(data=Fish1_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase), group=1)+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish1) 

p=ggplot(data=Fish2_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish2) 

p=ggplot(data=Fish3_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish3) 

p=ggplot(data=Fish4_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish4) 

##Plot individual measurement periods with the line of best fit: 

p=ggplot(data=Fish1_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish1) 

p=ggplot(data=Fish2_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish2) 

p=ggplot(data=Fish3_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish3) 

p=ggplot(data=Fish4_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish4) 
```

```{r}
# Calculate slopes of lines for each fish and convert slope from minutes to hours:
O2slopel1 <- dlply(Fish1_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope1 <- ldply(O2slopel1, function(d) coef(d))
names(O2slope1) <- c("Phase", "Intercept","Slope")
O2slope1<- mutate(O2slope1, FishID = Fish1)
O2slope1<-ddply(O2slope1, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel2 <- dlply(Fish2_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope2 <- ldply(O2slopel2, function(d) coef(d))
names(O2slope2) <- c("Phase", "Intercept","Slope")
O2slope2 <- mutate(O2slope2, FishID = Fish2)
O2slope2<-ddply(O2slope2, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel3 <- dlply(Fish3_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope3 <- ldply(O2slopel3, function(d) coef(d))
names(O2slope3) <- c("Phase", "Intercept","Slope")
O2slope3 <- mutate(O2slope3, FishID = Fish3)
O2slope3<-ddply(O2slope3, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel4 <- dlply(Fish4_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope4 <- ldply(O2slopel4, function(d) coef(d))
names(O2slope4) <- c("Phase", "Intercept","Slope")
O2slope4 <- mutate(O2slope4, FishID = Fish4)
O2slope4<-ddply(O2slope4, .(Phase), mutate, Slope.hour=Slope*60)


# Calculating the fit of each slope: 
O2.r2.1 <- dlply(Fish1_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit1<-ldply(O2.r2.1, function(d) d$r.squared)
slopefit1
names(slopefit1) <-c("Phase","r2")

O2.r2.2 <- dlply(Fish2_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit2<-ldply(O2.r2.2, function(d) d$r.squared)
slopefit2
names(slopefit2) <-c("Phase","r2")

O2.r2.3 <- dlply(Fish3_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit3<-ldply(O2.r2.3, function(d) d$r.squared)
slopefit3
names(slopefit3) <-c("Phase","r2")

O2.r2.4 <- dlply(Fish4_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit4<-ldply(O2.r2.4, function(d) d$r.squared)
slopefit4
names(slopefit4) <-c("Phase","r2")


# merge together slope and r2:
O2slope.r2.1<-merge(O2slope1, slopefit1, by=c("Phase"))
O2slope.r2.1<- O2slope.r2.1[mixedorder(O2slope.r2.1$Phase),]
O2slope.r2.1

O2slope.r2.2<-merge(O2slope2, slopefit2, by=c("Phase"))
O2slope.r2.2<- O2slope.r2.2[mixedorder(O2slope.r2.2$Phase),]
O2slope.r2.2

O2slope.r2.3<-merge(O2slope3, slopefit3, by=c("Phase"))
O2slope.r2.3<- O2slope.r2.3[mixedorder(O2slope.r2.3$Phase),]
O2slope.r2.3

O2slope.r2.4<-merge(O2slope4, slopefit4, by=c("Phase"))
O2slope.r2.4<- O2slope.r2.4[mixedorder(O2slope.r2.4$Phase),]
O2slope.r2.4

# bind all slope and r2 dataframes and sort the phases so they're in order:
slopes.r2.all <- rbind(O2slope.r2.1,O2slope.r2.2,O2slope.r2.3,O2slope.r2.4)
slopes.r2.all <- merge(slopes.r2.all, Phase.start, by=c("Phase"))
phase.sort <- unique(mixedsort(slopes.r2.all$Phase))
slopes.r2.all$Phase <- factor(slopes.r2.all$Phase, levels = phase.sort)

# Add mean temperature for that trial to the slopes.r2.all file. 
slopes.r2.all$meanTemp <- mean(RMR$Temp)

# Add in time from start of file

trial.first<- ddply(slopes.r2.all,"DateTime", head,1)
slopes.r2.all$Time.m <- difftime(slopes.r2.all$DateTime, head(trial.first$DateTime,1), units="mins", tz = "America/Los_Angeles")

# As you go through the text files from autoresp, you can consecutively add all of the slopes data, etc. to the slopes.all file, which is your big giant master file with all the data. After I calculate the slopes & r2 etc. for each file, then load the morphometrics data file and merge them together based on FishId. Bind days together first, then everything. 
slopes.all <- rbind(slopes.all, slopes.r2.all)


# Plot
ggplot(slopes.r2.all, aes(x=DateTime, y=(-1*Slope)))+
  geom_point(aes(color=FishID))+
  theme_bw()


# Sort based on slope value for every fish: 

Fish1_sorted_slopes <- O2slope.r2.1[order(-O2slope.r2.1$Slope.hour),]

Fish2_sorted_slopes <- O2slope.r2.2[order(-O2slope.r2.2$Slope.hour),]

Fish3_sorted_slopes <- O2slope.r2.3[order(-O2slope.r2.3$Slope.hour),]

Fish4_sorted_slopes <- O2slope.r2.4[order(-O2slope.r2.4$Slope.hour),]

# Remove the first two measurement periods. We don't want to include the first chunk of time immediately post-handling because thats a priori information that the fish was stressed. 

Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M1', Phase))
Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M2', Phase))
Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M1   ', Phase))
Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M2   ', Phase))

Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M1', Phase))
Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M2', Phase))
Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M1   ', Phase))
Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M2   ', Phase))

Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M1', Phase))
Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M2', Phase))
Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M1   ', Phase))
Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M2   ', Phase))

Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M1', Phase))
Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M2', Phase))
Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M1   ', Phase))
Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M2   ', Phase))

# Average lowest three

Fish1avgslopehour <- mean(head(Fish1_sorted_slopes$Slope.hour, 3))
Fish1avgslope <- mean(head(Fish1_sorted_slopes$Slope, 3))
Fish1avgR2 <- mean(head(Fish1_sorted_slopes$r2, 3))

Fish1finalRMR <- matrix(c(Fish1, Fish1avgslope, Fish1avgslopehour, Fish1avgR2), nrow=1, ncol=4)

Fish2avgslopehour <- mean(head(Fish2_sorted_slopes$Slope.hour, 3))
Fish2avgslope <- mean(head(Fish2_sorted_slopes$Slope, 3))
Fish2avgR2 <- mean(head(Fish2_sorted_slopes$r2, 3))

Fish2finalRMR <- matrix(c(Fish2, Fish2avgslope, Fish2avgslopehour, Fish2avgR2), nrow=1, ncol=4)

Fish3avgslopehour <- mean(head(Fish3_sorted_slopes$Slope.hour, 3))
Fish3avgslope <- mean(head(Fish3_sorted_slopes$Slope, 3))
Fish3avgR2 <- mean(head(Fish3_sorted_slopes$r2, 3))

Fish3finalRMR <- matrix(c(Fish3, Fish3avgslope, Fish3avgslopehour, Fish3avgR2), nrow=1, ncol=4)

Fish4avgslopehour <- mean(head(Fish4_sorted_slopes$Slope.hour, 3))
Fish4avgslope <- mean(head(Fish4_sorted_slopes$Slope, 3))
Fish4avgR2 <- mean(head(Fish4_sorted_slopes$r2, 3))

Fish4finalRMR <- matrix(c(Fish4, Fish4avgslope, Fish4avgslopehour, Fish4avgR2), nrow=1, ncol=4)

# Bind all fish from this trial together: 
average.slopes <- rbind(Fish1finalRMR, Fish2finalRMR, Fish3finalRMR, Fish4finalRMR)

#Add mean temp of this trial to final file: 
average.slopes <- cbind(average.slopes, mean(RMR$Temp))
colnames(average.slopes) <- c("FishID", "FinalSlope", "FinalSlopeHour", "FinalR2", "meanTemp")

slopes.all.final <- rbind(average.slopes, slopes.all.final)

```

#### D3_B2_C

```{r}
# Load txt file
RMR_raw <- readcleancannibal("2018_burbot_resp_D3_B2_C_raw.txt")

# Assign names for this trial: 

"Fish1" <- "D3_B2_C1"
"Fish2" <- "D3_B2_C2"
"Fish3" <- "D3_B2_C3"
"Fish4" <- "D3_B2_C4"

# Create a new column with the time in minutes from the start of the file: 

RMR_raw$Time.m <- sapply(seq_along(RMR_raw$DateTime),
function(i) as.numeric(difftime(RMR_raw$DateTime[i], RMR_raw$DateTime[1], units='mins')))


# Pull measure periods. Grep finds all of the data in the Phase column that contains the letter M. 

RMR <- RMR_raw[grep("M", RMR_raw$Phase), ]

# Pull out first value of each phase for graphing later
Phase.start <- ddply(RMR, "Phase", head, 1)
Phase.start <- Phase.start[,1:2]

# Change the column names of the chambers to the appropriate FishID:
Name.vec <- c(Fish1, Fish2, Fish3, Fish4)
names(RMR)[5:8] <- Name.vec


# Reshape the data so all O2 saturation values are in a single column:

RMR.2 <- melt(RMR, measure = Name.vec)

# Rename the columns. 
names(RMR.2) <-c("DateTime","Phase","Salinity","Temp","Time.m","FishID","O2.sat")

# Plot the measurement periods of all fish from this trial:
p=ggplot(data=RMR.2, aes(x=Time.m, y=O2.sat, group=Phase))
p+geom_point(aes(color=FishID))+theme_bw()


# Separate out individual fish for graphing/analysis:

## Separate each fish to it's own RMR file: 
Fish1_RMR <- filter(RMR.2, FishID == Fish1)
Fish2_RMR <- filter(RMR.2, FishID == Fish2)
Fish3_RMR <- filter(RMR.2, FishID == Fish3)
Fish4_RMR <- filter(RMR.2, FishID == Fish4)

# Determine length of measurment period because they vary between trials (ugh). I chose measurement period 5 so it's not in the first few measurement periods where we were switching them manually but not the last measurement period either in case it was cut short. 
(nrow(Fish1_RMR[Fish1_RMR$Phase == "M5",]))/60

# Determine total time in chambers (in hours) because this also slightly varied between trials (ugh). 
(nrow(RMR_raw))/60/60
```

```{r eval=FALSE}
## Plot individual measurement periods for each fish: 
p=ggplot(data=Fish1_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase), group=1)+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish1) 

p=ggplot(data=Fish2_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish2) 

p=ggplot(data=Fish3_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish3) 

p=ggplot(data=Fish4_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish4) 

##Plot individual measurement periods with the line of best fit: 

p=ggplot(data=Fish1_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish1) 

p=ggplot(data=Fish2_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish2) 

p=ggplot(data=Fish3_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish3) 

p=ggplot(data=Fish4_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish4) 
```

```{r}
# Calculate slopes of lines for each fish and convert slope from minutes to hours:
O2slopel1 <- dlply(Fish1_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope1 <- ldply(O2slopel1, function(d) coef(d))
names(O2slope1) <- c("Phase", "Intercept","Slope")
O2slope1<- mutate(O2slope1, FishID = Fish1)
O2slope1<-ddply(O2slope1, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel2 <- dlply(Fish2_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope2 <- ldply(O2slopel2, function(d) coef(d))
names(O2slope2) <- c("Phase", "Intercept","Slope")
O2slope2 <- mutate(O2slope2, FishID = Fish2)
O2slope2<-ddply(O2slope2, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel3 <- dlply(Fish3_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope3 <- ldply(O2slopel3, function(d) coef(d))
names(O2slope3) <- c("Phase", "Intercept","Slope")
O2slope3 <- mutate(O2slope3, FishID = Fish3)
O2slope3<-ddply(O2slope3, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel4 <- dlply(Fish4_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope4 <- ldply(O2slopel4, function(d) coef(d))
names(O2slope4) <- c("Phase", "Intercept","Slope")
O2slope4 <- mutate(O2slope4, FishID = Fish4)
O2slope4<-ddply(O2slope4, .(Phase), mutate, Slope.hour=Slope*60)


# Calculating the fit of each slope: 
O2.r2.1 <- dlply(Fish1_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit1<-ldply(O2.r2.1, function(d) d$r.squared)
slopefit1
names(slopefit1) <-c("Phase","r2")

O2.r2.2 <- dlply(Fish2_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit2<-ldply(O2.r2.2, function(d) d$r.squared)
slopefit2
names(slopefit2) <-c("Phase","r2")

O2.r2.3 <- dlply(Fish3_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit3<-ldply(O2.r2.3, function(d) d$r.squared)
slopefit3
names(slopefit3) <-c("Phase","r2")

O2.r2.4 <- dlply(Fish4_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit4<-ldply(O2.r2.4, function(d) d$r.squared)
slopefit4
names(slopefit4) <-c("Phase","r2")


# merge together slope and r2:
O2slope.r2.1<-merge(O2slope1, slopefit1, by=c("Phase"))
O2slope.r2.1<- O2slope.r2.1[mixedorder(O2slope.r2.1$Phase),]
O2slope.r2.1

O2slope.r2.2<-merge(O2slope2, slopefit2, by=c("Phase"))
O2slope.r2.2<- O2slope.r2.2[mixedorder(O2slope.r2.2$Phase),]
O2slope.r2.2

O2slope.r2.3<-merge(O2slope3, slopefit3, by=c("Phase"))
O2slope.r2.3<- O2slope.r2.3[mixedorder(O2slope.r2.3$Phase),]
O2slope.r2.3

O2slope.r2.4<-merge(O2slope4, slopefit4, by=c("Phase"))
O2slope.r2.4<- O2slope.r2.4[mixedorder(O2slope.r2.4$Phase),]
O2slope.r2.4

# bind all slope and r2 dataframes and sort the phases so they're in order:
slopes.r2.all <- rbind(O2slope.r2.1,O2slope.r2.2,O2slope.r2.3,O2slope.r2.4)
slopes.r2.all <- merge(slopes.r2.all, Phase.start, by=c("Phase"))
phase.sort <- unique(mixedsort(slopes.r2.all$Phase))
slopes.r2.all$Phase <- factor(slopes.r2.all$Phase, levels = phase.sort)


# Add mean temperature for that trial to the slopes.r2.all file. 
slopes.r2.all$meanTemp <- mean(RMR$Temp)

# Add in time from start of file

trial.first<- ddply(slopes.r2.all,"DateTime", head,1)
slopes.r2.all$Time.m <- difftime(slopes.r2.all$DateTime, head(trial.first$DateTime,1), units="mins", tz = "America/Los_Angeles")

# As you go through the text files from autoresp, you can consecutively add all of the slopes data, etc. to the slopes.all file, which is your big giant master file with all the data. After I calculate the slopes & r2 etc. for each file, then load the morphometrics data file and merge them together based on FishId. Bind days together first, then everything. 
slopes.all <- rbind(slopes.all, slopes.r2.all)


# Plot
ggplot(slopes.r2.all, aes(x=DateTime, y=(-1*Slope)))+
  geom_point(aes(color=FishID))+
  theme_bw()

# Sort based on slope value for every fish: 

Fish1_sorted_slopes <- O2slope.r2.1[order(-O2slope.r2.1$Slope.hour),]

Fish2_sorted_slopes <- O2slope.r2.2[order(-O2slope.r2.2$Slope.hour),]

Fish3_sorted_slopes <- O2slope.r2.3[order(-O2slope.r2.3$Slope.hour),]

Fish4_sorted_slopes <- O2slope.r2.4[order(-O2slope.r2.4$Slope.hour),]

# Remove the first two measurement periods. We don't want to include the first chunk of time immediately post-handling because thats a priori information that the fish was stressed. 

Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M1', Phase))
Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M2', Phase))
Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M1   ', Phase))
Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M2   ', Phase))

Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M1', Phase))
Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M2', Phase))
Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M1   ', Phase))
Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M2   ', Phase))

Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M1', Phase))
Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M2', Phase))
Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M1   ', Phase))
Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M2   ', Phase))

Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M1', Phase))
Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M2', Phase))
Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M1   ', Phase))
Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M2   ', Phase))

# Average lowest three

Fish1avgslopehour <- mean(head(Fish1_sorted_slopes$Slope.hour, 3))
Fish1avgslope <- mean(head(Fish1_sorted_slopes$Slope, 3))
Fish1avgR2 <- mean(head(Fish1_sorted_slopes$r2, 3))

Fish1finalRMR <- matrix(c(Fish1, Fish1avgslope, Fish1avgslopehour, Fish1avgR2), nrow=1, ncol=4)

Fish2avgslopehour <- mean(head(Fish2_sorted_slopes$Slope.hour, 3))
Fish2avgslope <- mean(head(Fish2_sorted_slopes$Slope, 3))
Fish2avgR2 <- mean(head(Fish2_sorted_slopes$r2, 3))

Fish2finalRMR <- matrix(c(Fish2, Fish2avgslope, Fish2avgslopehour, Fish2avgR2), nrow=1, ncol=4)

Fish3avgslopehour <- mean(head(Fish3_sorted_slopes$Slope.hour, 3))
Fish3avgslope <- mean(head(Fish3_sorted_slopes$Slope, 3))
Fish3avgR2 <- mean(head(Fish3_sorted_slopes$r2, 3))

Fish3finalRMR <- matrix(c(Fish3, Fish3avgslope, Fish3avgslopehour, Fish3avgR2), nrow=1, ncol=4)

Fish4avgslopehour <- mean(head(Fish4_sorted_slopes$Slope.hour, 3))
Fish4avgslope <- mean(head(Fish4_sorted_slopes$Slope, 3))
Fish4avgR2 <- mean(head(Fish4_sorted_slopes$r2, 3))

Fish4finalRMR <- matrix(c(Fish4, Fish4avgslope, Fish4avgslopehour, Fish4avgR2), nrow=1, ncol=4)

# Bind all fish from this trial together: 
average.slopes <- rbind(Fish1finalRMR, Fish2finalRMR, Fish3finalRMR, Fish4finalRMR)

#Add mean temp of this trial to final file: 
average.slopes <- cbind(average.slopes, mean(RMR$Temp))
colnames(average.slopes) <- c("FishID", "FinalSlope", "FinalSlopeHour", "FinalR2", "meanTemp")

slopes.all.final <- rbind(average.slopes, slopes.all.final)

```

#### D3_B3_C

```{r}
# Load txt file
RMR_raw <- readcleancannibal("2018_burbot_resp_D3_B3_C_raw.txt")

# Assign names for this trial: 

"Fish1" <- "D3_B3_C1"
"Fish2" <- "D3_B3_C2"
"Fish3" <- "D3_B3_C3"
"Fish4" <- "D3_B3_C4"

# Create a new column with the time in minutes from the start of the file: 

RMR_raw$Time.m <- sapply(seq_along(RMR_raw$DateTime),
function(i) as.numeric(difftime(RMR_raw$DateTime[i], RMR_raw$DateTime[1], units='mins')))


# Pull measure periods. Grep finds all of the data in the Phase column that contains the letter M. 

RMR <- RMR_raw[grep("M", RMR_raw$Phase), ]


# Pull out first value of each phase for graphing later
Phase.start <- ddply(RMR, "Phase", head, 1)
Phase.start <- Phase.start[,1:2]


# Change the column names of the chambers to the appropriate FishID:
Name.vec <- c(Fish1, Fish2, Fish3, Fish4)
names(RMR)[5:8] <- Name.vec


# Reshape the data so all O2 saturation values are in a single column:

RMR.2 <- melt(RMR, measure = Name.vec)

# Rename the columns. 
names(RMR.2) <-c("DateTime","Phase","Salinity","Temp","Time.m","FishID","O2.sat")

# Plot the measurement periods of all fish from this trial:
p=ggplot(data=RMR.2, aes(x=Time.m, y=O2.sat, group=Phase))
p+geom_point(aes(color=FishID))+theme_bw()


# Separate out individual fish for graphing/analysis:

## Separate each fish to it's own RMR file: 
Fish1_RMR <- filter(RMR.2, FishID == Fish1)
Fish2_RMR <- filter(RMR.2, FishID == Fish2)
Fish3_RMR <- filter(RMR.2, FishID == Fish3)
Fish4_RMR <- filter(RMR.2, FishID == Fish4)

# Determine length of measurment period because they vary between trials (ugh). I chose measurement period 5 so it's not in the first few measurement periods where we were switching them manually but not the last measurement period either in case it was cut short. 
(nrow(Fish1_RMR[Fish1_RMR$Phase == "M5",]))/60

# Determine total time in chambers (in hours) because this also slightly varied between trials (ugh). 
(nrow(RMR_raw))/60/60
```

```{r eval=FALSE}
## Plot individual measurement periods for each fish: 
p=ggplot(data=Fish1_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase), group=1)+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish1) 

p=ggplot(data=Fish2_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish2) 

p=ggplot(data=Fish3_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish3) 

p=ggplot(data=Fish4_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish4) 

##Plot individual measurement periods with the line of best fit: 

p=ggplot(data=Fish1_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish1) 

p=ggplot(data=Fish2_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish2) 

p=ggplot(data=Fish3_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish3) 

p=ggplot(data=Fish4_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish4) 
```

```{r}
# Calculate slopes of lines for each fish and convert slope from minutes to hours:
O2slopel1 <- dlply(Fish1_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope1 <- ldply(O2slopel1, function(d) coef(d))
names(O2slope1) <- c("Phase", "Intercept","Slope")
O2slope1<- mutate(O2slope1, FishID = Fish1)
O2slope1<-ddply(O2slope1, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel2 <- dlply(Fish2_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope2 <- ldply(O2slopel2, function(d) coef(d))
names(O2slope2) <- c("Phase", "Intercept","Slope")
O2slope2 <- mutate(O2slope2, FishID = Fish2)
O2slope2<-ddply(O2slope2, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel3 <- dlply(Fish3_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope3 <- ldply(O2slopel3, function(d) coef(d))
names(O2slope3) <- c("Phase", "Intercept","Slope")
O2slope3 <- mutate(O2slope3, FishID = Fish3)
O2slope3<-ddply(O2slope3, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel4 <- dlply(Fish4_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope4 <- ldply(O2slopel4, function(d) coef(d))
names(O2slope4) <- c("Phase", "Intercept","Slope")
O2slope4 <- mutate(O2slope4, FishID = Fish4)
O2slope4<-ddply(O2slope4, .(Phase), mutate, Slope.hour=Slope*60)


# Calculating the fit of each slope: 
O2.r2.1 <- dlply(Fish1_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit1<-ldply(O2.r2.1, function(d) d$r.squared)
slopefit1
names(slopefit1) <-c("Phase","r2")

O2.r2.2 <- dlply(Fish2_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit2<-ldply(O2.r2.2, function(d) d$r.squared)
slopefit2
names(slopefit2) <-c("Phase","r2")

O2.r2.3 <- dlply(Fish3_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit3<-ldply(O2.r2.3, function(d) d$r.squared)
slopefit3
names(slopefit3) <-c("Phase","r2")

O2.r2.4 <- dlply(Fish4_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit4<-ldply(O2.r2.4, function(d) d$r.squared)
slopefit4
names(slopefit4) <-c("Phase","r2")


# merge together slope and r2:
O2slope.r2.1<-merge(O2slope1, slopefit1, by=c("Phase"))
O2slope.r2.1<- O2slope.r2.1[mixedorder(O2slope.r2.1$Phase),]
O2slope.r2.1

O2slope.r2.2<-merge(O2slope2, slopefit2, by=c("Phase"))
O2slope.r2.2<- O2slope.r2.2[mixedorder(O2slope.r2.2$Phase),]
O2slope.r2.2

O2slope.r2.3<-merge(O2slope3, slopefit3, by=c("Phase"))
O2slope.r2.3<- O2slope.r2.3[mixedorder(O2slope.r2.3$Phase),]
O2slope.r2.3

O2slope.r2.4<-merge(O2slope4, slopefit4, by=c("Phase"))
O2slope.r2.4<- O2slope.r2.4[mixedorder(O2slope.r2.4$Phase),]
O2slope.r2.4

# bind all slope and r2 dataframes and sort the phases so they're in order:
slopes.r2.all <- rbind(O2slope.r2.1,O2slope.r2.2,O2slope.r2.3,O2slope.r2.4)
slopes.r2.all <- merge(slopes.r2.all, Phase.start, by=c("Phase"))
phase.sort <- unique(mixedsort(slopes.r2.all$Phase))
slopes.r2.all$Phase <- factor(slopes.r2.all$Phase, levels = phase.sort)


# Add mean temperature for that trial to the slopes.r2.all file. 
slopes.r2.all$meanTemp <- mean(RMR$Temp)

# Add in time from start of file

trial.first<- ddply(slopes.r2.all,"DateTime", head,1)
slopes.r2.all$Time.m <- difftime(slopes.r2.all$DateTime, head(trial.first$DateTime,1), units="mins", tz = "America/Los_Angeles")

# As you go through the text files from autoresp, you can consecutively add all of the slopes data, etc. to the slopes.all file, which is your big giant master file with all the data. After I calculate the slopes & r2 etc. for each file, then load the morphometrics data file and merge them together based on FishId. Bind days together first, then everything. 
slopes.all <- rbind(slopes.all, slopes.r2.all)


# Plot
ggplot(slopes.r2.all, aes(x=DateTime, y=(-1*Slope)))+
  geom_point(aes(color=FishID))+
  theme_bw()

# Sort based on slope value for every fish: 

Fish1_sorted_slopes <- O2slope.r2.1[order(-O2slope.r2.1$Slope.hour),]

Fish2_sorted_slopes <- O2slope.r2.2[order(-O2slope.r2.2$Slope.hour),]

Fish3_sorted_slopes <- O2slope.r2.3[order(-O2slope.r2.3$Slope.hour),]

Fish4_sorted_slopes <- O2slope.r2.4[order(-O2slope.r2.4$Slope.hour),]

# Remove the first two measurement periods. We don't want to include the first chunk of time immediately post-handling because thats a priori information that the fish was stressed. 

Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M1', Phase))
Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M2', Phase))
Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M1   ', Phase))
Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M2   ', Phase))

Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M1', Phase))
Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M2', Phase))
Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M1   ', Phase))
Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M2   ', Phase))

Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M1', Phase))
Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M2', Phase))
Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M1   ', Phase))
Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M2   ', Phase))

Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M1', Phase))
Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M2', Phase))
Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M1   ', Phase))
Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M2   ', Phase))

# Average lowest three

Fish1avgslopehour <- mean(head(Fish1_sorted_slopes$Slope.hour, 3))
Fish1avgslope <- mean(head(Fish1_sorted_slopes$Slope, 3))
Fish1avgR2 <- mean(head(Fish1_sorted_slopes$r2, 3))

Fish1finalRMR <- matrix(c(Fish1, Fish1avgslope, Fish1avgslopehour, Fish1avgR2), nrow=1, ncol=4)

Fish2avgslopehour <- mean(head(Fish2_sorted_slopes$Slope.hour, 3))
Fish2avgslope <- mean(head(Fish2_sorted_slopes$Slope, 3))
Fish2avgR2 <- mean(head(Fish2_sorted_slopes$r2, 3))

Fish2finalRMR <- matrix(c(Fish2, Fish2avgslope, Fish2avgslopehour, Fish2avgR2), nrow=1, ncol=4)

Fish3avgslopehour <- mean(head(Fish3_sorted_slopes$Slope.hour, 3))
Fish3avgslope <- mean(head(Fish3_sorted_slopes$Slope, 3))
Fish3avgR2 <- mean(head(Fish3_sorted_slopes$r2, 3))

Fish3finalRMR <- matrix(c(Fish3, Fish3avgslope, Fish3avgslopehour, Fish3avgR2), nrow=1, ncol=4)

Fish4avgslopehour <- mean(head(Fish4_sorted_slopes$Slope.hour, 3))
Fish4avgslope <- mean(head(Fish4_sorted_slopes$Slope, 3))
Fish4avgR2 <- mean(head(Fish4_sorted_slopes$r2, 3))

Fish4finalRMR <- matrix(c(Fish4, Fish4avgslope, Fish4avgslopehour, Fish4avgR2), nrow=1, ncol=4)

# Bind all fish from this trial together: 
average.slopes <- rbind(Fish1finalRMR, Fish2finalRMR, Fish3finalRMR, Fish4finalRMR)

#Add mean temp of this trial to final file: 
average.slopes <- cbind(average.slopes, mean(RMR$Temp))
colnames(average.slopes) <- c("FishID", "FinalSlope", "FinalSlopeHour", "FinalR2", "meanTemp")

slopes.all.final <- rbind(average.slopes, slopes.all.final)

```

#### D4_B1_C

```{r}
# Load txt file
RMR_raw <- readcleancannibal("2018_burbot_resp_D4_B1_C_raw.txt")

# Assign names for this trial: 

"Fish1" <- "D4_B1_C1"
"Fish2" <- "D4_B1_C2"
"Fish3" <- "D4_B1_C3"
"Fish4" <- "D4_B1_C4"

# Create a new column with the time in minutes from the start of the file: 

RMR_raw$Time.m <- sapply(seq_along(RMR_raw$DateTime),
function(i) as.numeric(difftime(RMR_raw$DateTime[i], RMR_raw$DateTime[1], units='mins')))


# Pull measure periods. Grep finds all of the data in the Phase column that contains the letter M. 

RMR <- RMR_raw[grep("M", RMR_raw$Phase), ]


# Pull out first value of each phase for graphing later
Phase.start <- ddply(RMR, "Phase", head, 1)
Phase.start <- Phase.start[,1:2]


# Change the column names of the chambers to the appropriate FishID:
Name.vec <- c(Fish1, Fish2, Fish3, Fish4)
names(RMR)[5:8] <- Name.vec


# Reshape the data so all O2 saturation values are in a single column:

RMR.2 <- melt(RMR, measure = Name.vec)

# Rename the columns. 
names(RMR.2) <-c("DateTime","Phase","Salinity","Temp","Time.m","FishID","O2.sat")

# Plot the measurement periods of all fish from this trial:
p=ggplot(data=RMR.2, aes(x=Time.m, y=O2.sat, group=Phase))
p+geom_point(aes(color=FishID))+theme_bw()


# Separate out individual fish for graphing/analysis:

## Separate each fish to it's own RMR file: 
Fish1_RMR <- filter(RMR.2, FishID == Fish1)
Fish2_RMR <- filter(RMR.2, FishID == Fish2)
Fish3_RMR <- filter(RMR.2, FishID == Fish3)
Fish4_RMR <- filter(RMR.2, FishID == Fish4)

# Determine length of measurment period because they vary between trials (ugh). I chose measurement period 5 so it's not in the first few measurement periods where we were switching them manually but not the last measurement period either in case it was cut short. 
(nrow(Fish1_RMR[Fish1_RMR$Phase == "M5",]))/60

# Determine total time in chambers (in hours) because this also slightly varied between trials (ugh). 
(nrow(RMR_raw))/60/60
```

```{r eval=FALSE}
## Plot individual measurement periods for each fish: 
p=ggplot(data=Fish1_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase), group=1)+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish1) 

p=ggplot(data=Fish2_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish2) 

p=ggplot(data=Fish3_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish3) 

p=ggplot(data=Fish4_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish4) 

##Plot individual measurement periods with the line of best fit: 

p=ggplot(data=Fish1_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish1) 

p=ggplot(data=Fish2_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish2) 

p=ggplot(data=Fish3_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish3) 

p=ggplot(data=Fish4_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish4) 
```

```{r}
# Calculate slopes of lines for each fish and convert slope from minutes to hours:
O2slopel1 <- dlply(Fish1_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope1 <- ldply(O2slopel1, function(d) coef(d))
names(O2slope1) <- c("Phase", "Intercept","Slope")
O2slope1<- mutate(O2slope1, FishID = Fish1)
O2slope1<-ddply(O2slope1, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel2 <- dlply(Fish2_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope2 <- ldply(O2slopel2, function(d) coef(d))
names(O2slope2) <- c("Phase", "Intercept","Slope")
O2slope2 <- mutate(O2slope2, FishID = Fish2)
O2slope2<-ddply(O2slope2, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel3 <- dlply(Fish3_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope3 <- ldply(O2slopel3, function(d) coef(d))
names(O2slope3) <- c("Phase", "Intercept","Slope")
O2slope3 <- mutate(O2slope3, FishID = Fish3)
O2slope3<-ddply(O2slope3, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel4 <- dlply(Fish4_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope4 <- ldply(O2slopel4, function(d) coef(d))
names(O2slope4) <- c("Phase", "Intercept","Slope")
O2slope4 <- mutate(O2slope4, FishID = Fish4)
O2slope4<-ddply(O2slope4, .(Phase), mutate, Slope.hour=Slope*60)


# Calculating the fit of each slope: 
O2.r2.1 <- dlply(Fish1_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit1<-ldply(O2.r2.1, function(d) d$r.squared)
slopefit1
names(slopefit1) <-c("Phase","r2")

O2.r2.2 <- dlply(Fish2_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit2<-ldply(O2.r2.2, function(d) d$r.squared)
slopefit2
names(slopefit2) <-c("Phase","r2")

O2.r2.3 <- dlply(Fish3_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit3<-ldply(O2.r2.3, function(d) d$r.squared)
slopefit3
names(slopefit3) <-c("Phase","r2")

O2.r2.4 <- dlply(Fish4_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit4<-ldply(O2.r2.4, function(d) d$r.squared)
slopefit4
names(slopefit4) <-c("Phase","r2")


# merge together slope and r2:
O2slope.r2.1<-merge(O2slope1, slopefit1, by=c("Phase"))
O2slope.r2.1<- O2slope.r2.1[mixedorder(O2slope.r2.1$Phase),]
O2slope.r2.1

O2slope.r2.2<-merge(O2slope2, slopefit2, by=c("Phase"))
O2slope.r2.2<- O2slope.r2.2[mixedorder(O2slope.r2.2$Phase),]
O2slope.r2.2

O2slope.r2.3<-merge(O2slope3, slopefit3, by=c("Phase"))
O2slope.r2.3<- O2slope.r2.3[mixedorder(O2slope.r2.3$Phase),]
O2slope.r2.3

O2slope.r2.4<-merge(O2slope4, slopefit4, by=c("Phase"))
O2slope.r2.4<- O2slope.r2.4[mixedorder(O2slope.r2.4$Phase),]
O2slope.r2.4

# bind all slope and r2 dataframes and sort the phases so they're in order:
slopes.r2.all <- rbind(O2slope.r2.1,O2slope.r2.2,O2slope.r2.3,O2slope.r2.4)
slopes.r2.all <- merge(slopes.r2.all, Phase.start, by=c("Phase"))
phase.sort <- unique(mixedsort(slopes.r2.all$Phase))
slopes.r2.all$Phase <- factor(slopes.r2.all$Phase, levels = phase.sort)


# Add mean temperature for that trial to the slopes.r2.all file. 
slopes.r2.all$meanTemp <- mean(RMR$Temp)

# Add in time from start of file

trial.first<- ddply(slopes.r2.all,"DateTime", head,1)
slopes.r2.all$Time.m <- difftime(slopes.r2.all$DateTime, head(trial.first$DateTime,1), units="mins", tz = "America/Los_Angeles")

# As you go through the text files from autoresp, you can consecutively add all of the slopes data, etc. to the slopes.all file, which is your big giant master file with all the data. After I calculate the slopes & r2 etc. for each file, then load the morphometrics data file and merge them together based on FishId. Bind days together first, then everything. 
slopes.all <- rbind(slopes.all, slopes.r2.all)


# Plot all measurement periods for all fish from this trial 
ggplot(slopes.r2.all, aes(x=DateTime, y=(-1*Slope)))+
  geom_point(aes(color=FishID))+
  theme_bw()


# Sort based on slope value for every fish: 

Fish1_sorted_slopes <- O2slope.r2.1[order(-O2slope.r2.1$Slope.hour),]

Fish2_sorted_slopes <- O2slope.r2.2[order(-O2slope.r2.2$Slope.hour),]

Fish3_sorted_slopes <- O2slope.r2.3[order(-O2slope.r2.3$Slope.hour),]

Fish4_sorted_slopes <- O2slope.r2.4[order(-O2slope.r2.4$Slope.hour),]

# Remove the first two measurement periods. We don't want to include the first chunk of time immediately post-handling because thats a priori information that the fish was stressed. 

Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M1', Phase))
Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M2', Phase))
Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M1   ', Phase))
Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M2   ', Phase))

Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M1', Phase))
Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M2', Phase))
Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M1   ', Phase))
Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M2   ', Phase))

Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M1', Phase))
Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M2', Phase))
Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M1   ', Phase))
Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M2   ', Phase))

Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M1', Phase))
Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M2', Phase))
Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M1   ', Phase))
Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M2   ', Phase))

# Average lowest three

Fish1avgslopehour <- mean(head(Fish1_sorted_slopes$Slope.hour, 3))
Fish1avgslope <- mean(head(Fish1_sorted_slopes$Slope, 3))
Fish1avgR2 <- mean(head(Fish1_sorted_slopes$r2, 3))

Fish1finalRMR <- matrix(c(Fish1, Fish1avgslope, Fish1avgslopehour, Fish1avgR2), nrow=1, ncol=4)

Fish2avgslopehour <- mean(head(Fish2_sorted_slopes$Slope.hour, 3))
Fish2avgslope <- mean(head(Fish2_sorted_slopes$Slope, 3))
Fish2avgR2 <- mean(head(Fish2_sorted_slopes$r2, 3))

Fish2finalRMR <- matrix(c(Fish2, Fish2avgslope, Fish2avgslopehour, Fish2avgR2), nrow=1, ncol=4)

Fish3avgslopehour <- mean(head(Fish3_sorted_slopes$Slope.hour, 3))
Fish3avgslope <- mean(head(Fish3_sorted_slopes$Slope, 3))
Fish3avgR2 <- mean(head(Fish3_sorted_slopes$r2, 3))

Fish3finalRMR <- matrix(c(Fish3, Fish3avgslope, Fish3avgslopehour, Fish3avgR2), nrow=1, ncol=4)

Fish4avgslopehour <- mean(head(Fish4_sorted_slopes$Slope.hour, 3))
Fish4avgslope <- mean(head(Fish4_sorted_slopes$Slope, 3))
Fish4avgR2 <- mean(head(Fish4_sorted_slopes$r2, 3))

Fish4finalRMR <- matrix(c(Fish4, Fish4avgslope, Fish4avgslopehour, Fish4avgR2), nrow=1, ncol=4)

# Bind all fish from this trial together: 
average.slopes <- rbind(Fish1finalRMR, Fish2finalRMR, Fish3finalRMR, Fish4finalRMR)

#Add mean temp of this trial to final file: 
average.slopes <- cbind(average.slopes, mean(RMR$Temp))
colnames(average.slopes) <- c("FishID", "FinalSlope", "FinalSlopeHour", "FinalR2", "meanTemp")

slopes.all.final <- rbind(average.slopes, slopes.all.final)

```

#### D4_B2_C

```{r}
# Load txt file
RMR_raw <- readcleancannibal("2018_burbot_resp_D4_B2_C_raw.txt")

# Assign names for this trial: 

"Fish1" <- "D4_B2_C1"
"Fish2" <- "D4_B2_C2"
"Fish3" <- "D4_B2_C3"
"Fish4" <- "D4_B2_C4"

# Create a new column with the time in minutes from the start of the file: 

RMR_raw$Time.m <- sapply(seq_along(RMR_raw$DateTime),
function(i) as.numeric(difftime(RMR_raw$DateTime[i], RMR_raw$DateTime[1], units='mins')))


# Pull measure periods. Grep finds all of the data in the Phase column that contains the letter M. 

RMR <- RMR_raw[grep("M", RMR_raw$Phase), ]


# Pull out first value of each phase for graphing later
Phase.start <- ddply(RMR, "Phase", head, 1)
Phase.start <- Phase.start[,1:2]

# Change the column names of the chambers to the appropriate FishID:
Name.vec <- c(Fish1, Fish2, Fish3, Fish4)
names(RMR)[5:8] <- Name.vec


# Reshape the data so all O2 saturation values are in a single column:

RMR.2 <- melt(RMR, measure = Name.vec)

# Rename the columns. 
names(RMR.2) <-c("DateTime","Phase","Salinity","Temp","Time.m","FishID","O2.sat")

# Plot the measurement periods of all fish from this trial:
p=ggplot(data=RMR.2, aes(x=Time.m, y=O2.sat, group=Phase))
p+geom_point(aes(color=FishID))+theme_bw()


# Separate out individual fish for graphing/analysis:

## Separate each fish to it's own RMR file: 
Fish1_RMR <- filter(RMR.2, FishID == Fish1)
Fish2_RMR <- filter(RMR.2, FishID == Fish2)
Fish3_RMR <- filter(RMR.2, FishID == Fish3)
Fish4_RMR <- filter(RMR.2, FishID == Fish4)

# Determine length of measurment period because they vary between trials (ugh). I chose measurement period 5 so it's not in the first few measurement periods where we were switching them manually but not the last measurement period either in case it was cut short. 
(nrow(Fish1_RMR[Fish1_RMR$Phase == "M5   ",]))/60

# Determine total time in chambers (in hours) because this also slightly varied between trials (ugh). 
(nrow(RMR_raw))/60/60
```

```{r eval=FALSE}
## Plot individual measurement periods for each fish: 
p=ggplot(data=Fish1_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase), group=1)+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish1) 

p=ggplot(data=Fish2_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish2) 

p=ggplot(data=Fish3_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish3) 

p=ggplot(data=Fish4_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish4) 

##Plot individual measurement periods with the line of best fit: 

p=ggplot(data=Fish1_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish1) 

p=ggplot(data=Fish2_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish2) 

p=ggplot(data=Fish3_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish3) 

p=ggplot(data=Fish4_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish4) 
```

```{r}
# Calculate slopes of lines for each fish and convert slope from minutes to hours:
O2slopel1 <- dlply(Fish1_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope1 <- ldply(O2slopel1, function(d) coef(d))
names(O2slope1) <- c("Phase", "Intercept","Slope")
O2slope1<- mutate(O2slope1, FishID = Fish1)
O2slope1<-ddply(O2slope1, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel2 <- dlply(Fish2_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope2 <- ldply(O2slopel2, function(d) coef(d))
names(O2slope2) <- c("Phase", "Intercept","Slope")
O2slope2 <- mutate(O2slope2, FishID = Fish2)
O2slope2<-ddply(O2slope2, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel3 <- dlply(Fish3_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope3 <- ldply(O2slopel3, function(d) coef(d))
names(O2slope3) <- c("Phase", "Intercept","Slope")
O2slope3 <- mutate(O2slope3, FishID = Fish3)
O2slope3<-ddply(O2slope3, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel4 <- dlply(Fish4_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope4 <- ldply(O2slopel4, function(d) coef(d))
names(O2slope4) <- c("Phase", "Intercept","Slope")
O2slope4 <- mutate(O2slope4, FishID = Fish4)
O2slope4<-ddply(O2slope4, .(Phase), mutate, Slope.hour=Slope*60)


# Calculating the fit of each slope: 
O2.r2.1 <- dlply(Fish1_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit1<-ldply(O2.r2.1, function(d) d$r.squared)
slopefit1
names(slopefit1) <-c("Phase","r2")

O2.r2.2 <- dlply(Fish2_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit2<-ldply(O2.r2.2, function(d) d$r.squared)
slopefit2
names(slopefit2) <-c("Phase","r2")

O2.r2.3 <- dlply(Fish3_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit3<-ldply(O2.r2.3, function(d) d$r.squared)
slopefit3
names(slopefit3) <-c("Phase","r2")

O2.r2.4 <- dlply(Fish4_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit4<-ldply(O2.r2.4, function(d) d$r.squared)
slopefit4
names(slopefit4) <-c("Phase","r2")


# merge together slope and r2:
O2slope.r2.1<-merge(O2slope1, slopefit1, by=c("Phase"))
O2slope.r2.1<- O2slope.r2.1[mixedorder(O2slope.r2.1$Phase),]
O2slope.r2.1

O2slope.r2.2<-merge(O2slope2, slopefit2, by=c("Phase"))
O2slope.r2.2<- O2slope.r2.2[mixedorder(O2slope.r2.2$Phase),]
O2slope.r2.2

O2slope.r2.3<-merge(O2slope3, slopefit3, by=c("Phase"))
O2slope.r2.3<- O2slope.r2.3[mixedorder(O2slope.r2.3$Phase),]
O2slope.r2.3

O2slope.r2.4<-merge(O2slope4, slopefit4, by=c("Phase"))
O2slope.r2.4<- O2slope.r2.4[mixedorder(O2slope.r2.4$Phase),]
O2slope.r2.4

# bind all slope and r2 dataframes and sort the phases so they're in order:
slopes.r2.all <- rbind(O2slope.r2.1,O2slope.r2.2,O2slope.r2.3,O2slope.r2.4)
slopes.r2.all <- merge(slopes.r2.all, Phase.start, by=c("Phase"))
phase.sort <- unique(mixedsort(slopes.r2.all$Phase))
slopes.r2.all$Phase <- factor(slopes.r2.all$Phase, levels = phase.sort)

# Add mean temperature for that trial to the slopes.r2.all file. 
slopes.r2.all$meanTemp <- mean(RMR$Temp)

# Add in time from start of file

trial.first<- ddply(slopes.r2.all,"DateTime", head,1)
slopes.r2.all$Time.m <- difftime(slopes.r2.all$DateTime, head(trial.first$DateTime,1), units="mins", tz = "America/Los_Angeles")

# As you go through the text files from autoresp, you can consecutively add all of the slopes data, etc. to the slopes.all file, which is your big giant master file with all the data. After I calculate the slopes & r2 etc. for each file, then load the morphometrics data file and merge them together based on FishId. Bind days together first, then everything. 
slopes.all <- rbind(slopes.all, slopes.r2.all)

# Plot all measurement periods for all fish from this trial 
ggplot(slopes.r2.all, aes(x=DateTime, y=(-1*Slope)))+
  geom_point(aes(color=FishID))+
  theme_bw()

# Sort based on slope value for every fish: 

Fish1_sorted_slopes <- O2slope.r2.1[order(-O2slope.r2.1$Slope.hour),]

Fish2_sorted_slopes <- O2slope.r2.2[order(-O2slope.r2.2$Slope.hour),]

Fish3_sorted_slopes <- O2slope.r2.3[order(-O2slope.r2.3$Slope.hour),]

Fish4_sorted_slopes <- O2slope.r2.4[order(-O2slope.r2.4$Slope.hour),]

# Remove the first two measurement periods. We don't want to include the first chunk of time immediately post-handling because thats a priori information that the fish was stressed. 

Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M1', Phase))
Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M2', Phase))
Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M1   ', Phase))
Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M2   ', Phase))

Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M1', Phase))
Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M2', Phase))
Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M1   ', Phase))
Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M2   ', Phase))

Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M1', Phase))
Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M2', Phase))
Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M1   ', Phase))
Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M2   ', Phase))

Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M1', Phase))
Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M2', Phase))
Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M1   ', Phase))
Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M2   ', Phase))

# Average lowest three

Fish1avgslopehour <- mean(head(Fish1_sorted_slopes$Slope.hour, 3))
Fish1avgslope <- mean(head(Fish1_sorted_slopes$Slope, 3))
Fish1avgR2 <- mean(head(Fish1_sorted_slopes$r2, 3))

Fish1finalRMR <- matrix(c(Fish1, Fish1avgslope, Fish1avgslopehour, Fish1avgR2), nrow=1, ncol=4)

Fish2avgslopehour <- mean(head(Fish2_sorted_slopes$Slope.hour, 3))
Fish2avgslope <- mean(head(Fish2_sorted_slopes$Slope, 3))
Fish2avgR2 <- mean(head(Fish2_sorted_slopes$r2, 3))

Fish2finalRMR <- matrix(c(Fish2, Fish2avgslope, Fish2avgslopehour, Fish2avgR2), nrow=1, ncol=4)

Fish3avgslopehour <- mean(head(Fish3_sorted_slopes$Slope.hour, 3))
Fish3avgslope <- mean(head(Fish3_sorted_slopes$Slope, 3))
Fish3avgR2 <- mean(head(Fish3_sorted_slopes$r2, 3))

Fish3finalRMR <- matrix(c(Fish3, Fish3avgslope, Fish3avgslopehour, Fish3avgR2), nrow=1, ncol=4)

Fish4avgslopehour <- mean(head(Fish4_sorted_slopes$Slope.hour, 3))
Fish4avgslope <- mean(head(Fish4_sorted_slopes$Slope, 3))
Fish4avgR2 <- mean(head(Fish4_sorted_slopes$r2, 3))

Fish4finalRMR <- matrix(c(Fish4, Fish4avgslope, Fish4avgslopehour, Fish4avgR2), nrow=1, ncol=4)

# Bind all fish from this trial together: 
average.slopes <- rbind(Fish1finalRMR, Fish2finalRMR, Fish3finalRMR, Fish4finalRMR)

#Add mean temp of this trial to final file: 
average.slopes <- cbind(average.slopes, mean(RMR$Temp))
colnames(average.slopes) <- c("FishID", "FinalSlope", "FinalSlopeHour", "FinalR2", "meanTemp")

slopes.all.final <- rbind(average.slopes, slopes.all.final)

```

#### D4_B3_C

```{r}
# Load txt file
RMR_raw <- readcleancannibal("2018_burbot_resp_D4_B3_C_raw.txt")

# Assign names for this trial: 

"Fish1" <- "D4_B3_C1"
"Fish2" <- "D4_B3_C2"
"Fish3" <- "D4_B3_C3"
"Fish4" <- "D4_B3_C4"

# Create a new column with the time in minutes from the start of the file: 

RMR_raw$Time.m <- sapply(seq_along(RMR_raw$DateTime),
function(i) as.numeric(difftime(RMR_raw$DateTime[i], RMR_raw$DateTime[1], units='mins')))


# Pull measure periods. Grep finds all of the data in the Phase column that contains the letter M. 

RMR <- RMR_raw[grep("M", RMR_raw$Phase), ]


# Pull out first value of each phase for graphing later
Phase.start <- ddply(RMR, "Phase", head, 1)
Phase.start <- Phase.start[,1:2]

# Change the column names of the chambers to the appropriate FishID:
Name.vec <- c(Fish1, Fish2, Fish3, Fish4)
names(RMR)[5:8] <- Name.vec


# Reshape the data so all O2 saturation values are in a single column:

RMR.2 <- melt(RMR, measure = Name.vec)

# Rename the columns. 
names(RMR.2) <-c("DateTime","Phase","Salinity","Temp","Time.m","FishID","O2.sat")

# Plot the measurement periods of all fish from this trial:
p=ggplot(data=RMR.2, aes(x=Time.m, y=O2.sat, group=Phase))
p+geom_point(aes(color=FishID))+theme_bw()


# Separate out individual fish for graphing/analysis:

## Separate each fish to it's own RMR file: 
Fish1_RMR <- filter(RMR.2, FishID == Fish1)
Fish2_RMR <- filter(RMR.2, FishID == Fish2)
Fish3_RMR <- filter(RMR.2, FishID == Fish3)
Fish4_RMR <- filter(RMR.2, FishID == Fish4)

# Determine length of measurment period because they vary between trials (ugh). I chose measurement period 5 so it's not in the first few measurement periods where we were switching them manually but not the last measurement period either in case it was cut short. 
(nrow(Fish1_RMR[Fish1_RMR$Phase == "M5",]))/60

# Determine total time in chambers (in hours) because this also slightly varied between trials (ugh). 
(nrow(RMR_raw))/60/60
```

```{r eval=FALSE}
## Plot individual measurement periods for each fish: 
p=ggplot(data=Fish1_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase), group=1)+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish1) 

p=ggplot(data=Fish2_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish2) 

p=ggplot(data=Fish3_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish3) 

p=ggplot(data=Fish4_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish4) 

##Plot individual measurement periods with the line of best fit: 

p=ggplot(data=Fish1_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish1) 

p=ggplot(data=Fish2_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish2) 

p=ggplot(data=Fish3_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish3) 

p=ggplot(data=Fish4_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish4) 
```

```{r}
# Calculate slopes of lines for each fish and convert slope from minutes to hours:
O2slopel1 <- dlply(Fish1_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope1 <- ldply(O2slopel1, function(d) coef(d))
names(O2slope1) <- c("Phase", "Intercept","Slope")
O2slope1<- mutate(O2slope1, FishID = Fish1)
O2slope1<-ddply(O2slope1, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel2 <- dlply(Fish2_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope2 <- ldply(O2slopel2, function(d) coef(d))
names(O2slope2) <- c("Phase", "Intercept","Slope")
O2slope2 <- mutate(O2slope2, FishID = Fish2)
O2slope2<-ddply(O2slope2, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel3 <- dlply(Fish3_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope3 <- ldply(O2slopel3, function(d) coef(d))
names(O2slope3) <- c("Phase", "Intercept","Slope")
O2slope3 <- mutate(O2slope3, FishID = Fish3)
O2slope3<-ddply(O2slope3, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel4 <- dlply(Fish4_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope4 <- ldply(O2slopel4, function(d) coef(d))
names(O2slope4) <- c("Phase", "Intercept","Slope")
O2slope4 <- mutate(O2slope4, FishID = Fish4)
O2slope4<-ddply(O2slope4, .(Phase), mutate, Slope.hour=Slope*60)


# Calculating the fit of each slope: 
O2.r2.1 <- dlply(Fish1_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit1<-ldply(O2.r2.1, function(d) d$r.squared)
slopefit1
names(slopefit1) <-c("Phase","r2")

O2.r2.2 <- dlply(Fish2_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit2<-ldply(O2.r2.2, function(d) d$r.squared)
slopefit2
names(slopefit2) <-c("Phase","r2")

O2.r2.3 <- dlply(Fish3_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit3<-ldply(O2.r2.3, function(d) d$r.squared)
slopefit3
names(slopefit3) <-c("Phase","r2")

O2.r2.4 <- dlply(Fish4_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit4<-ldply(O2.r2.4, function(d) d$r.squared)
slopefit4
names(slopefit4) <-c("Phase","r2")


# merge together slope and r2:
O2slope.r2.1<-merge(O2slope1, slopefit1, by=c("Phase"))
O2slope.r2.1<- O2slope.r2.1[mixedorder(O2slope.r2.1$Phase),]
O2slope.r2.1

O2slope.r2.2<-merge(O2slope2, slopefit2, by=c("Phase"))
O2slope.r2.2<- O2slope.r2.2[mixedorder(O2slope.r2.2$Phase),]
O2slope.r2.2

O2slope.r2.3<-merge(O2slope3, slopefit3, by=c("Phase"))
O2slope.r2.3<- O2slope.r2.3[mixedorder(O2slope.r2.3$Phase),]
O2slope.r2.3

O2slope.r2.4<-merge(O2slope4, slopefit4, by=c("Phase"))
O2slope.r2.4<- O2slope.r2.4[mixedorder(O2slope.r2.4$Phase),]
O2slope.r2.4

# bind all slope and r2 dataframes and sort the phases so they're in order:
slopes.r2.all <- rbind(O2slope.r2.1,O2slope.r2.2,O2slope.r2.3,O2slope.r2.4)
slopes.r2.all <- merge(slopes.r2.all, Phase.start, by=c("Phase"))
phase.sort <- unique(mixedsort(slopes.r2.all$Phase))
slopes.r2.all$Phase <- factor(slopes.r2.all$Phase, levels = phase.sort)

# Add mean temperature for that trial to the slopes.r2.all file. 
slopes.r2.all$meanTemp <- mean(RMR$Temp)

# Add in time from start of file

trial.first<- ddply(slopes.r2.all,"DateTime", head,1)
slopes.r2.all$Time.m <- difftime(slopes.r2.all$DateTime, head(trial.first$DateTime,1), units="mins", tz = "America/Los_Angeles")

# As you go through the text files from autoresp, you can consecutively add all of the slopes data, etc. to the slopes.all file, which is your big giant master file with all the data. After I calculate the slopes & r2 etc. for each file, then load the morphometrics data file and merge them together based on FishId. Bind days together first, then everything. 
slopes.all <- rbind(slopes.all, slopes.r2.all)


# Plot
ggplot(slopes.r2.all, aes(x=DateTime, y=(-1*Slope)))+
  geom_point(aes(color=FishID))+
  theme_bw()

# Sort based on slope value for every fish: 

Fish1_sorted_slopes <- O2slope.r2.1[order(-O2slope.r2.1$Slope.hour),]

Fish2_sorted_slopes <- O2slope.r2.2[order(-O2slope.r2.2$Slope.hour),]

Fish3_sorted_slopes <- O2slope.r2.3[order(-O2slope.r2.3$Slope.hour),]

Fish4_sorted_slopes <- O2slope.r2.4[order(-O2slope.r2.4$Slope.hour),]

# Remove the first two measurement periods. We don't want to include the first chunk of time immediately post-handling because thats a priori information that the fish was stressed. 

Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M1', Phase))
Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M2', Phase))
Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M1   ', Phase))
Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M2   ', Phase))

Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M1', Phase))
Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M2', Phase))
Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M1   ', Phase))
Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M2   ', Phase))

Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M1', Phase))
Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M2', Phase))
Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M1   ', Phase))
Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M2   ', Phase))

Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M1', Phase))
Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M2', Phase))
Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M1   ', Phase))
Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M2   ', Phase))

# Average lowest three

Fish1avgslopehour <- mean(head(Fish1_sorted_slopes$Slope.hour, 3))
Fish1avgslope <- mean(head(Fish1_sorted_slopes$Slope, 3))
Fish1avgR2 <- mean(head(Fish1_sorted_slopes$r2, 3))

Fish1finalRMR <- matrix(c(Fish1, Fish1avgslope, Fish1avgslopehour, Fish1avgR2), nrow=1, ncol=4)

Fish2avgslopehour <- mean(head(Fish2_sorted_slopes$Slope.hour, 3))
Fish2avgslope <- mean(head(Fish2_sorted_slopes$Slope, 3))
Fish2avgR2 <- mean(head(Fish2_sorted_slopes$r2, 3))

Fish2finalRMR <- matrix(c(Fish2, Fish2avgslope, Fish2avgslopehour, Fish2avgR2), nrow=1, ncol=4)

Fish3avgslopehour <- mean(head(Fish3_sorted_slopes$Slope.hour, 3))
Fish3avgslope <- mean(head(Fish3_sorted_slopes$Slope, 3))
Fish3avgR2 <- mean(head(Fish3_sorted_slopes$r2, 3))

Fish3finalRMR <- matrix(c(Fish3, Fish3avgslope, Fish3avgslopehour, Fish3avgR2), nrow=1, ncol=4)

Fish4avgslopehour <- mean(head(Fish4_sorted_slopes$Slope.hour, 3))
Fish4avgslope <- mean(head(Fish4_sorted_slopes$Slope, 3))
Fish4avgR2 <- mean(head(Fish4_sorted_slopes$r2, 3))

Fish4finalRMR <- matrix(c(Fish4, Fish4avgslope, Fish4avgslopehour, Fish4avgR2), nrow=1, ncol=4)

# Bind all fish from this trial together: 
average.slopes <- rbind(Fish1finalRMR, Fish2finalRMR, Fish3finalRMR, Fish4finalRMR)

#Add mean temp of this trial to final file: 
average.slopes <- cbind(average.slopes, mean(RMR$Temp))
colnames(average.slopes) <- c("FishID", "FinalSlope", "FinalSlopeHour", "FinalR2", "meanTemp")

slopes.all.final <- rbind(average.slopes, slopes.all.final)

```

### Planktivores

#### D1_B1_P

```{r}
# Load txt file
RMR_raw <- readcleanplanktivore("2018_burbot_resp_D1_B1_P_raw.txt")

# Assign names for this trial: 

"Fish1" <- "D1_B1_P1"
"Fish2" <- "D1_B1_P2"
"Fish3" <- "D1_B1_P3"
"Fish4" <- "D1_B1_P4"

# Create a new column with the time in minutes from the start of the file: 

RMR_raw$Time.m <- sapply(seq_along(RMR_raw$DateTime),
function(i) as.numeric(difftime(RMR_raw$DateTime[i], RMR_raw$DateTime[1], units='mins')))


# Pull measure periods. Grep finds all of the data in the Phase column that contains the letter M. 

RMR <- RMR_raw[grep("M", RMR_raw$Phase), ]

# Pull out first value of each phase for graphing later
Phase.start <- ddply(RMR, "Phase", head, 1)
Phase.start <- Phase.start[,1:2]

# Change the column names of the chambers to the appropriate FishID:
Name.vec <- c(Fish1, Fish2, Fish3, Fish4)
names(RMR)[5:8] <- Name.vec


# Reshape the data so all O2 saturation values are in a single column:

RMR.2 <- melt(RMR, measure = Name.vec)

# Rename the columns. 
names(RMR.2) <-c("DateTime","Phase","Salinity","Temp","Time.m","FishID","O2.sat")

# Plot the measurement periods of all fish from this trial:
p=ggplot(data=RMR.2, aes(x=Time.m, y=O2.sat, group=Phase))
p+geom_point(aes(color=FishID))+theme_bw()


# Separate out individual fish for graphing/analysis:

## Separate each fish to it's own RMR file: 
Fish1_RMR <- filter(RMR.2, FishID == Fish1)
Fish2_RMR <- filter(RMR.2, FishID == Fish2)
Fish3_RMR <- filter(RMR.2, FishID == Fish3)
Fish4_RMR <- filter(RMR.2, FishID == Fish4)

# Determine length of measurment period because they vary between trials (ugh). I chose measurement period 5 so it's not in the first few measurement periods where we were switching them manually but not the last measurement period either in case it was cut short. 
(nrow(Fish1_RMR[Fish1_RMR$Phase == "M5",]))/60

# Determine total time in chambers (in hours) because this also slightly varied between trials (ugh). 
(nrow(RMR_raw))/60/60
```

```{r eval=FALSE}
## Plot individual measurement periods for each fish: 
p=ggplot(data=Fish1_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase), group=1)+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish1) 

p=ggplot(data=Fish2_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish2) 

p=ggplot(data=Fish3_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish3) 

p=ggplot(data=Fish4_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish4) 

##Plot individual measurement periods with the line of best fit:

p=ggplot(data=Fish1_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish1) 

p=ggplot(data=Fish2_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish2) 

p=ggplot(data=Fish3_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish3) 

p=ggplot(data=Fish4_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish4) 
```

```{r}
# Calculate slopes of lines for each fish and convert slope from minutes to hours:
O2slopel1 <- dlply(Fish1_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope1 <- ldply(O2slopel1, function(d) coef(d))
names(O2slope1) <- c("Phase", "Intercept","Slope")
O2slope1<- mutate(O2slope1, FishID = Fish1)
O2slope1<-ddply(O2slope1, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel2 <- dlply(Fish2_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope2 <- ldply(O2slopel2, function(d) coef(d))
names(O2slope2) <- c("Phase", "Intercept","Slope")
O2slope2 <- mutate(O2slope2, FishID = Fish2)
O2slope2<-ddply(O2slope2, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel3 <- dlply(Fish3_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope3 <- ldply(O2slopel3, function(d) coef(d))
names(O2slope3) <- c("Phase", "Intercept","Slope")
O2slope3 <- mutate(O2slope3, FishID = Fish3)
O2slope3<-ddply(O2slope3, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel4 <- dlply(Fish4_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope4 <- ldply(O2slopel4, function(d) coef(d))
names(O2slope4) <- c("Phase", "Intercept","Slope")
O2slope4 <- mutate(O2slope4, FishID = Fish4)
O2slope4<-ddply(O2slope4, .(Phase), mutate, Slope.hour=Slope*60)


# Calculating the fit of each slope: 
O2.r2.1 <- dlply(Fish1_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit1<-ldply(O2.r2.1, function(d) d$r.squared)
slopefit1
names(slopefit1) <-c("Phase","r2")

O2.r2.2 <- dlply(Fish2_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit2<-ldply(O2.r2.2, function(d) d$r.squared)
slopefit2
names(slopefit2) <-c("Phase","r2")

O2.r2.3 <- dlply(Fish3_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit3<-ldply(O2.r2.3, function(d) d$r.squared)
slopefit3
names(slopefit3) <-c("Phase","r2")

O2.r2.4 <- dlply(Fish4_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit4<-ldply(O2.r2.4, function(d) d$r.squared)
slopefit4
names(slopefit4) <-c("Phase","r2")


# merge together slope and r2:
O2slope.r2.1<-merge(O2slope1, slopefit1, by=c("Phase"))
O2slope.r2.1<- O2slope.r2.1[mixedorder(O2slope.r2.1$Phase),]
O2slope.r2.1

O2slope.r2.2<-merge(O2slope2, slopefit2, by=c("Phase"))
O2slope.r2.2<- O2slope.r2.2[mixedorder(O2slope.r2.2$Phase),]
O2slope.r2.2

O2slope.r2.3<-merge(O2slope3, slopefit3, by=c("Phase"))
O2slope.r2.3<- O2slope.r2.3[mixedorder(O2slope.r2.3$Phase),]
O2slope.r2.3

O2slope.r2.4<-merge(O2slope4, slopefit4, by=c("Phase"))
O2slope.r2.4<- O2slope.r2.4[mixedorder(O2slope.r2.4$Phase),]
O2slope.r2.4

# bind all slope and r2 dataframes and sort the phases so they're in order:
slopes.r2.all <- rbind(O2slope.r2.1,O2slope.r2.2,O2slope.r2.3,O2slope.r2.4)
slopes.r2.all <- merge(slopes.r2.all, Phase.start, by=c("Phase"))
phase.sort <- unique(mixedsort(slopes.r2.all$Phase))
slopes.r2.all$Phase <- factor(slopes.r2.all$Phase, levels = phase.sort)

# Add mean temperature for that trial to the slopes.r2.all file. 
slopes.r2.all$meanTemp <- mean(RMR$Temp)

# Add in time from start of file

trial.first<- ddply(slopes.r2.all,"DateTime", head,1)
slopes.r2.all$Time.m <- difftime(slopes.r2.all$DateTime, head(trial.first$DateTime,1), units="mins", tz = "America/Los_Angeles")

# As you go through the text files from autoresp, you can consecutively add all of the slopes data, etc. to the slopes.all file, which is your big giant master file with all the data. After I calculate the slopes & r2 etc. for each file, then load the morphometrics data file and merge them together based on FishId. Bind days together first, then everything. 
slopes.all <- rbind(slopes.all, slopes.r2.all)

# Plot
ggplot(slopes.r2.all, aes(x=DateTime, y=Slope))+
  geom_point(aes(color=FishID))+
  theme_bw()


# Sort based on slope value for every fish: 

Fish1_sorted_slopes <- O2slope.r2.1[order(-O2slope.r2.1$Slope.hour),]

Fish2_sorted_slopes <- O2slope.r2.2[order(-O2slope.r2.2$Slope.hour),]

Fish3_sorted_slopes <- O2slope.r2.3[order(-O2slope.r2.3$Slope.hour),]

Fish4_sorted_slopes <- O2slope.r2.4[order(-O2slope.r2.4$Slope.hour),]

# Remove the first two measurement periods. We don't want to include the first chunk of time immediately post-handling because thats a priori information that the fish was stressed. 

Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M1', Phase))
Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M2', Phase))
Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M1   ', Phase))
Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M2   ', Phase))

Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M1', Phase))
Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M2', Phase))
Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M1   ', Phase))
Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M2   ', Phase))

Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M1', Phase))
Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M2', Phase))
Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M1   ', Phase))
Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M2   ', Phase))

Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M1', Phase))
Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M2', Phase))
Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M1   ', Phase))
Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M2   ', Phase))

# Average lowest three

Fish1avgslopehour <- mean(head(Fish1_sorted_slopes$Slope.hour, 3))
Fish1avgslope <- mean(head(Fish1_sorted_slopes$Slope, 3))
Fish1avgR2 <- mean(head(Fish1_sorted_slopes$r2, 3))

Fish1finalRMR <- matrix(c(Fish1, Fish1avgslope, Fish1avgslopehour, Fish1avgR2), nrow=1, ncol=4)

Fish2avgslopehour <- mean(head(Fish2_sorted_slopes$Slope.hour, 3))
Fish2avgslope <- mean(head(Fish2_sorted_slopes$Slope, 3))
Fish2avgR2 <- mean(head(Fish2_sorted_slopes$r2, 3))

Fish2finalRMR <- matrix(c(Fish2, Fish2avgslope, Fish2avgslopehour, Fish2avgR2), nrow=1, ncol=4)

Fish3avgslopehour <- mean(head(Fish3_sorted_slopes$Slope.hour, 3))
Fish3avgslope <- mean(head(Fish3_sorted_slopes$Slope, 3))
Fish3avgR2 <- mean(head(Fish3_sorted_slopes$r2, 3))

Fish3finalRMR <- matrix(c(Fish3, Fish3avgslope, Fish3avgslopehour, Fish3avgR2), nrow=1, ncol=4)

Fish4avgslopehour <- mean(head(Fish4_sorted_slopes$Slope.hour, 3))
Fish4avgslope <- mean(head(Fish4_sorted_slopes$Slope, 3))
Fish4avgR2 <- mean(head(Fish4_sorted_slopes$r2, 3))

Fish4finalRMR <- matrix(c(Fish4, Fish4avgslope, Fish4avgslopehour, Fish4avgR2), nrow=1, ncol=4)

# Bind all fish from this trial together: 
average.slopes <- rbind(Fish1finalRMR, Fish2finalRMR, Fish3finalRMR, Fish4finalRMR)

#Add mean temp of this trial to final file: 
average.slopes <- cbind(average.slopes, mean(RMR$Temp))
colnames(average.slopes) <- c("FishID", "FinalSlope", "FinalSlopeHour", "FinalR2", "meanTemp")

slopes.all.final <- rbind(average.slopes, slopes.all.final)

```

#### D1_B2_P

```{r}
# Load txt file
RMR_raw <- readcleanplanktivore("2018_burbot_resp_D1_B2_P_raw.txt")

# Assign names for this trial:

"Fish1" <- "D1_B2_P1"
"Fish2" <- "D1_B2_P2"
"Fish3" <- "D1_B2_P3"
"Fish4" <- "D1_B2_P4"

# Create a new column with the time in minutes from the start of the file: 

RMR_raw$Time.m <- sapply(seq_along(RMR_raw$DateTime),
function(i) as.numeric(difftime(RMR_raw$DateTime[i], RMR_raw$DateTime[1], units='mins')))


# Pull measure periods. Grep finds all of the data in the Phase column that contains the letter M. 

RMR <- RMR_raw[grep("M", RMR_raw$Phase), ]


# Pull out first value of each phase for graphing later
Phase.start <- ddply(RMR, "Phase", head, 1)
Phase.start <- Phase.start[,1:2]


# Change the column names of the chambers to the appropriate FishID:
Name.vec <- c(Fish1, Fish2, Fish3, Fish4)
names(RMR)[5:8] <- Name.vec


# Reshape the data so all O2 saturation values are in a single column:

RMR.2 <- melt(RMR, measure = Name.vec)

# Rename the columns. 
names(RMR.2) <-c("DateTime","Phase","Salinity","Temp","Time.m","FishID","O2.sat")


# Plot the measurement periods of all fish from this trial:
p=ggplot(data=RMR.2, aes(x=Time.m, y=O2.sat, group=Phase))
p+geom_point(aes(color=FishID))+theme_bw()


# Separate out individual fish for graphing/analysis:

## Separate each fish to it's own RMR file: 
Fish1_RMR <- filter(RMR.2, FishID == Fish1)
Fish2_RMR <- filter(RMR.2, FishID == Fish2)
Fish3_RMR <- filter(RMR.2, FishID == Fish3)
Fish4_RMR <- filter(RMR.2, FishID == Fish4)

# Determine length of measurment period because they vary between trials (ugh). I chose measurement period 5 so it's not in the first few measurement periods where we were switching them manually but not the last measurement period either in case it was cut short. 
(nrow(Fish1_RMR[Fish1_RMR$Phase == "M5",]))/60

# Determine total time in chambers (in hours) because this also slightly varied between trials (ugh). 
(nrow(RMR_raw))/60/60
```

```{r eval=FALSE}
## Plot individual measurement periods for each fish: 
p=ggplot(data=Fish1_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase), group=1)+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish1) 

p=ggplot(data=Fish2_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish2) 

p=ggplot(data=Fish3_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish3) 

p=ggplot(data=Fish4_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish4) 

##Plot individual measurement periods with the line of best fit:

p=ggplot(data=Fish1_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish1) 

p=ggplot(data=Fish2_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish2) 

p=ggplot(data=Fish3_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish3) 

p=ggplot(data=Fish4_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish4) 
```

```{r}
# Calculate slopes of lines for each fish and convert slope from minutes to hours:
O2slopel1 <- dlply(Fish1_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope1 <- ldply(O2slopel1, function(d) coef(d))
names(O2slope1) <- c("Phase", "Intercept","Slope")
O2slope1<- mutate(O2slope1, FishID = Fish1)
O2slope1<-ddply(O2slope1, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel2 <- dlply(Fish2_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope2 <- ldply(O2slopel2, function(d) coef(d))
names(O2slope2) <- c("Phase", "Intercept","Slope")
O2slope2 <- mutate(O2slope2, FishID = Fish2)
O2slope2<-ddply(O2slope2, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel3 <- dlply(Fish3_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope3 <- ldply(O2slopel3, function(d) coef(d))
names(O2slope3) <- c("Phase", "Intercept","Slope")
O2slope3 <- mutate(O2slope3, FishID = Fish3)
O2slope3<-ddply(O2slope3, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel4 <- dlply(Fish4_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope4 <- ldply(O2slopel4, function(d) coef(d))
names(O2slope4) <- c("Phase", "Intercept","Slope")
O2slope4 <- mutate(O2slope4, FishID = Fish4)
O2slope4<-ddply(O2slope4, .(Phase), mutate, Slope.hour=Slope*60)


# Calculating the fit of each slope: 
O2.r2.1 <- dlply(Fish1_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit1<-ldply(O2.r2.1, function(d) d$r.squared)
slopefit1
names(slopefit1) <-c("Phase","r2")

O2.r2.2 <- dlply(Fish2_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit2<-ldply(O2.r2.2, function(d) d$r.squared)
slopefit2
names(slopefit2) <-c("Phase","r2")

O2.r2.3 <- dlply(Fish3_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit3<-ldply(O2.r2.3, function(d) d$r.squared)
slopefit3
names(slopefit3) <-c("Phase","r2")

O2.r2.4 <- dlply(Fish4_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit4<-ldply(O2.r2.4, function(d) d$r.squared)
slopefit4
names(slopefit4) <-c("Phase","r2")


# merge together slope and r2:
O2slope.r2.1<-merge(O2slope1, slopefit1, by=c("Phase"))
O2slope.r2.1<- O2slope.r2.1[mixedorder(O2slope.r2.1$Phase),]
O2slope.r2.1

O2slope.r2.2<-merge(O2slope2, slopefit2, by=c("Phase"))
O2slope.r2.2<- O2slope.r2.2[mixedorder(O2slope.r2.2$Phase),]
O2slope.r2.2

O2slope.r2.3<-merge(O2slope3, slopefit3, by=c("Phase"))
O2slope.r2.3<- O2slope.r2.3[mixedorder(O2slope.r2.3$Phase),]
O2slope.r2.3

O2slope.r2.4<-merge(O2slope4, slopefit4, by=c("Phase"))
O2slope.r2.4<- O2slope.r2.4[mixedorder(O2slope.r2.4$Phase),]
O2slope.r2.4

# bind all slope and r2 dataframes and sort the phases so they're in order:
slopes.r2.all <- rbind(O2slope.r2.1,O2slope.r2.2,O2slope.r2.3,O2slope.r2.4)
slopes.r2.all <- merge(slopes.r2.all, Phase.start, by=c("Phase"))
phase.sort <- unique(mixedsort(slopes.r2.all$Phase))
slopes.r2.all$Phase <- factor(slopes.r2.all$Phase, levels = phase.sort)


# Add mean temperature for that trial to the slopes.r2.all file. 
slopes.r2.all$meanTemp <- mean(RMR$Temp)

# Add in time from start of file

trial.first<- ddply(slopes.r2.all,"DateTime", head,1)
slopes.r2.all$Time.m <- difftime(slopes.r2.all$DateTime, head(trial.first$DateTime,1), units="mins", tz = "America/Los_Angeles")

# As you go through the text files from autoresp, you can consecutively add all of the slopes data, etc. to the slopes.all file, which is your big giant master file with all the data. After I calculate the slopes & r2 etc. for each file, then load the morphometrics data file and merge them together based on FishId. Bind days together first, then everything. 
slopes.all <- rbind(slopes.all, slopes.r2.all)


# Plot
ggplot(slopes.r2.all, aes(x=DateTime, y=Slope))+
  geom_point(aes(color=FishID))+
  theme_bw()

# Sort based on slope value for every fish: 

Fish1_sorted_slopes <- O2slope.r2.1[order(-O2slope.r2.1$Slope.hour),]

Fish2_sorted_slopes <- O2slope.r2.2[order(-O2slope.r2.2$Slope.hour),]

Fish3_sorted_slopes <- O2slope.r2.3[order(-O2slope.r2.3$Slope.hour),]

Fish4_sorted_slopes <- O2slope.r2.4[order(-O2slope.r2.4$Slope.hour),]

# Remove the first two measurement periods. We don't want to include the first chunk of time immediately post-handling because thats a priori information that the fish was stressed. 

Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M1', Phase))
Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M2', Phase))
Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M1   ', Phase))
Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M2   ', Phase))

Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M1', Phase))
Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M2', Phase))
Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M1   ', Phase))
Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M2   ', Phase))

Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M1', Phase))
Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M2', Phase))
Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M1   ', Phase))
Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M2   ', Phase))

Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M1', Phase))
Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M2', Phase))
Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M1   ', Phase))
Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M2   ', Phase))

# Average lowest three

Fish1avgslopehour <- mean(head(Fish1_sorted_slopes$Slope.hour, 3))
Fish1avgslope <- mean(head(Fish1_sorted_slopes$Slope, 3))
Fish1avgR2 <- mean(head(Fish1_sorted_slopes$r2, 3))

Fish1finalRMR <- matrix(c(Fish1, Fish1avgslope, Fish1avgslopehour, Fish1avgR2), nrow=1, ncol=4)

Fish2avgslopehour <- mean(head(Fish2_sorted_slopes$Slope.hour, 3))
Fish2avgslope <- mean(head(Fish2_sorted_slopes$Slope, 3))
Fish2avgR2 <- mean(head(Fish2_sorted_slopes$r2, 3))

Fish2finalRMR <- matrix(c(Fish2, Fish2avgslope, Fish2avgslopehour, Fish2avgR2), nrow=1, ncol=4)

Fish3avgslopehour <- mean(head(Fish3_sorted_slopes$Slope.hour, 3))
Fish3avgslope <- mean(head(Fish3_sorted_slopes$Slope, 3))
Fish3avgR2 <- mean(head(Fish3_sorted_slopes$r2, 3))

Fish3finalRMR <- matrix(c(Fish3, Fish3avgslope, Fish3avgslopehour, Fish3avgR2), nrow=1, ncol=4)

Fish4avgslopehour <- mean(head(Fish4_sorted_slopes$Slope.hour, 3))
Fish4avgslope <- mean(head(Fish4_sorted_slopes$Slope, 3))
Fish4avgR2 <- mean(head(Fish4_sorted_slopes$r2, 3))

Fish4finalRMR <- matrix(c(Fish4, Fish4avgslope, Fish4avgslopehour, Fish4avgR2), nrow=1, ncol=4)

# Bind all fish from this trial together: 
average.slopes <- rbind(Fish1finalRMR, Fish2finalRMR, Fish3finalRMR, Fish4finalRMR)

#Add mean temp of this trial to final file: 
average.slopes <- cbind(average.slopes, mean(RMR$Temp))
colnames(average.slopes) <- c("FishID", "FinalSlope", "FinalSlopeHour", "FinalR2", "meanTemp")

slopes.all.final <- rbind(average.slopes, slopes.all.final)
```

#### D1_B3_P

```{r}
# Load txt file
RMR_raw <- readcleanplanktivore("2018_burbot_resp_D1_B3_P_raw.txt")

# Assign names for this trial: 

"Fish1" <- "D1_B3_P1"
"Fish2" <- "D1_B3_P2"
"Fish3" <- "D1_B3_P3"
"Fish4" <- "D1_B3_P4"

# Create a new column with the time in minutes from the start of the file: 

RMR_raw$Time.m <- sapply(seq_along(RMR_raw$DateTime),
function(i) as.numeric(difftime(RMR_raw$DateTime[i], RMR_raw$DateTime[1], units='mins')))


# Pull measure periods. Grep finds all of the data in the Phase column that contains the letter M. 

RMR <- RMR_raw[grep("M", RMR_raw$Phase), ]

# Pull out first value of each phase for graphing later
Phase.start <- ddply(RMR, "Phase", head, 1)
Phase.start <- Phase.start[,1:2]


# Change the column names of the chambers to the appropriate FishID:
Name.vec <- c(Fish1, Fish2, Fish3, Fish4)
names(RMR)[5:8] <- Name.vec


# Reshape the data so all O2 saturation values are in a single column:

RMR.2 <- melt(RMR, measure = Name.vec)

# Rename the columns. 
names(RMR.2) <-c("DateTime","Phase","Salinity","Temp","Time.m","FishID","O2.sat")

# Plot the measurement periods of all fish from this trial:
p=ggplot(data=RMR.2, aes(x=Time.m, y=O2.sat, group=Phase))
p+geom_point(aes(color=FishID))+theme_bw()


# Separate out individual fish for graphing/analysis:

## Separate each fish to it's own RMR file: 
Fish1_RMR <- filter(RMR.2, FishID == Fish1)
Fish2_RMR <- filter(RMR.2, FishID == Fish2)
Fish3_RMR <- filter(RMR.2, FishID == Fish3)
Fish4_RMR <- filter(RMR.2, FishID == Fish4)

# Determine length of measurment period because they vary between trials (ugh). I chose measurement period 5 so it's not in the first few measurement periods where we were switching them manually but not the last measurement period either in case it was cut short. 
(nrow(Fish1_RMR[Fish1_RMR$Phase == "M5   ",]))/60

# Determine total time in chambers (in hours) because this also slightly varied between trials (ugh). 
(nrow(RMR_raw))/60/60
```

```{r eval=FALSE}
## Plot individual measurement periods for each fish: 
p=ggplot(data=Fish1_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase), group=1)+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish1) 

p=ggplot(data=Fish2_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish2) 

p=ggplot(data=Fish3_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish3) 

p=ggplot(data=Fish4_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish4) 

##Plot individual measurement periods with the line of best fit: 

p=ggplot(data=Fish1_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish1) 

p=ggplot(data=Fish2_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish2) 

p=ggplot(data=Fish3_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish3) 

p=ggplot(data=Fish4_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish4) 
```

```{r}
# Calculate slopes of lines for each fish and convert slope from minutes to hours:
O2slopel1 <- dlply(Fish1_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope1 <- ldply(O2slopel1, function(d) coef(d))
names(O2slope1) <- c("Phase", "Intercept","Slope")
O2slope1<- mutate(O2slope1, FishID = Fish1)
O2slope1<-ddply(O2slope1, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel2 <- dlply(Fish2_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope2 <- ldply(O2slopel2, function(d) coef(d))
names(O2slope2) <- c("Phase", "Intercept","Slope")
O2slope2 <- mutate(O2slope2, FishID = Fish2)
O2slope2<-ddply(O2slope2, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel3 <- dlply(Fish3_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope3 <- ldply(O2slopel3, function(d) coef(d))
names(O2slope3) <- c("Phase", "Intercept","Slope")
O2slope3 <- mutate(O2slope3, FishID = Fish3)
O2slope3<-ddply(O2slope3, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel4 <- dlply(Fish4_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope4 <- ldply(O2slopel4, function(d) coef(d))
names(O2slope4) <- c("Phase", "Intercept","Slope")
O2slope4 <- mutate(O2slope4, FishID = Fish4)
O2slope4<-ddply(O2slope4, .(Phase), mutate, Slope.hour=Slope*60)


# Calculating the fit of each slope: 
O2.r2.1 <- dlply(Fish1_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit1<-ldply(O2.r2.1, function(d) d$r.squared)
slopefit1
names(slopefit1) <-c("Phase","r2")

O2.r2.2 <- dlply(Fish2_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit2<-ldply(O2.r2.2, function(d) d$r.squared)
slopefit2
names(slopefit2) <-c("Phase","r2")

O2.r2.3 <- dlply(Fish3_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit3<-ldply(O2.r2.3, function(d) d$r.squared)
slopefit3
names(slopefit3) <-c("Phase","r2")

O2.r2.4 <- dlply(Fish4_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit4<-ldply(O2.r2.4, function(d) d$r.squared)
slopefit4
names(slopefit4) <-c("Phase","r2")


# merge together slope and r2:
O2slope.r2.1<-merge(O2slope1, slopefit1, by=c("Phase"))
O2slope.r2.1<- O2slope.r2.1[mixedorder(O2slope.r2.1$Phase),]
O2slope.r2.1

O2slope.r2.2<-merge(O2slope2, slopefit2, by=c("Phase"))
O2slope.r2.2<- O2slope.r2.2[mixedorder(O2slope.r2.2$Phase),]
O2slope.r2.2

O2slope.r2.3<-merge(O2slope3, slopefit3, by=c("Phase"))
O2slope.r2.3<- O2slope.r2.3[mixedorder(O2slope.r2.3$Phase),]
O2slope.r2.3

O2slope.r2.4<-merge(O2slope4, slopefit4, by=c("Phase"))
O2slope.r2.4<- O2slope.r2.4[mixedorder(O2slope.r2.4$Phase),]
O2slope.r2.4

# bind all slope and r2 dataframes and sort the phases so they're in order:
slopes.r2.all <- rbind(O2slope.r2.1,O2slope.r2.2,O2slope.r2.3,O2slope.r2.4)
slopes.r2.all <- merge(slopes.r2.all, Phase.start, by=c("Phase"))
phase.sort <- unique(mixedsort(slopes.r2.all$Phase))
slopes.r2.all$Phase <- factor(slopes.r2.all$Phase, levels = phase.sort)


# Add mean temperature for that trial to the slopes.r2.all file. 
slopes.r2.all$meanTemp <- mean(RMR$Temp)

# Add in time from start of file

trial.first<- ddply(slopes.r2.all,"DateTime", head,1)
slopes.r2.all$Time.m <- difftime(slopes.r2.all$DateTime, head(trial.first$DateTime,1), units="mins", tz = "America/Los_Angeles")

# As you go through the text files from autoresp, you can consecutively add all of the slopes data, etc. to the slopes.all file, which is your big giant master file with all the data. After I calculate the slopes & r2 etc. for each file, then load the morphometrics data file and merge them together based on FishId. Bind days together first, then everything. 
slopes.all <- rbind(slopes.all, slopes.r2.all)


# Plot
ggplot(slopes.r2.all, aes(x=DateTime, y=Slope))+
  geom_point(aes(color=FishID))+
  theme_bw()


# Sort based on slope value for every fish: 

Fish1_sorted_slopes <- O2slope.r2.1[order(-O2slope.r2.1$Slope.hour),]

Fish2_sorted_slopes <- O2slope.r2.2[order(-O2slope.r2.2$Slope.hour),]

Fish3_sorted_slopes <- O2slope.r2.3[order(-O2slope.r2.3$Slope.hour),]

Fish4_sorted_slopes <- O2slope.r2.4[order(-O2slope.r2.4$Slope.hour),]

# Remove the first two measurement periods. We don't want to include the first chunk of time immediately post-handling because thats a priori information that the fish was stressed. 

Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M1', Phase))
Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M2', Phase))
Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M1   ', Phase))
Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M2   ', Phase))

Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M1', Phase))
Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M2', Phase))
Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M1   ', Phase))
Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M2   ', Phase))

Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M1', Phase))
Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M2', Phase))
Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M1   ', Phase))
Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M2   ', Phase))

Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M1', Phase))
Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M2', Phase))
Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M1   ', Phase))
Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M2   ', Phase))

# Average lowest three

Fish1avgslopehour <- mean(head(Fish1_sorted_slopes$Slope.hour, 3))
Fish1avgslope <- mean(head(Fish1_sorted_slopes$Slope, 3))
Fish1avgR2 <- mean(head(Fish1_sorted_slopes$r2, 3))

Fish1finalRMR <- matrix(c(Fish1, Fish1avgslope, Fish1avgslopehour, Fish1avgR2), nrow=1, ncol=4)

Fish2avgslopehour <- mean(head(Fish2_sorted_slopes$Slope.hour, 3))
Fish2avgslope <- mean(head(Fish2_sorted_slopes$Slope, 3))
Fish2avgR2 <- mean(head(Fish2_sorted_slopes$r2, 3))

Fish2finalRMR <- matrix(c(Fish2, Fish2avgslope, Fish2avgslopehour, Fish2avgR2), nrow=1, ncol=4)

Fish3avgslopehour <- mean(head(Fish3_sorted_slopes$Slope.hour, 3))
Fish3avgslope <- mean(head(Fish3_sorted_slopes$Slope, 3))
Fish3avgR2 <- mean(head(Fish3_sorted_slopes$r2, 3))

Fish3finalRMR <- matrix(c(Fish3, Fish3avgslope, Fish3avgslopehour, Fish3avgR2), nrow=1, ncol=4)

Fish4avgslopehour <- mean(head(Fish4_sorted_slopes$Slope.hour, 3))
Fish4avgslope <- mean(head(Fish4_sorted_slopes$Slope, 3))
Fish4avgR2 <- mean(head(Fish4_sorted_slopes$r2, 3))

Fish4finalRMR <- matrix(c(Fish4, Fish4avgslope, Fish4avgslopehour, Fish4avgR2), nrow=1, ncol=4)

# Bind all fish from this trial together: 
average.slopes <- rbind(Fish1finalRMR, Fish2finalRMR, Fish3finalRMR, Fish4finalRMR)

#Add mean temp of this trial to final file: 
average.slopes <- cbind(average.slopes, mean(RMR$Temp))
colnames(average.slopes) <- c("FishID", "FinalSlope", "FinalSlopeHour", "FinalR2", "meanTemp")

slopes.all.final <- rbind(average.slopes, slopes.all.final)
```

#### D2_B1_P

```{r}
# Load txt file
RMR_raw <- readcleanplanktivore("2018_burbot_resp_D2_B1_P_raw.txt")

# Assign names for this trial: 

"Fish1" <- "D2_B1_P1"
"Fish2" <- "D2_B1_P2"
"Fish3" <- "D2_B1_P3"
"Fish4" <- "D2_B1_P4"

# Create a new column with the time in minutes from the start of the file: 

RMR_raw$Time.m <- sapply(seq_along(RMR_raw$DateTime),
function(i) as.numeric(difftime(RMR_raw$DateTime[i], RMR_raw$DateTime[1], units='mins')))


# Pull measure periods. Grep finds all of the data in the Phase column that contains the letter M. 

RMR <- RMR_raw[grep("M", RMR_raw$Phase), ]


# Pull out first value of each phase for graphing later
Phase.start <- ddply(RMR, "Phase", head, 1)
Phase.start <- Phase.start[,1:2]


# Change the column names of the chambers to the appropriate FishID:
Name.vec <- c(Fish1, Fish2, Fish3, Fish4)
names(RMR)[5:8] <- Name.vec


# Reshape the data so all O2 saturation values are in a single column:

RMR.2 <- melt(RMR, measure = Name.vec)

# Rename the columns. 
names(RMR.2) <-c("DateTime","Phase","Salinity","Temp","Time.m","FishID","O2.sat")

# Plot the measurement periods of all fish from this trial:
p=ggplot(data=RMR.2, aes(x=Time.m, y=O2.sat, group=Phase))
p+geom_point(aes(color=FishID))+theme_bw()


# Separate out individual fish for graphing/analysis:

## Separate each fish to it's own RMR file: 
Fish1_RMR <- filter(RMR.2, FishID == Fish1)
Fish2_RMR <- filter(RMR.2, FishID == Fish2)
Fish3_RMR <- filter(RMR.2, FishID == Fish3)
Fish4_RMR <- filter(RMR.2, FishID == Fish4)

# Determine length of measurment period because they vary between trials (ugh). I chose measurement period 5 so it's not in the first few measurement periods where we were switching them manually but not the last measurement period either in case it was cut short. 
(nrow(Fish1_RMR[Fish1_RMR$Phase == "M5",]))/60

# Determine total time in chambers (in hours) because this also slightly varied between trials (ugh). 
(nrow(RMR_raw))/60/60
```

```{r eval=FALSE}
## Plot individual measurement periods for each fish: 
p=ggplot(data=Fish1_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase), group=1)+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish1) 

p=ggplot(data=Fish2_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish2) 

p=ggplot(data=Fish3_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish3) 

p=ggplot(data=Fish4_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish4) 

##Plot individual measurement periods with the line of best fit: 

p=ggplot(data=Fish1_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish1) 

p=ggplot(data=Fish2_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish2) 

p=ggplot(data=Fish3_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish3) 

p=ggplot(data=Fish4_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish4) 
```

```{r}
# Calculate slopes of lines for each fish and convert slope from minutes to hours:
O2slopel1 <- dlply(Fish1_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope1 <- ldply(O2slopel1, function(d) coef(d))
names(O2slope1) <- c("Phase", "Intercept","Slope")
O2slope1<- mutate(O2slope1, FishID = Fish1)
O2slope1<-ddply(O2slope1, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel2 <- dlply(Fish2_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope2 <- ldply(O2slopel2, function(d) coef(d))
names(O2slope2) <- c("Phase", "Intercept","Slope")
O2slope2 <- mutate(O2slope2, FishID = Fish2)
O2slope2<-ddply(O2slope2, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel3 <- dlply(Fish3_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope3 <- ldply(O2slopel3, function(d) coef(d))
names(O2slope3) <- c("Phase", "Intercept","Slope")
O2slope3 <- mutate(O2slope3, FishID = Fish3)
O2slope3<-ddply(O2slope3, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel4 <- dlply(Fish4_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope4 <- ldply(O2slopel4, function(d) coef(d))
names(O2slope4) <- c("Phase", "Intercept","Slope")
O2slope4 <- mutate(O2slope4, FishID = Fish4)
O2slope4<-ddply(O2slope4, .(Phase), mutate, Slope.hour=Slope*60)


# Calculating the fit of each slope: 
O2.r2.1 <- dlply(Fish1_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit1<-ldply(O2.r2.1, function(d) d$r.squared)
slopefit1
names(slopefit1) <-c("Phase","r2")

O2.r2.2 <- dlply(Fish2_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit2<-ldply(O2.r2.2, function(d) d$r.squared)
slopefit2
names(slopefit2) <-c("Phase","r2")

O2.r2.3 <- dlply(Fish3_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit3<-ldply(O2.r2.3, function(d) d$r.squared)
slopefit3
names(slopefit3) <-c("Phase","r2")

O2.r2.4 <- dlply(Fish4_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit4<-ldply(O2.r2.4, function(d) d$r.squared)
slopefit4
names(slopefit4) <-c("Phase","r2")


# merge together slope and r2:
O2slope.r2.1<-merge(O2slope1, slopefit1, by=c("Phase"))
O2slope.r2.1<- O2slope.r2.1[mixedorder(O2slope.r2.1$Phase),]
O2slope.r2.1

O2slope.r2.2<-merge(O2slope2, slopefit2, by=c("Phase"))
O2slope.r2.2<- O2slope.r2.2[mixedorder(O2slope.r2.2$Phase),]
O2slope.r2.2

O2slope.r2.3<-merge(O2slope3, slopefit3, by=c("Phase"))
O2slope.r2.3<- O2slope.r2.3[mixedorder(O2slope.r2.3$Phase),]
O2slope.r2.3

O2slope.r2.4<-merge(O2slope4, slopefit4, by=c("Phase"))
O2slope.r2.4<- O2slope.r2.4[mixedorder(O2slope.r2.4$Phase),]
O2slope.r2.4

# bind all slope and r2 dataframes and sort the phases so they're in order:
slopes.r2.all <- rbind(O2slope.r2.1,O2slope.r2.2,O2slope.r2.3,O2slope.r2.4)
slopes.r2.all <- merge(slopes.r2.all, Phase.start, by=c("Phase"))
phase.sort <- unique(mixedsort(slopes.r2.all$Phase))
slopes.r2.all$Phase <- factor(slopes.r2.all$Phase, levels = phase.sort)


# Add mean temperature for that trial to the slopes.r2.all file. 
slopes.r2.all$meanTemp <- mean(RMR$Temp)

# Add in time from start of file

trial.first<- ddply(slopes.r2.all,"DateTime", head,1)
slopes.r2.all$Time.m <- difftime(slopes.r2.all$DateTime, head(trial.first$DateTime,1), units="mins", tz = "America/Los_Angeles")

# As you go through the text files from autoresp, you can consecutively add all of the slopes data, etc. to the slopes.all file, which is your big giant master file with all the data. After I calculate the slopes & r2 etc. for each file, then load the morphometrics data file and merge them together based on FishId. Bind days together first, then everything. 
slopes.all <- rbind(slopes.all, slopes.r2.all)


# Plot
ggplot(slopes.r2.all, aes(x=DateTime, y=(-1*Slope)))+
  geom_point(aes(color=FishID))+
  theme_bw()


# Sort based on slope value for every fish: 

Fish1_sorted_slopes <- O2slope.r2.1[order(-O2slope.r2.1$Slope.hour),]

Fish2_sorted_slopes <- O2slope.r2.2[order(-O2slope.r2.2$Slope.hour),]

Fish3_sorted_slopes <- O2slope.r2.3[order(-O2slope.r2.3$Slope.hour),]

Fish4_sorted_slopes <- O2slope.r2.4[order(-O2slope.r2.4$Slope.hour),]

# Remove the first two measurement periods. We don't want to include the first chunk of time immediately post-handling because thats a priori information that the fish was stressed. 

Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M1', Phase))
Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M2', Phase))
Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M1   ', Phase))
Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M2   ', Phase))

Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M1', Phase))
Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M2', Phase))
Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M1   ', Phase))
Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M2   ', Phase))

Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M1', Phase))
Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M2', Phase))
Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M1   ', Phase))
Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M2   ', Phase))

Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M1', Phase))
Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M2', Phase))
Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M1   ', Phase))
Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M2   ', Phase))

# Average lowest three

Fish1avgslopehour <- mean(head(Fish1_sorted_slopes$Slope.hour, 3))
Fish1avgslope <- mean(head(Fish1_sorted_slopes$Slope, 3))
Fish1avgR2 <- mean(head(Fish1_sorted_slopes$r2, 3))

Fish1finalRMR <- matrix(c(Fish1, Fish1avgslope, Fish1avgslopehour, Fish1avgR2), nrow=1, ncol=4)

Fish2avgslopehour <- mean(head(Fish2_sorted_slopes$Slope.hour, 3))
Fish2avgslope <- mean(head(Fish2_sorted_slopes$Slope, 3))
Fish2avgR2 <- mean(head(Fish2_sorted_slopes$r2, 3))

Fish2finalRMR <- matrix(c(Fish2, Fish2avgslope, Fish2avgslopehour, Fish2avgR2), nrow=1, ncol=4)

Fish3avgslopehour <- mean(head(Fish3_sorted_slopes$Slope.hour, 3))
Fish3avgslope <- mean(head(Fish3_sorted_slopes$Slope, 3))
Fish3avgR2 <- mean(head(Fish3_sorted_slopes$r2, 3))

Fish3finalRMR <- matrix(c(Fish3, Fish3avgslope, Fish3avgslopehour, Fish3avgR2), nrow=1, ncol=4)

Fish4avgslopehour <- mean(head(Fish4_sorted_slopes$Slope.hour, 3))
Fish4avgslope <- mean(head(Fish4_sorted_slopes$Slope, 3))
Fish4avgR2 <- mean(head(Fish4_sorted_slopes$r2, 3))

Fish4finalRMR <- matrix(c(Fish4, Fish4avgslope, Fish4avgslopehour, Fish4avgR2), nrow=1, ncol=4)

# Bind all fish from this trial together: 
average.slopes <- rbind(Fish1finalRMR, Fish2finalRMR, Fish3finalRMR, Fish4finalRMR)

#Add mean temp of this trial to final file: 
average.slopes <- cbind(average.slopes, mean(RMR$Temp))
colnames(average.slopes) <- c("FishID", "FinalSlope", "FinalSlopeHour", "FinalR2", "meanTemp")

slopes.all.final <- rbind(average.slopes, slopes.all.final)
```

####D2_B2_P

```{r}
# Load txt file
RMR_raw <- readcleanplanktivore("2018_burbot_resp_D2_B2_P_raw.txt")

# Assign names for this trial: 

"Fish1" <- "D2_B2_P1"
"Fish2" <- "D2_B2_P2"
"Fish3" <- "D2_B2_P3"
"Fish4" <- "D2_B2_P4"

# Create a new column with the time in minutes from the start of the file: 

RMR_raw$Time.m <- sapply(seq_along(RMR_raw$DateTime),
function(i) as.numeric(difftime(RMR_raw$DateTime[i], RMR_raw$DateTime[1], units='mins')))


# Pull measure periods. Grep finds all of the data in the Phase column that contains the letter M. 

RMR <- RMR_raw[grep("M", RMR_raw$Phase), ]


# Pull out first value of each phase for graphing later
Phase.start <- ddply(RMR, "Phase", head, 1)
Phase.start <- Phase.start[,1:2]


# Change the column names of the chambers to the appropriate FishID:
Name.vec <- c(Fish1, Fish2, Fish3, Fish4)
names(RMR)[5:8] <- Name.vec


# Reshape the data so all O2 saturation values are in a single column:

RMR.2 <- melt(RMR, measure = Name.vec)

# Rename the columns. 
names(RMR.2) <-c("DateTime","Phase","Salinity","Temp","Time.m","FishID","O2.sat")

# Plot the measurement periods of all fish from this trial:
p=ggplot(data=RMR.2, aes(x=Time.m, y=O2.sat, group=Phase))
p+geom_point(aes(color=FishID))+theme_bw()


# Separate out individual fish for graphing/analysis:

## Separate each fish to it's own RMR file: 
Fish1_RMR <- filter(RMR.2, FishID == Fish1)
Fish2_RMR <- filter(RMR.2, FishID == Fish2)
Fish3_RMR <- filter(RMR.2, FishID == Fish3)
Fish4_RMR <- filter(RMR.2, FishID == Fish4)

# Determine length of measurment period because they vary between trials (ugh). I chose measurement period 5 so it's not in the first few measurement periods where we were switching them manually but not the last measurement period either in case it was cut short. 
(nrow(Fish1_RMR[Fish1_RMR$Phase == "M5   ",]))/60

# Determine total time in chambers (in hours) because this also slightly varied between trials (ugh). 
(nrow(RMR_raw))/60/60
```

```{r eval=FALSE}
## Plot individual measurement periods for each fish: 
p=ggplot(data=Fish1_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase), group=1)+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish1) 

p=ggplot(data=Fish2_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish2) 

p=ggplot(data=Fish3_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish3) 

p=ggplot(data=Fish4_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish4) 

##Plot individual measurement periods with the line of best fit: 

p=ggplot(data=Fish1_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish1) 

p=ggplot(data=Fish2_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish2) 

p=ggplot(data=Fish3_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish3) 

p=ggplot(data=Fish4_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish4) 
```

```{r}
# Calculate slopes of lines for each fish and convert slope from minutes to hours:
O2slopel1 <- dlply(Fish1_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope1 <- ldply(O2slopel1, function(d) coef(d))
names(O2slope1) <- c("Phase", "Intercept","Slope")
O2slope1<- mutate(O2slope1, FishID = Fish1)
O2slope1<-ddply(O2slope1, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel2 <- dlply(Fish2_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope2 <- ldply(O2slopel2, function(d) coef(d))
names(O2slope2) <- c("Phase", "Intercept","Slope")
O2slope2 <- mutate(O2slope2, FishID = Fish2)
O2slope2<-ddply(O2slope2, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel3 <- dlply(Fish3_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope3 <- ldply(O2slopel3, function(d) coef(d))
names(O2slope3) <- c("Phase", "Intercept","Slope")
O2slope3 <- mutate(O2slope3, FishID = Fish3)
O2slope3<-ddply(O2slope3, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel4 <- dlply(Fish4_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope4 <- ldply(O2slopel4, function(d) coef(d))
names(O2slope4) <- c("Phase", "Intercept","Slope")
O2slope4 <- mutate(O2slope4, FishID = Fish4)
O2slope4<-ddply(O2slope4, .(Phase), mutate, Slope.hour=Slope*60)


# Calculating the fit of each slope: 
O2.r2.1 <- dlply(Fish1_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit1<-ldply(O2.r2.1, function(d) d$r.squared)
slopefit1
names(slopefit1) <-c("Phase","r2")

O2.r2.2 <- dlply(Fish2_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit2<-ldply(O2.r2.2, function(d) d$r.squared)
slopefit2
names(slopefit2) <-c("Phase","r2")

O2.r2.3 <- dlply(Fish3_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit3<-ldply(O2.r2.3, function(d) d$r.squared)
slopefit3
names(slopefit3) <-c("Phase","r2")

O2.r2.4 <- dlply(Fish4_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit4<-ldply(O2.r2.4, function(d) d$r.squared)
slopefit4
names(slopefit4) <-c("Phase","r2")


# merge together slope and r2:
O2slope.r2.1<-merge(O2slope1, slopefit1, by=c("Phase"))
O2slope.r2.1<- O2slope.r2.1[mixedorder(O2slope.r2.1$Phase),]
O2slope.r2.1

O2slope.r2.2<-merge(O2slope2, slopefit2, by=c("Phase"))
O2slope.r2.2<- O2slope.r2.2[mixedorder(O2slope.r2.2$Phase),]
O2slope.r2.2

O2slope.r2.3<-merge(O2slope3, slopefit3, by=c("Phase"))
O2slope.r2.3<- O2slope.r2.3[mixedorder(O2slope.r2.3$Phase),]
O2slope.r2.3

O2slope.r2.4<-merge(O2slope4, slopefit4, by=c("Phase"))
O2slope.r2.4<- O2slope.r2.4[mixedorder(O2slope.r2.4$Phase),]
O2slope.r2.4

# bind all slope and r2 dataframes and sort the phases so they're in order:
slopes.r2.all <- rbind(O2slope.r2.1,O2slope.r2.2,O2slope.r2.3,O2slope.r2.4)
slopes.r2.all <- merge(slopes.r2.all, Phase.start, by=c("Phase"))
phase.sort <- unique(mixedsort(slopes.r2.all$Phase))
slopes.r2.all$Phase <- factor(slopes.r2.all$Phase, levels = phase.sort)


# Add mean temperature for that trial to the slopes.r2.all file. 
slopes.r2.all$meanTemp <- mean(RMR$Temp)

# Add in time from start of file

trial.first<- ddply(slopes.r2.all,"DateTime", head,1)
slopes.r2.all$Time.m <- difftime(slopes.r2.all$DateTime, head(trial.first$DateTime,1), units="mins", tz = "America/Los_Angeles")

# As you go through the text files from autoresp, you can consecutively add all of the slopes data, etc. to the slopes.all file, which is your big giant master file with all the data. After I calculate the slopes & r2 etc. for each file, then load the morphometrics data file and merge them together based on FishId. Bind days together first, then everything. 
slopes.all <- rbind(slopes.all, slopes.r2.all)

# Plot
ggplot(slopes.r2.all, aes(x=DateTime, y=(-1*Slope)))+
  geom_point(aes(color=FishID))+
  theme_bw()

# Sort based on slope value for every fish: 

Fish1_sorted_slopes <- O2slope.r2.1[order(-O2slope.r2.1$Slope.hour),]

Fish2_sorted_slopes <- O2slope.r2.2[order(-O2slope.r2.2$Slope.hour),]

Fish3_sorted_slopes <- O2slope.r2.3[order(-O2slope.r2.3$Slope.hour),]

Fish4_sorted_slopes <- O2slope.r2.4[order(-O2slope.r2.4$Slope.hour),]

# Remove the first two measurement periods. We don't want to include the first chunk of time immediately post-handling because thats a priori information that the fish was stressed. 

Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M1', Phase))
Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M2', Phase))
Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M1   ', Phase))
Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M2   ', Phase))

Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M1', Phase))
Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M2', Phase))
Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M1   ', Phase))
Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M2   ', Phase))

Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M1', Phase))
Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M2', Phase))
Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M1   ', Phase))
Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M2   ', Phase))

Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M1', Phase))
Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M2', Phase))
Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M1   ', Phase))
Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M2   ', Phase))

# Average lowest three

Fish1avgslopehour <- mean(head(Fish1_sorted_slopes$Slope.hour, 3))
Fish1avgslope <- mean(head(Fish1_sorted_slopes$Slope, 3))
Fish1avgR2 <- mean(head(Fish1_sorted_slopes$r2, 3))

Fish1finalRMR <- matrix(c(Fish1, Fish1avgslope, Fish1avgslopehour, Fish1avgR2), nrow=1, ncol=4)

Fish2avgslopehour <- mean(head(Fish2_sorted_slopes$Slope.hour, 3))
Fish2avgslope <- mean(head(Fish2_sorted_slopes$Slope, 3))
Fish2avgR2 <- mean(head(Fish2_sorted_slopes$r2, 3))

Fish2finalRMR <- matrix(c(Fish2, Fish2avgslope, Fish2avgslopehour, Fish2avgR2), nrow=1, ncol=4)

Fish3avgslopehour <- mean(head(Fish3_sorted_slopes$Slope.hour, 3))
Fish3avgslope <- mean(head(Fish3_sorted_slopes$Slope, 3))
Fish3avgR2 <- mean(head(Fish3_sorted_slopes$r2, 3))

Fish3finalRMR <- matrix(c(Fish3, Fish3avgslope, Fish3avgslopehour, Fish3avgR2), nrow=1, ncol=4)

Fish4avgslopehour <- mean(head(Fish4_sorted_slopes$Slope.hour, 3))
Fish4avgslope <- mean(head(Fish4_sorted_slopes$Slope, 3))
Fish4avgR2 <- mean(head(Fish4_sorted_slopes$r2, 3))

Fish4finalRMR <- matrix(c(Fish4, Fish4avgslope, Fish4avgslopehour, Fish4avgR2), nrow=1, ncol=4)

# Bind all fish from this trial together: 
average.slopes <- rbind(Fish1finalRMR, Fish2finalRMR, Fish3finalRMR, Fish4finalRMR)

#Add mean temp of this trial to final file: 
average.slopes <- cbind(average.slopes, mean(RMR$Temp))
colnames(average.slopes) <- c("FishID", "FinalSlope", "FinalSlopeHour", "FinalR2", "meanTemp")

slopes.all.final <- rbind(average.slopes, slopes.all.final)
```

#### D2_B3_P

```{r}
# Load txt file
RMR_raw <- readcleanplanktivore("2018_burbot_resp_D2_B3_P_raw.txt")

# Assign names for this trial: 

"Fish1" <- "D2_B3_P1"
"Fish2" <- "D2_B3_P2"
"Fish3" <- "D2_B3_P3"
"Fish4" <- "D2_B3_P4"

# Create a new column with the time in minutes from the start of the file: 

RMR_raw$Time.m <- sapply(seq_along(RMR_raw$DateTime),
function(i) as.numeric(difftime(RMR_raw$DateTime[i], RMR_raw$DateTime[1], units='mins')))


# Pull measure periods. Grep finds all of the data in the Phase column that contains the letter M. 

RMR <- RMR_raw[grep("M", RMR_raw$Phase), ]


# Pull out first value of each phase for graphing later
Phase.start <- ddply(RMR, "Phase", head, 1)
Phase.start <- Phase.start[,1:2]

# Change the column names of the chambers to the appropriate FishID:
Name.vec <- c(Fish1, Fish2, Fish3, Fish4)
names(RMR)[5:8] <- Name.vec


# Reshape the data so all O2 saturation values are in a single column:

RMR.2 <- melt(RMR, measure = Name.vec)

# Rename the columns. 
names(RMR.2) <-c("DateTime","Phase","Salinity","Temp","Time.m","FishID","O2.sat")

# Plot the measurement periods of all fish from this trial:
p=ggplot(data=RMR.2, aes(x=Time.m, y=O2.sat, group=Phase))
p+geom_point(aes(color=FishID))+theme_bw()


# Separate out individual fish for graphing/analysis:

## Separate each fish to it's own RMR file: 
Fish1_RMR <- filter(RMR.2, FishID == Fish1)
Fish2_RMR <- filter(RMR.2, FishID == Fish2)
Fish3_RMR <- filter(RMR.2, FishID == Fish3)
Fish4_RMR <- filter(RMR.2, FishID == Fish4)

# Determine length of measurment period because they vary between trials (ugh). I chose measurement period 5 so it's not in the first few measurement periods where we were switching them manually but not the last measurement period either in case it was cut short. 
(nrow(Fish1_RMR[Fish1_RMR$Phase == "M5   ",]))/60

# Determine total time in chambers (in hours) because this also slightly varied between trials (ugh). 
(nrow(RMR_raw))/60/60
```

```{r eval=FALSE}
## Plot individual measurement periods for each fish: 
p=ggplot(data=Fish1_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase), group=1)+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish1) 

p=ggplot(data=Fish2_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish2) 

p=ggplot(data=Fish3_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish3) 

p=ggplot(data=Fish4_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish4) 

##Plot individual measurement periods with the line of best fit: 

p=ggplot(data=Fish1_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish1) 

p=ggplot(data=Fish2_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish2) 

p=ggplot(data=Fish3_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish3) 

p=ggplot(data=Fish4_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish4) 
```

```{r}
# Calculate slopes of lines for each fish and convert slope from minutes to hours:
O2slopel1 <- dlply(Fish1_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope1 <- ldply(O2slopel1, function(d) coef(d))
names(O2slope1) <- c("Phase", "Intercept","Slope")
O2slope1<- mutate(O2slope1, FishID = Fish1)
O2slope1<-ddply(O2slope1, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel2 <- dlply(Fish2_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope2 <- ldply(O2slopel2, function(d) coef(d))
names(O2slope2) <- c("Phase", "Intercept","Slope")
O2slope2 <- mutate(O2slope2, FishID = Fish2)
O2slope2<-ddply(O2slope2, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel3 <- dlply(Fish3_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope3 <- ldply(O2slopel3, function(d) coef(d))
names(O2slope3) <- c("Phase", "Intercept","Slope")
O2slope3 <- mutate(O2slope3, FishID = Fish3)
O2slope3<-ddply(O2slope3, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel4 <- dlply(Fish4_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope4 <- ldply(O2slopel4, function(d) coef(d))
names(O2slope4) <- c("Phase", "Intercept","Slope")
O2slope4 <- mutate(O2slope4, FishID = Fish4)
O2slope4<-ddply(O2slope4, .(Phase), mutate, Slope.hour=Slope*60)


# Calculating the fit of each slope: 
O2.r2.1 <- dlply(Fish1_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit1<-ldply(O2.r2.1, function(d) d$r.squared)
slopefit1
names(slopefit1) <-c("Phase","r2")

O2.r2.2 <- dlply(Fish2_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit2<-ldply(O2.r2.2, function(d) d$r.squared)
slopefit2
names(slopefit2) <-c("Phase","r2")

O2.r2.3 <- dlply(Fish3_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit3<-ldply(O2.r2.3, function(d) d$r.squared)
slopefit3
names(slopefit3) <-c("Phase","r2")

O2.r2.4 <- dlply(Fish4_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit4<-ldply(O2.r2.4, function(d) d$r.squared)
slopefit4
names(slopefit4) <-c("Phase","r2")


# merge together slope and r2:
O2slope.r2.1<-merge(O2slope1, slopefit1, by=c("Phase"))
O2slope.r2.1<- O2slope.r2.1[mixedorder(O2slope.r2.1$Phase),]
O2slope.r2.1

O2slope.r2.2<-merge(O2slope2, slopefit2, by=c("Phase"))
O2slope.r2.2<- O2slope.r2.2[mixedorder(O2slope.r2.2$Phase),]
O2slope.r2.2

O2slope.r2.3<-merge(O2slope3, slopefit3, by=c("Phase"))
O2slope.r2.3<- O2slope.r2.3[mixedorder(O2slope.r2.3$Phase),]
O2slope.r2.3

O2slope.r2.4<-merge(O2slope4, slopefit4, by=c("Phase"))
O2slope.r2.4<- O2slope.r2.4[mixedorder(O2slope.r2.4$Phase),]
O2slope.r2.4

# bind all slope and r2 dataframes and sort the phases so they're in order:
slopes.r2.all <- rbind(O2slope.r2.1,O2slope.r2.2,O2slope.r2.3,O2slope.r2.4)
slopes.r2.all <- merge(slopes.r2.all, Phase.start, by=c("Phase"))
phase.sort <- unique(mixedsort(slopes.r2.all$Phase))
slopes.r2.all$Phase <- factor(slopes.r2.all$Phase, levels = phase.sort)


# Add mean temperature for that trial to the slopes.r2.all file. 
slopes.r2.all$meanTemp <- mean(RMR$Temp)

# Add in time from start of file

trial.first<- ddply(slopes.r2.all,"DateTime", head,1)
slopes.r2.all$Time.m <- difftime(slopes.r2.all$DateTime, head(trial.first$DateTime,1), units="mins", tz = "America/Los_Angeles")

# As you go through the text files from autoresp, you can consecutively add all of the slopes data, etc. to the slopes.all file, which is your big giant master file with all the data. After I calculate the slopes & r2 etc. for each file, then load the morphometrics data file and merge them together based on FishId. Bind days together first, then everything. 
slopes.all <- rbind(slopes.all, slopes.r2.all)


# Plot
ggplot(slopes.r2.all, aes(x=DateTime, y=(-1*Slope)))+
  geom_point(aes(color=FishID))+
  theme_bw()


# Sort based on slope value for every fish: 

Fish1_sorted_slopes <- O2slope.r2.1[order(-O2slope.r2.1$Slope.hour),]

Fish2_sorted_slopes <- O2slope.r2.2[order(-O2slope.r2.2$Slope.hour),]

Fish3_sorted_slopes <- O2slope.r2.3[order(-O2slope.r2.3$Slope.hour),]

Fish4_sorted_slopes <- O2slope.r2.4[order(-O2slope.r2.4$Slope.hour),]

# Remove the first two measurement periods. We don't want to include the first chunk of time immediately post-handling because thats a priori information that the fish was stressed. 

Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M1', Phase))
Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M2', Phase))
Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M1   ', Phase))
Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M2   ', Phase))

Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M1', Phase))
Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M2', Phase))
Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M1   ', Phase))
Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M2   ', Phase))

Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M1', Phase))
Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M2', Phase))
Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M1   ', Phase))
Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M2   ', Phase))

Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M1', Phase))
Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M2', Phase))
Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M1   ', Phase))
Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M2   ', Phase))
Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M5', Phase))  #Also removed M5 ONLY for this fish in this trial because it was clearly screwed up but was being used to calculate the average

# Average lowest three

Fish1avgslopehour <- mean(head(Fish1_sorted_slopes$Slope.hour, 3))
Fish1avgslope <- mean(head(Fish1_sorted_slopes$Slope, 3))
Fish1avgR2 <- mean(head(Fish1_sorted_slopes$r2, 3))

Fish1finalRMR <- matrix(c(Fish1, Fish1avgslope, Fish1avgslopehour, Fish1avgR2), nrow=1, ncol=4)

Fish2avgslopehour <- mean(head(Fish2_sorted_slopes$Slope.hour, 3))
Fish2avgslope <- mean(head(Fish2_sorted_slopes$Slope, 3))
Fish2avgR2 <- mean(head(Fish2_sorted_slopes$r2, 3))

Fish2finalRMR <- matrix(c(Fish2, Fish2avgslope, Fish2avgslopehour, Fish2avgR2), nrow=1, ncol=4)

Fish3avgslopehour <- mean(head(Fish3_sorted_slopes$Slope.hour, 3))
Fish3avgslope <- mean(head(Fish3_sorted_slopes$Slope, 3))
Fish3avgR2 <- mean(head(Fish3_sorted_slopes$r2, 3))

Fish3finalRMR <- matrix(c(Fish3, Fish3avgslope, Fish3avgslopehour, Fish3avgR2), nrow=1, ncol=4)

Fish4avgslopehour <- mean(head(Fish4_sorted_slopes$Slope.hour, 3))
Fish4avgslope <- mean(head(Fish4_sorted_slopes$Slope, 3))
Fish4avgR2 <- mean(head(Fish4_sorted_slopes$r2, 3))

Fish4finalRMR <- matrix(c(Fish4, Fish4avgslope, Fish4avgslopehour, Fish4avgR2), nrow=1, ncol=4)

# Bind all fish from this trial together: 
average.slopes <- rbind(Fish1finalRMR, Fish2finalRMR, Fish3finalRMR, Fish4finalRMR)

#Add mean temp of this trial to final file: 
average.slopes <- cbind(average.slopes, mean(RMR$Temp))
colnames(average.slopes) <- c("FishID", "FinalSlope", "FinalSlopeHour", "FinalR2", "meanTemp")

slopes.all.final <- rbind(average.slopes, slopes.all.final)
```

#### D3_B1_P

```{r}
# Load txt file
RMR_raw <- readcleanplanktivore("2018_burbot_resp_D3_B1_P_raw.txt")

# Assign names for this trial: 

"Fish1" <- "D3_B1_P1"
"Fish2" <- "D3_B1_P2"
"Fish3" <- "D3_B1_P3"
"Fish4" <- "D3_B1_P4"

# Create a new column with the time in minutes from the start of the file: 

RMR_raw$Time.m <- sapply(seq_along(RMR_raw$DateTime),
function(i) as.numeric(difftime(RMR_raw$DateTime[i], RMR_raw$DateTime[1], units='mins')))


# Pull measure periods. Grep finds all of the data in the Phase column that contains the letter M. 

RMR <- RMR_raw[grep("M", RMR_raw$Phase), ]


# Pull out first value of each phase for graphing later
Phase.start <- ddply(RMR, "Phase", head, 1)
Phase.start <- Phase.start[,1:2]


# Change the column names of the chambers to the appropriate FishID:
Name.vec <- c(Fish1, Fish2, Fish3, Fish4)
names(RMR)[5:8] <- Name.vec


# Reshape the data so all O2 saturation values are in a single column:

RMR.2 <- melt(RMR, measure = Name.vec)

# Rename the columns. 
names(RMR.2) <-c("DateTime","Phase","Salinity","Temp","Time.m","FishID","O2.sat")

# Plot the measurement periods of all fish from this trial:
p=ggplot(data=RMR.2, aes(x=Time.m, y=O2.sat, group=Phase))
p+geom_point(aes(color=FishID))+theme_bw()


# Separate out individual fish for graphing/analysis:

## Separate each fish to it's own RMR file: 
Fish1_RMR <- filter(RMR.2, FishID == Fish1)
Fish2_RMR <- filter(RMR.2, FishID == Fish2)
Fish3_RMR <- filter(RMR.2, FishID == Fish3)
Fish4_RMR <- filter(RMR.2, FishID == Fish4)

# Determine length of measurment period because they vary between trials (ugh). I chose measurement period 5 so it's not in the first few measurement periods where we were switching them manually but not the last measurement period either in case it was cut short. 
(nrow(Fish1_RMR[Fish1_RMR$Phase == "M5",]))/60

# Determine total time in chambers (in hours) because this also slightly varied between trials (ugh). 
(nrow(RMR_raw))/60/60
```

```{r eval=FALSE}
## Plot individual measurement periods for each fish: 
p=ggplot(data=Fish1_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase), group=1)+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish1) 

p=ggplot(data=Fish2_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish2) 

p=ggplot(data=Fish3_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish3) 

p=ggplot(data=Fish4_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish4) 

##Plot individual measurement periods with the line of best fit: 

p=ggplot(data=Fish1_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish1) 

p=ggplot(data=Fish2_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish2) 

p=ggplot(data=Fish3_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish3) 

p=ggplot(data=Fish4_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish4) 
```

```{r}
# Calculate slopes of lines for each fish and convert slope from minutes to hours:
O2slopel1 <- dlply(Fish1_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope1 <- ldply(O2slopel1, function(d) coef(d))
names(O2slope1) <- c("Phase", "Intercept","Slope")
O2slope1<- mutate(O2slope1, FishID = Fish1)
O2slope1<-ddply(O2slope1, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel2 <- dlply(Fish2_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope2 <- ldply(O2slopel2, function(d) coef(d))
names(O2slope2) <- c("Phase", "Intercept","Slope")
O2slope2 <- mutate(O2slope2, FishID = Fish2)
O2slope2<-ddply(O2slope2, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel3 <- dlply(Fish3_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope3 <- ldply(O2slopel3, function(d) coef(d))
names(O2slope3) <- c("Phase", "Intercept","Slope")
O2slope3 <- mutate(O2slope3, FishID = Fish3)
O2slope3<-ddply(O2slope3, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel4 <- dlply(Fish4_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope4 <- ldply(O2slopel4, function(d) coef(d))
names(O2slope4) <- c("Phase", "Intercept","Slope")
O2slope4 <- mutate(O2slope4, FishID = Fish4)
O2slope4<-ddply(O2slope4, .(Phase), mutate, Slope.hour=Slope*60)


# Calculating the fit of each slope: 
O2.r2.1 <- dlply(Fish1_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit1<-ldply(O2.r2.1, function(d) d$r.squared)
slopefit1
names(slopefit1) <-c("Phase","r2")

O2.r2.2 <- dlply(Fish2_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit2<-ldply(O2.r2.2, function(d) d$r.squared)
slopefit2
names(slopefit2) <-c("Phase","r2")

O2.r2.3 <- dlply(Fish3_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit3<-ldply(O2.r2.3, function(d) d$r.squared)
slopefit3
names(slopefit3) <-c("Phase","r2")

O2.r2.4 <- dlply(Fish4_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit4<-ldply(O2.r2.4, function(d) d$r.squared)
slopefit4
names(slopefit4) <-c("Phase","r2")


# merge together slope and r2:
O2slope.r2.1<-merge(O2slope1, slopefit1, by=c("Phase"))
O2slope.r2.1<- O2slope.r2.1[mixedorder(O2slope.r2.1$Phase),]
O2slope.r2.1

O2slope.r2.2<-merge(O2slope2, slopefit2, by=c("Phase"))
O2slope.r2.2<- O2slope.r2.2[mixedorder(O2slope.r2.2$Phase),]
O2slope.r2.2

O2slope.r2.3<-merge(O2slope3, slopefit3, by=c("Phase"))
O2slope.r2.3<- O2slope.r2.3[mixedorder(O2slope.r2.3$Phase),]
O2slope.r2.3

O2slope.r2.4<-merge(O2slope4, slopefit4, by=c("Phase"))
O2slope.r2.4<- O2slope.r2.4[mixedorder(O2slope.r2.4$Phase),]
O2slope.r2.4

# bind all slope and r2 dataframes and sort the phases so they're in order:
slopes.r2.all <- rbind(O2slope.r2.1,O2slope.r2.2,O2slope.r2.3,O2slope.r2.4)
slopes.r2.all <- merge(slopes.r2.all, Phase.start, by=c("Phase"))
phase.sort <- unique(mixedsort(slopes.r2.all$Phase))
slopes.r2.all$Phase <- factor(slopes.r2.all$Phase, levels = phase.sort)


# Add mean temperature for that trial to the slopes.r2.all file. 
slopes.r2.all$meanTemp <- mean(RMR$Temp)

# Add in time from start of file

trial.first<- ddply(slopes.r2.all,"DateTime", head,1)
slopes.r2.all$Time.m <- difftime(slopes.r2.all$DateTime, head(trial.first$DateTime,1), units="mins", tz = "America/Los_Angeles")

# As you go through the text files from autoresp, you can consecutively add all of the slopes data, etc. to the slopes.all file, which is your big giant master file with all the data. After I calculate the slopes & r2 etc. for each file, then load the morphometrics data file and merge them together based on FishId. Bind days together first, then everything. 
slopes.all <- rbind(slopes.all, slopes.r2.all)


# Plot
ggplot(slopes.r2.all, aes(x=DateTime, y=(-1*Slope)))+
  geom_point(aes(color=FishID))+
  theme_bw()



# Sort based on slope value for every fish: 

Fish1_sorted_slopes <- O2slope.r2.1[order(-O2slope.r2.1$Slope.hour),]

Fish2_sorted_slopes <- O2slope.r2.2[order(-O2slope.r2.2$Slope.hour),]

Fish3_sorted_slopes <- O2slope.r2.3[order(-O2slope.r2.3$Slope.hour),]

Fish4_sorted_slopes <- O2slope.r2.4[order(-O2slope.r2.4$Slope.hour),]

# Remove the first two measurement periods. We don't want to include the first chunk of time immediately post-handling because thats a priori information that the fish was stressed. 

Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M1', Phase))
Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M2', Phase))
Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M1   ', Phase))
Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M2   ', Phase))

Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M1', Phase))
Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M2', Phase))
Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M1   ', Phase))
Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M2   ', Phase))

Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M1', Phase))
Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M2', Phase))
Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M1   ', Phase))
Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M2   ', Phase))

Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M1', Phase))
Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M2', Phase))
Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M1   ', Phase))
Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M2   ', Phase))

# Average lowest three

Fish1avgslopehour <- mean(head(Fish1_sorted_slopes$Slope.hour, 3))
Fish1avgslope <- mean(head(Fish1_sorted_slopes$Slope, 3))
Fish1avgR2 <- mean(head(Fish1_sorted_slopes$r2, 3))

Fish1finalRMR <- matrix(c(Fish1, Fish1avgslope, Fish1avgslopehour, Fish1avgR2), nrow=1, ncol=4)

Fish2avgslopehour <- mean(head(Fish2_sorted_slopes$Slope.hour, 3))
Fish2avgslope <- mean(head(Fish2_sorted_slopes$Slope, 3))
Fish2avgR2 <- mean(head(Fish2_sorted_slopes$r2, 3))

Fish2finalRMR <- matrix(c(Fish2, Fish2avgslope, Fish2avgslopehour, Fish2avgR2), nrow=1, ncol=4)

Fish3avgslopehour <- mean(head(Fish3_sorted_slopes$Slope.hour, 3))
Fish3avgslope <- mean(head(Fish3_sorted_slopes$Slope, 3))
Fish3avgR2 <- mean(head(Fish3_sorted_slopes$r2, 3))

Fish3finalRMR <- matrix(c(Fish3, Fish3avgslope, Fish3avgslopehour, Fish3avgR2), nrow=1, ncol=4)

Fish4avgslopehour <- mean(head(Fish4_sorted_slopes$Slope.hour, 3))
Fish4avgslope <- mean(head(Fish4_sorted_slopes$Slope, 3))
Fish4avgR2 <- mean(head(Fish4_sorted_slopes$r2, 3))

Fish4finalRMR <- matrix(c(Fish4, Fish4avgslope, Fish4avgslopehour, Fish4avgR2), nrow=1, ncol=4)

# Bind all fish from this trial together: 
average.slopes <- rbind(Fish1finalRMR, Fish2finalRMR, Fish3finalRMR, Fish4finalRMR)

#Add mean temp of this trial to final file: 
average.slopes <- cbind(average.slopes, mean(RMR$Temp))
colnames(average.slopes) <- c("FishID", "FinalSlope", "FinalSlopeHour", "FinalR2", "meanTemp")

slopes.all.final <- rbind(average.slopes, slopes.all.final)
```

#### D3_B2_P

```{r}
# Load txt file
RMR_raw <- readcleanplanktivore("2018_burbot_resp_D3_B2_P_raw.txt")

# Assign names for this trial: 

"Fish1" <- "D3_B2_P1"
"Fish2" <- "D3_B2_P2"
"Fish3" <- "D3_B2_P3"
"Fish4" <- "D3_B2_P4"

# Create a new column with the time in minutes from the start of the file: 

RMR_raw$Time.m <- sapply(seq_along(RMR_raw$DateTime),
function(i) as.numeric(difftime(RMR_raw$DateTime[i], RMR_raw$DateTime[1], units='mins')))


# Pull measure periods. Grep finds all of the data in the Phase column that contains the letter M. 

RMR <- RMR_raw[grep("M", RMR_raw$Phase), ]

# Pull out first value of each phase for graphing later
Phase.start <- ddply(RMR, "Phase", head, 1)
Phase.start <- Phase.start[,1:2]


# Change the column names of the chambers to the appropriate FishID:
Name.vec <- c(Fish1, Fish2, Fish3, Fish4)
names(RMR)[5:8] <- Name.vec


# Reshape the data so all O2 saturation values are in a single column:

RMR.2 <- melt(RMR, measure = Name.vec)

# Rename the columns. 
names(RMR.2) <-c("DateTime","Phase","Salinity","Temp","Time.m","FishID","O2.sat")

# Plot the measurement periods of all fish from this trial:
p=ggplot(data=RMR.2, aes(x=Time.m, y=O2.sat, group=Phase))
p+geom_point(aes(color=FishID))+theme_bw()


# Separate out individual fish for graphing/analysis:

## Separate each fish to it's own RMR file: 
Fish1_RMR <- filter(RMR.2, FishID == Fish1)
Fish2_RMR <- filter(RMR.2, FishID == Fish2)
Fish3_RMR <- filter(RMR.2, FishID == Fish3)
Fish4_RMR <- filter(RMR.2, FishID == Fish4)

# Determine length of measurment period because they vary between trials (ugh). I chose measurement period 5 so it's not in the first few measurement periods where we were switching them manually but not the last measurement period either in case it was cut short. 
(nrow(Fish1_RMR[Fish1_RMR$Phase == "M5   ",]))/60

# Determine total time in chambers (in hours) because this also slightly varied between trials (ugh). 
(nrow(RMR_raw))/60/60
```

```{r eval=FALSE}
## Plot individual measurement periods for each fish: 
p=ggplot(data=Fish1_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase), group=1)+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish1) 

p=ggplot(data=Fish2_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish2) 

p=ggplot(data=Fish3_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish3) 

p=ggplot(data=Fish4_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish4) 

##Plot individual measurement periods with the line of best fit: 

p=ggplot(data=Fish1_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish1) 

p=ggplot(data=Fish2_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish2) 

p=ggplot(data=Fish3_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish3) 

p=ggplot(data=Fish4_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish4) 
```

```{r}
# Calculate slopes of lines for each fish and convert slope from minutes to hours:
O2slopel1 <- dlply(Fish1_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope1 <- ldply(O2slopel1, function(d) coef(d))
names(O2slope1) <- c("Phase", "Intercept","Slope")
O2slope1<- mutate(O2slope1, FishID = Fish1)
O2slope1<-ddply(O2slope1, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel2 <- dlply(Fish2_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope2 <- ldply(O2slopel2, function(d) coef(d))
names(O2slope2) <- c("Phase", "Intercept","Slope")
O2slope2 <- mutate(O2slope2, FishID = Fish2)
O2slope2<-ddply(O2slope2, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel3 <- dlply(Fish3_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope3 <- ldply(O2slopel3, function(d) coef(d))
names(O2slope3) <- c("Phase", "Intercept","Slope")
O2slope3 <- mutate(O2slope3, FishID = Fish3)
O2slope3<-ddply(O2slope3, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel4 <- dlply(Fish4_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope4 <- ldply(O2slopel4, function(d) coef(d))
names(O2slope4) <- c("Phase", "Intercept","Slope")
O2slope4 <- mutate(O2slope4, FishID = Fish4)
O2slope4<-ddply(O2slope4, .(Phase), mutate, Slope.hour=Slope*60)


# Calculating the fit of each slope: 
O2.r2.1 <- dlply(Fish1_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit1<-ldply(O2.r2.1, function(d) d$r.squared)
slopefit1
names(slopefit1) <-c("Phase","r2")

O2.r2.2 <- dlply(Fish2_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit2<-ldply(O2.r2.2, function(d) d$r.squared)
slopefit2
names(slopefit2) <-c("Phase","r2")

O2.r2.3 <- dlply(Fish3_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit3<-ldply(O2.r2.3, function(d) d$r.squared)
slopefit3
names(slopefit3) <-c("Phase","r2")

O2.r2.4 <- dlply(Fish4_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit4<-ldply(O2.r2.4, function(d) d$r.squared)
slopefit4
names(slopefit4) <-c("Phase","r2")


# merge together slope and r2:
O2slope.r2.1<-merge(O2slope1, slopefit1, by=c("Phase"))
O2slope.r2.1<- O2slope.r2.1[mixedorder(O2slope.r2.1$Phase),]
O2slope.r2.1

O2slope.r2.2<-merge(O2slope2, slopefit2, by=c("Phase"))
O2slope.r2.2<- O2slope.r2.2[mixedorder(O2slope.r2.2$Phase),]
O2slope.r2.2

O2slope.r2.3<-merge(O2slope3, slopefit3, by=c("Phase"))
O2slope.r2.3<- O2slope.r2.3[mixedorder(O2slope.r2.3$Phase),]
O2slope.r2.3

O2slope.r2.4<-merge(O2slope4, slopefit4, by=c("Phase"))
O2slope.r2.4<- O2slope.r2.4[mixedorder(O2slope.r2.4$Phase),]
O2slope.r2.4

# bind all slope and r2 dataframes and sort the phases so they're in order:
slopes.r2.all <- rbind(O2slope.r2.1,O2slope.r2.2,O2slope.r2.3,O2slope.r2.4)
slopes.r2.all <- merge(slopes.r2.all, Phase.start, by=c("Phase"))
phase.sort <- unique(mixedsort(slopes.r2.all$Phase))
slopes.r2.all$Phase <- factor(slopes.r2.all$Phase, levels = phase.sort)


# Add mean temperature for that trial to the slopes.r2.all file. 
slopes.r2.all$meanTemp <- mean(RMR$Temp)

# Add in time from start of file

trial.first<- ddply(slopes.r2.all,"DateTime", head,1)
slopes.r2.all$Time.m <- difftime(slopes.r2.all$DateTime, head(trial.first$DateTime,1), units="mins", tz = "America/Los_Angeles")

# As you go through the text files from autoresp, you can consecutively add all of the slopes data, etc. to the slopes.all file, which is your big giant master file with all the data. After I calculate the slopes & r2 etc. for each file, then load the morphometrics data file and merge them together based on FishId. Bind days together first, then everything. 
slopes.all <- rbind(slopes.all, slopes.r2.all)


# Plot
ggplot(slopes.r2.all, aes(x=DateTime, y=(-1*Slope)))+
  geom_point(aes(color=FishID))+
  theme_bw()


# Sort based on slope value for every fish: 

Fish1_sorted_slopes <- O2slope.r2.1[order(-O2slope.r2.1$Slope.hour),]

Fish2_sorted_slopes <- O2slope.r2.2[order(-O2slope.r2.2$Slope.hour),]

Fish3_sorted_slopes <- O2slope.r2.3[order(-O2slope.r2.3$Slope.hour),]

Fish4_sorted_slopes <- O2slope.r2.4[order(-O2slope.r2.4$Slope.hour),]

# Remove the first two measurement periods. We don't want to include the first chunk of time immediately post-handling because thats a priori information that the fish was stressed. 

Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M1', Phase))
Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M2', Phase))
Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M1   ', Phase))
Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M2   ', Phase))

Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M1', Phase))
Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M2', Phase))
Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M1   ', Phase))
Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M2   ', Phase))

Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M1', Phase))
Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M2', Phase))
Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M1   ', Phase))
Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M2   ', Phase))

Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M1', Phase))
Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M2', Phase))
Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M1   ', Phase))
Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M2   ', Phase))

# Average lowest three

Fish1avgslopehour <- mean(head(Fish1_sorted_slopes$Slope.hour, 3))
Fish1avgslope <- mean(head(Fish1_sorted_slopes$Slope, 3))
Fish1avgR2 <- mean(head(Fish1_sorted_slopes$r2, 3))

Fish1finalRMR <- matrix(c(Fish1, Fish1avgslope, Fish1avgslopehour, Fish1avgR2), nrow=1, ncol=4)

Fish2avgslopehour <- mean(head(Fish2_sorted_slopes$Slope.hour, 3))
Fish2avgslope <- mean(head(Fish2_sorted_slopes$Slope, 3))
Fish2avgR2 <- mean(head(Fish2_sorted_slopes$r2, 3))

Fish2finalRMR <- matrix(c(Fish2, Fish2avgslope, Fish2avgslopehour, Fish2avgR2), nrow=1, ncol=4)

Fish3avgslopehour <- mean(head(Fish3_sorted_slopes$Slope.hour, 3))
Fish3avgslope <- mean(head(Fish3_sorted_slopes$Slope, 3))
Fish3avgR2 <- mean(head(Fish3_sorted_slopes$r2, 3))

Fish3finalRMR <- matrix(c(Fish3, Fish3avgslope, Fish3avgslopehour, Fish3avgR2), nrow=1, ncol=4)

Fish4avgslopehour <- mean(head(Fish4_sorted_slopes$Slope.hour, 3))
Fish4avgslope <- mean(head(Fish4_sorted_slopes$Slope, 3))
Fish4avgR2 <- mean(head(Fish4_sorted_slopes$r2, 3))

Fish4finalRMR <- matrix(c(Fish4, Fish4avgslope, Fish4avgslopehour, Fish4avgR2), nrow=1, ncol=4)

# Bind all fish from this trial together: 
average.slopes <- rbind(Fish1finalRMR, Fish2finalRMR, Fish3finalRMR, Fish4finalRMR)

#Add mean temp of this trial to final file: 
average.slopes <- cbind(average.slopes, mean(RMR$Temp))
colnames(average.slopes) <- c("FishID", "FinalSlope", "FinalSlopeHour", "FinalR2", "meanTemp")

slopes.all.final <- rbind(average.slopes, slopes.all.final)
```

#### D3_B3_P

```{r}
# Load txt file
RMR_raw <- readcleanplanktivore("2018_burbot_resp_D3_B3_P_raw.txt")

# Assign names for this trial: 

"Fish1" <- "D3_B3_P1"
"Fish2" <- "D3_B3_P2"
"Fish3" <- "D3_B3_P3"
"Fish4" <- "D3_B3_P4"

# Create a new column with the time in minutes from the start of the file: 

RMR_raw$Time.m <- sapply(seq_along(RMR_raw$DateTime),
function(i) as.numeric(difftime(RMR_raw$DateTime[i], RMR_raw$DateTime[1], units='mins')))


# Pull measure periods. Grep finds all of the data in the Phase column that contains the letter M. 

RMR <- RMR_raw[grep("M", RMR_raw$Phase), ]


# Pull out first value of each phase for graphing later
Phase.start <- ddply(RMR, "Phase", head, 1)
Phase.start <- Phase.start[,1:2]


# Change the column names of the chambers to the appropriate FishID:
Name.vec <- c(Fish1, Fish2, Fish3, Fish4)
names(RMR)[5:8] <- Name.vec


# Reshape the data so all O2 saturation values are in a single column:

RMR.2 <- melt(RMR, measure = Name.vec)

# Rename the columns. 
names(RMR.2) <-c("DateTime","Phase","Salinity","Temp","Time.m","FishID","O2.sat")

# Plot the measurement periods of all fish from this trial:
p=ggplot(data=RMR.2, aes(x=Time.m, y=O2.sat, group=Phase))
p+geom_point(aes(color=FishID))+theme_bw()


# Separate out individual fish for graphing/analysis:

## Separate each fish to it's own RMR file: 
Fish1_RMR <- filter(RMR.2, FishID == Fish1)
Fish2_RMR <- filter(RMR.2, FishID == Fish2)
Fish3_RMR <- filter(RMR.2, FishID == Fish3)
Fish4_RMR <- filter(RMR.2, FishID == Fish4)

# Determine length of measurment period because they vary between trials (ugh). I chose measurement period 5 so it's not in the first few measurement periods where we were switching them manually but not the last measurement period either in case it was cut short. 
(nrow(Fish1_RMR[Fish1_RMR$Phase == "M5",]))/60

# Determine total time in chambers (in hours) because this also slightly varied between trials (ugh). 
(nrow(RMR_raw))/60/60
```

```{r eval=FALSE}
## Plot individual measurement periods for each fish: 
p=ggplot(data=Fish1_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase), group=1)+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish1) 

p=ggplot(data=Fish2_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish2) 

p=ggplot(data=Fish3_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish3) 

p=ggplot(data=Fish4_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish4) 

##Plot individual measurement periods with the line of best fit: 

p=ggplot(data=Fish1_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish1) 

p=ggplot(data=Fish2_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish2) 

p=ggplot(data=Fish3_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish3) 

p=ggplot(data=Fish4_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish4) 
```

```{r}
# Calculate slopes of lines for each fish and convert slope from minutes to hours:
O2slopel1 <- dlply(Fish1_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope1 <- ldply(O2slopel1, function(d) coef(d))
names(O2slope1) <- c("Phase", "Intercept","Slope")
O2slope1<- mutate(O2slope1, FishID = Fish1)
O2slope1<-ddply(O2slope1, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel2 <- dlply(Fish2_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope2 <- ldply(O2slopel2, function(d) coef(d))
names(O2slope2) <- c("Phase", "Intercept","Slope")
O2slope2 <- mutate(O2slope2, FishID = Fish2)
O2slope2<-ddply(O2slope2, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel3 <- dlply(Fish3_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope3 <- ldply(O2slopel3, function(d) coef(d))
names(O2slope3) <- c("Phase", "Intercept","Slope")
O2slope3 <- mutate(O2slope3, FishID = Fish3)
O2slope3<-ddply(O2slope3, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel4 <- dlply(Fish4_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope4 <- ldply(O2slopel4, function(d) coef(d))
names(O2slope4) <- c("Phase", "Intercept","Slope")
O2slope4 <- mutate(O2slope4, FishID = Fish4)
O2slope4<-ddply(O2slope4, .(Phase), mutate, Slope.hour=Slope*60)


# Calculating the fit of each slope: 
O2.r2.1 <- dlply(Fish1_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit1<-ldply(O2.r2.1, function(d) d$r.squared)
slopefit1
names(slopefit1) <-c("Phase","r2")

O2.r2.2 <- dlply(Fish2_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit2<-ldply(O2.r2.2, function(d) d$r.squared)
slopefit2
names(slopefit2) <-c("Phase","r2")

O2.r2.3 <- dlply(Fish3_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit3<-ldply(O2.r2.3, function(d) d$r.squared)
slopefit3
names(slopefit3) <-c("Phase","r2")

O2.r2.4 <- dlply(Fish4_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit4<-ldply(O2.r2.4, function(d) d$r.squared)
slopefit4
names(slopefit4) <-c("Phase","r2")


# merge together slope and r2:
O2slope.r2.1<-merge(O2slope1, slopefit1, by=c("Phase"))
O2slope.r2.1<- O2slope.r2.1[mixedorder(O2slope.r2.1$Phase),]
O2slope.r2.1

O2slope.r2.2<-merge(O2slope2, slopefit2, by=c("Phase"))
O2slope.r2.2<- O2slope.r2.2[mixedorder(O2slope.r2.2$Phase),]
O2slope.r2.2

O2slope.r2.3<-merge(O2slope3, slopefit3, by=c("Phase"))
O2slope.r2.3<- O2slope.r2.3[mixedorder(O2slope.r2.3$Phase),]
O2slope.r2.3

O2slope.r2.4<-merge(O2slope4, slopefit4, by=c("Phase"))
O2slope.r2.4<- O2slope.r2.4[mixedorder(O2slope.r2.4$Phase),]
O2slope.r2.4

# bind all slope and r2 dataframes and sort the phases so they're in order:
slopes.r2.all <- rbind(O2slope.r2.1,O2slope.r2.2,O2slope.r2.3,O2slope.r2.4)
slopes.r2.all <- merge(slopes.r2.all, Phase.start, by=c("Phase"))
phase.sort <- unique(mixedsort(slopes.r2.all$Phase))
slopes.r2.all$Phase <- factor(slopes.r2.all$Phase, levels = phase.sort)

# Add mean temperature for that trial to the slopes.r2.all file. 
slopes.r2.all$meanTemp <- mean(RMR$Temp)

# Add in time from start of file

trial.first<- ddply(slopes.r2.all,"DateTime", head,1)
slopes.r2.all$Time.m <- difftime(slopes.r2.all$DateTime, head(trial.first$DateTime,1), units="mins", tz = "America/Los_Angeles")

# As you go through the text files from autoresp, you can consecutively add all of the slopes data, etc. to the slopes.all file, which is your big giant master file with all the data. After I calculate the slopes & r2 etc. for each file, then load the morphometrics data file and merge them together based on FishId. Bind days together first, then everything. 
slopes.all <- rbind(slopes.all, slopes.r2.all)


# Plot
ggplot(slopes.r2.all, aes(x=DateTime, y=(-1*Slope)))+
  geom_point(aes(color=FishID))+
  theme_bw()

# Sort based on slope value for every fish: 

Fish1_sorted_slopes <- O2slope.r2.1[order(-O2slope.r2.1$Slope.hour),]

Fish2_sorted_slopes <- O2slope.r2.2[order(-O2slope.r2.2$Slope.hour),]

Fish3_sorted_slopes <- O2slope.r2.3[order(-O2slope.r2.3$Slope.hour),]

Fish4_sorted_slopes <- O2slope.r2.4[order(-O2slope.r2.4$Slope.hour),]

# Remove the first two measurement periods. We don't want to include the first chunk of time immediately post-handling because thats a priori information that the fish was stressed. 

Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M1', Phase))
Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M2', Phase))
Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M1   ', Phase))
Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M2   ', Phase))

Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M1', Phase))
Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M2', Phase))
Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M1   ', Phase))
Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M2   ', Phase))

Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M1', Phase))
Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M2', Phase))
Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M1   ', Phase))
Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M2   ', Phase))

Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M1', Phase))
Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M2', Phase))
Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M1   ', Phase))
Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M2   ', Phase))

# Average lowest three

Fish1avgslopehour <- mean(head(Fish1_sorted_slopes$Slope.hour, 3))
Fish1avgslope <- mean(head(Fish1_sorted_slopes$Slope, 3))
Fish1avgR2 <- mean(head(Fish1_sorted_slopes$r2, 3))

Fish1finalRMR <- matrix(c(Fish1, Fish1avgslope, Fish1avgslopehour, Fish1avgR2), nrow=1, ncol=4)

Fish2avgslopehour <- mean(head(Fish2_sorted_slopes$Slope.hour, 3))
Fish2avgslope <- mean(head(Fish2_sorted_slopes$Slope, 3))
Fish2avgR2 <- mean(head(Fish2_sorted_slopes$r2, 3))

Fish2finalRMR <- matrix(c(Fish2, Fish2avgslope, Fish2avgslopehour, Fish2avgR2), nrow=1, ncol=4)

Fish3avgslopehour <- mean(head(Fish3_sorted_slopes$Slope.hour, 3))
Fish3avgslope <- mean(head(Fish3_sorted_slopes$Slope, 3))
Fish3avgR2 <- mean(head(Fish3_sorted_slopes$r2, 3))

Fish3finalRMR <- matrix(c(Fish3, Fish3avgslope, Fish3avgslopehour, Fish3avgR2), nrow=1, ncol=4)

Fish4avgslopehour <- mean(head(Fish4_sorted_slopes$Slope.hour, 3))
Fish4avgslope <- mean(head(Fish4_sorted_slopes$Slope, 3))
Fish4avgR2 <- mean(head(Fish4_sorted_slopes$r2, 3))

Fish4finalRMR <- matrix(c(Fish4, Fish4avgslope, Fish4avgslopehour, Fish4avgR2), nrow=1, ncol=4)

# Bind all fish from this trial together: 
average.slopes <- rbind(Fish1finalRMR, Fish2finalRMR, Fish3finalRMR, Fish4finalRMR)

#Add mean temp of this trial to final file: 
average.slopes <- cbind(average.slopes, mean(RMR$Temp))
colnames(average.slopes) <- c("FishID", "FinalSlope", "FinalSlopeHour", "FinalR2", "meanTemp")

slopes.all.final <- rbind(average.slopes, slopes.all.final)
```

#### D4_B1_P

```{r}
# Load txt file
RMR_raw <- readcleanplanktivore("2018_burbot_resp_D4_B1_P_raw.txt")

# Assign names for this trial: 

"Fish1" <- "D4_B1_P1"
"Fish2" <- "D4_B1_P2"
"Fish3" <- "D4_B1_P3"
"Fish4" <- "D4_B1_P4"

# Create a new column with the time in minutes from the start of the file: 

RMR_raw$Time.m <- sapply(seq_along(RMR_raw$DateTime),
function(i) as.numeric(difftime(RMR_raw$DateTime[i], RMR_raw$DateTime[1], units='mins')))


# Pull measure periods. Grep finds all of the data in the Phase column that contains the letter M. 

RMR <- RMR_raw[grep("M", RMR_raw$Phase), ]

# Pull out first value of each phase for graphing later
Phase.start <- ddply(RMR, "Phase", head, 1)
Phase.start <- Phase.start[,1:2]


# Change the column names of the chambers to the appropriate FishID:
Name.vec <- c(Fish1, Fish2, Fish3, Fish4)
names(RMR)[5:8] <- Name.vec


# Reshape the data so all O2 saturation values are in a single column:

RMR.2 <- melt(RMR, measure = Name.vec)

# Rename the columns. 
names(RMR.2) <-c("DateTime","Phase","Salinity","Temp","Time.m","FishID","O2.sat")

# Plot the measurement periods of all fish from this trial:
p=ggplot(data=RMR.2, aes(x=Time.m, y=O2.sat, group=Phase))
p+geom_point(aes(color=FishID))+theme_bw()


# Separate out individual fish for graphing/analysis:

## Separate each fish to it's own RMR file: 
Fish1_RMR <- filter(RMR.2, FishID == Fish1)
Fish2_RMR <- filter(RMR.2, FishID == Fish2)
Fish3_RMR <- filter(RMR.2, FishID == Fish3)
Fish4_RMR <- filter(RMR.2, FishID == Fish4)

# Determine length of measurment period because they vary between trials (ugh). I chose measurement period 5 so it's not in the first few measurement periods where we were switching them manually but not the last measurement period either in case it was cut short. 
(nrow(Fish1_RMR[Fish1_RMR$Phase == "M5",]))/60

# Determine total time in chambers (in hours) because this also slightly varied between trials (ugh). 
(nrow(RMR_raw))/60/60
```

```{r eval=FALSE}
## Plot individual measurement periods for each fish: 
p=ggplot(data=Fish1_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase), group=1)+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish1) 

p=ggplot(data=Fish2_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish2) 

p=ggplot(data=Fish3_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish3) 

p=ggplot(data=Fish4_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish4) 

##Plot individual measurement periods with the line of best fit: 

p=ggplot(data=Fish1_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish1) 

p=ggplot(data=Fish2_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish2) 

p=ggplot(data=Fish3_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish3) 

p=ggplot(data=Fish4_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish4) 
```

```{r}
# Calculate slopes of lines for each fish and convert slope from minutes to hours:
O2slopel1 <- dlply(Fish1_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope1 <- ldply(O2slopel1, function(d) coef(d))
names(O2slope1) <- c("Phase", "Intercept","Slope")
O2slope1<- mutate(O2slope1, FishID = Fish1)
O2slope1<-ddply(O2slope1, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel2 <- dlply(Fish2_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope2 <- ldply(O2slopel2, function(d) coef(d))
names(O2slope2) <- c("Phase", "Intercept","Slope")
O2slope2 <- mutate(O2slope2, FishID = Fish2)
O2slope2<-ddply(O2slope2, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel3 <- dlply(Fish3_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope3 <- ldply(O2slopel3, function(d) coef(d))
names(O2slope3) <- c("Phase", "Intercept","Slope")
O2slope3 <- mutate(O2slope3, FishID = Fish3)
O2slope3<-ddply(O2slope3, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel4 <- dlply(Fish4_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope4 <- ldply(O2slopel4, function(d) coef(d))
names(O2slope4) <- c("Phase", "Intercept","Slope")
O2slope4 <- mutate(O2slope4, FishID = Fish4)
O2slope4<-ddply(O2slope4, .(Phase), mutate, Slope.hour=Slope*60)


# Calculating the fit of each slope: 
O2.r2.1 <- dlply(Fish1_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit1<-ldply(O2.r2.1, function(d) d$r.squared)
slopefit1
names(slopefit1) <-c("Phase","r2")

O2.r2.2 <- dlply(Fish2_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit2<-ldply(O2.r2.2, function(d) d$r.squared)
slopefit2
names(slopefit2) <-c("Phase","r2")

O2.r2.3 <- dlply(Fish3_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit3<-ldply(O2.r2.3, function(d) d$r.squared)
slopefit3
names(slopefit3) <-c("Phase","r2")

O2.r2.4 <- dlply(Fish4_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit4<-ldply(O2.r2.4, function(d) d$r.squared)
slopefit4
names(slopefit4) <-c("Phase","r2")


# merge together slope and r2:
O2slope.r2.1<-merge(O2slope1, slopefit1, by=c("Phase"))
O2slope.r2.1<- O2slope.r2.1[mixedorder(O2slope.r2.1$Phase),]
O2slope.r2.1

O2slope.r2.2<-merge(O2slope2, slopefit2, by=c("Phase"))
O2slope.r2.2<- O2slope.r2.2[mixedorder(O2slope.r2.2$Phase),]
O2slope.r2.2

O2slope.r2.3<-merge(O2slope3, slopefit3, by=c("Phase"))
O2slope.r2.3<- O2slope.r2.3[mixedorder(O2slope.r2.3$Phase),]
O2slope.r2.3

O2slope.r2.4<-merge(O2slope4, slopefit4, by=c("Phase"))
O2slope.r2.4<- O2slope.r2.4[mixedorder(O2slope.r2.4$Phase),]
O2slope.r2.4

# bind all slope and r2 dataframes and sort the phases so they're in order:
slopes.r2.all <- rbind(O2slope.r2.1,O2slope.r2.2,O2slope.r2.3,O2slope.r2.4)
slopes.r2.all <- merge(slopes.r2.all, Phase.start, by=c("Phase"))
phase.sort <- unique(mixedsort(slopes.r2.all$Phase))
slopes.r2.all$Phase <- factor(slopes.r2.all$Phase, levels = phase.sort)

# Add mean temperature for that trial to the slopes.r2.all file. 
slopes.r2.all$meanTemp <- mean(RMR$Temp)

# Add in time from start of file

trial.first<- ddply(slopes.r2.all,"DateTime", head,1)
slopes.r2.all$Time.m <- difftime(slopes.r2.all$DateTime, head(trial.first$DateTime,1), units="mins", tz = "America/Los_Angeles")

# As you go through the text files from autoresp, you can consecutively add all of the slopes data, etc. to the slopes.all file, which is your big giant master file with all the data. After I calculate the slopes & r2 etc. for each file, then load the morphometrics data file and merge them together based on FishId. Bind days together first, then everything. 
slopes.all <- rbind(slopes.all, slopes.r2.all)


# Plot
ggplot(slopes.r2.all, aes(x=DateTime, y=(-1*Slope)))+
  geom_point(aes(color=FishID))+
  theme_bw()


# Sort based on slope value for every fish: 


Fish1_sorted_slopes <- O2slope.r2.1[order(-O2slope.r2.1$Slope.hour),]

Fish2_sorted_slopes <- O2slope.r2.2[order(-O2slope.r2.2$Slope.hour),]

Fish3_sorted_slopes <- O2slope.r2.3[order(-O2slope.r2.3$Slope.hour),]

Fish4_sorted_slopes <- O2slope.r2.4[order(-O2slope.r2.4$Slope.hour),]

# Remove the first two measurement periods. We don't want to include the first chunk of time immediately post-handling because thats a priori information that the fish was stressed. 

Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M1', Phase))
Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M2', Phase))
Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M1   ', Phase))
Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M2   ', Phase))

Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M1', Phase))
Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M2', Phase))
Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M1   ', Phase))
Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M2   ', Phase))

Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M1', Phase))
Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M2', Phase))
Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M1   ', Phase))
Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M2   ', Phase))

Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M1', Phase))
Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M2', Phase))
Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M1   ', Phase))
Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M2   ', Phase))

# Average lowest three

Fish1avgslopehour <- mean(head(Fish1_sorted_slopes$Slope.hour, 3))
Fish1avgslope <- mean(head(Fish1_sorted_slopes$Slope, 3))
Fish1avgR2 <- mean(head(Fish1_sorted_slopes$r2, 3))

Fish1finalRMR <- matrix(c(Fish1, Fish1avgslope, Fish1avgslopehour, Fish1avgR2), nrow=1, ncol=4)

Fish2avgslopehour <- mean(head(Fish2_sorted_slopes$Slope.hour, 3))
Fish2avgslope <- mean(head(Fish2_sorted_slopes$Slope, 3))
Fish2avgR2 <- mean(head(Fish2_sorted_slopes$r2, 3))

Fish2finalRMR <- matrix(c(Fish2, Fish2avgslope, Fish2avgslopehour, Fish2avgR2), nrow=1, ncol=4)

Fish3avgslopehour <- mean(head(Fish3_sorted_slopes$Slope.hour, 3))
Fish3avgslope <- mean(head(Fish3_sorted_slopes$Slope, 3))
Fish3avgR2 <- mean(head(Fish3_sorted_slopes$r2, 3))

Fish3finalRMR <- matrix(c(Fish3, Fish3avgslope, Fish3avgslopehour, Fish3avgR2), nrow=1, ncol=4)

Fish4avgslopehour <- mean(head(Fish4_sorted_slopes$Slope.hour, 3))
Fish4avgslope <- mean(head(Fish4_sorted_slopes$Slope, 3))
Fish4avgR2 <- mean(head(Fish4_sorted_slopes$r2, 3))

Fish4finalRMR <- matrix(c(Fish4, Fish4avgslope, Fish4avgslopehour, Fish4avgR2), nrow=1, ncol=4)

# Bind all fish from this trial together: 
average.slopes <- rbind(Fish1finalRMR, Fish2finalRMR, Fish3finalRMR, Fish4finalRMR)

#Add mean temp of this trial to final file: 
average.slopes <- cbind(average.slopes, mean(RMR$Temp))
colnames(average.slopes) <- c("FishID", "FinalSlope", "FinalSlopeHour", "FinalR2", "meanTemp")

slopes.all.final <- rbind(average.slopes, slopes.all.final)
```

#### D4_B2_P

```{r}
# Load txt file
RMR_raw <- readcleanplanktivore("2018_burbot_resp_D4_B2_P_raw.txt")

# Assign names for this trial: 

"Fish1" <- "D4_B2_P1"
"Fish2" <- "D4_B2_P2"
"Fish3" <- "D4_B2_P3"
"Fish4" <- "D4_B2_P4"

# Create a new column with the time in minutes from the start of the file: 

RMR_raw$Time.m <- sapply(seq_along(RMR_raw$DateTime),
function(i) as.numeric(difftime(RMR_raw$DateTime[i], RMR_raw$DateTime[1], units='mins')))


# Pull measure periods. Grep finds all of the data in the Phase column that contains the letter M. 

RMR <- RMR_raw[grep("M", RMR_raw$Phase), ]


# Pull out first value of each phase for graphing later
Phase.start <- ddply(RMR, "Phase", head, 1)
Phase.start <- Phase.start[,1:2]


# Change the column names of the chambers to the appropriate FishID:
Name.vec <- c(Fish1, Fish2, Fish3, Fish4)
names(RMR)[5:8] <- Name.vec


# Reshape the data so all O2 saturation values are in a single column:

RMR.2 <- melt(RMR, measure = Name.vec)

# Rename the columns. 
names(RMR.2) <-c("DateTime","Phase","Salinity","Temp","Time.m","FishID","O2.sat")

# Plot the measurement periods of all fish from this trial:
p=ggplot(data=RMR.2, aes(x=Time.m, y=O2.sat, group=Phase))
p+geom_point(aes(color=FishID))+theme_bw()


# Separate out individual fish for graphing/analysis:

## Separate each fish to it's own RMR file: 
Fish1_RMR <- filter(RMR.2, FishID == Fish1)
Fish2_RMR <- filter(RMR.2, FishID == Fish2)
Fish3_RMR <- filter(RMR.2, FishID == Fish3)
Fish4_RMR <- filter(RMR.2, FishID == Fish4)

# Determine length of measurment period because they vary between trials (ugh). I chose measurement period 5 so it's not in the first few measurement periods where we were switching them manually but not the last measurement period either in case it was cut short. 
(nrow(Fish1_RMR[Fish1_RMR$Phase == "M5",]))/60

# Determine total time in chambers (in hours) because this also slightly varied between trials (ugh). 
(nrow(RMR_raw))/60/60
```

```{r eval=FALSE}
## Plot individual measurement periods for each fish: 
p=ggplot(data=Fish1_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase), group=1)+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish1) 

p=ggplot(data=Fish2_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish2) 

p=ggplot(data=Fish3_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish3) 

p=ggplot(data=Fish4_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish4) 

##Plot individual measurement periods with the line of best fit: 

p=ggplot(data=Fish1_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish1) 

p=ggplot(data=Fish2_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish2) 

p=ggplot(data=Fish3_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish3) 

p=ggplot(data=Fish4_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish4) 
```

```{r}
# Calculate slopes of lines for each fish and convert slope from minutes to hours:
O2slopel1 <- dlply(Fish1_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope1 <- ldply(O2slopel1, function(d) coef(d))
names(O2slope1) <- c("Phase", "Intercept","Slope")
O2slope1<- mutate(O2slope1, FishID = Fish1)
O2slope1<-ddply(O2slope1, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel2 <- dlply(Fish2_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope2 <- ldply(O2slopel2, function(d) coef(d))
names(O2slope2) <- c("Phase", "Intercept","Slope")
O2slope2 <- mutate(O2slope2, FishID = Fish2)
O2slope2<-ddply(O2slope2, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel3 <- dlply(Fish3_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope3 <- ldply(O2slopel3, function(d) coef(d))
names(O2slope3) <- c("Phase", "Intercept","Slope")
O2slope3 <- mutate(O2slope3, FishID = Fish3)
O2slope3<-ddply(O2slope3, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel4 <- dlply(Fish4_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope4 <- ldply(O2slopel4, function(d) coef(d))
names(O2slope4) <- c("Phase", "Intercept","Slope")
O2slope4 <- mutate(O2slope4, FishID = Fish4)
O2slope4<-ddply(O2slope4, .(Phase), mutate, Slope.hour=Slope*60)


# Calculating the fit of each slope: 
O2.r2.1 <- dlply(Fish1_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit1<-ldply(O2.r2.1, function(d) d$r.squared)
slopefit1
names(slopefit1) <-c("Phase","r2")

O2.r2.2 <- dlply(Fish2_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit2<-ldply(O2.r2.2, function(d) d$r.squared)
slopefit2
names(slopefit2) <-c("Phase","r2")

O2.r2.3 <- dlply(Fish3_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit3<-ldply(O2.r2.3, function(d) d$r.squared)
slopefit3
names(slopefit3) <-c("Phase","r2")

O2.r2.4 <- dlply(Fish4_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit4<-ldply(O2.r2.4, function(d) d$r.squared)
slopefit4
names(slopefit4) <-c("Phase","r2")


# merge together slope and r2:
O2slope.r2.1<-merge(O2slope1, slopefit1, by=c("Phase"))
O2slope.r2.1<- O2slope.r2.1[mixedorder(O2slope.r2.1$Phase),]
O2slope.r2.1

O2slope.r2.2<-merge(O2slope2, slopefit2, by=c("Phase"))
O2slope.r2.2<- O2slope.r2.2[mixedorder(O2slope.r2.2$Phase),]
O2slope.r2.2

O2slope.r2.3<-merge(O2slope3, slopefit3, by=c("Phase"))
O2slope.r2.3<- O2slope.r2.3[mixedorder(O2slope.r2.3$Phase),]
O2slope.r2.3

O2slope.r2.4<-merge(O2slope4, slopefit4, by=c("Phase"))
O2slope.r2.4<- O2slope.r2.4[mixedorder(O2slope.r2.4$Phase),]
O2slope.r2.4

# bind all slope and r2 dataframes and sort the phases so they're in order:
slopes.r2.all <- rbind(O2slope.r2.1,O2slope.r2.2,O2slope.r2.3,O2slope.r2.4)
slopes.r2.all <- merge(slopes.r2.all, Phase.start, by=c("Phase"))
phase.sort <- unique(mixedsort(slopes.r2.all$Phase))
slopes.r2.all$Phase <- factor(slopes.r2.all$Phase, levels = phase.sort)


# Add mean temperature for that trial to the slopes.r2.all file. 
slopes.r2.all$meanTemp <- mean(RMR$Temp)

# Add in time from start of file

trial.first<- ddply(slopes.r2.all,"DateTime", head,1)
slopes.r2.all$Time.m <- difftime(slopes.r2.all$DateTime, head(trial.first$DateTime,1), units="mins", tz = "America/Los_Angeles")

# As you go through the text files from autoresp, you can consecutively add all of the slopes data, etc. to the slopes.all file, which is your big giant master file with all the data. After I calculate the slopes & r2 etc. for each file, then load the morphometrics data file and merge them together based on FishId. Bind days together first, then everything. 
slopes.all <- rbind(slopes.all, slopes.r2.all)


# Plot
ggplot(slopes.r2.all, aes(x=DateTime, y=(-1*Slope)))+
  geom_point(aes(color=FishID))+
  theme_bw()

# Sort based on slope value for every fish: 

Fish1_sorted_slopes <- O2slope.r2.1[order(-O2slope.r2.1$Slope.hour),]

Fish2_sorted_slopes <- O2slope.r2.2[order(-O2slope.r2.2$Slope.hour),]

Fish3_sorted_slopes <- O2slope.r2.3[order(-O2slope.r2.3$Slope.hour),]

Fish4_sorted_slopes <- O2slope.r2.4[order(-O2slope.r2.4$Slope.hour),]

# Remove the first two measurement periods. We don't want to include the first chunk of time immediately post-handling because thats a priori information that the fish was stressed. 

Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M1', Phase))
Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M2', Phase))
Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M1   ', Phase))
Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M2   ', Phase))

Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M1', Phase))
Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M2', Phase))
Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M1   ', Phase))
Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M2   ', Phase))

Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M1', Phase))
Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M2', Phase))
Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M1   ', Phase))
Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M2   ', Phase))

Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M1', Phase))
Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M2', Phase))
Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M1   ', Phase))
Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M2   ', Phase))

# Average lowest three

Fish1avgslopehour <- mean(head(Fish1_sorted_slopes$Slope.hour, 3))
Fish1avgslope <- mean(head(Fish1_sorted_slopes$Slope, 3))
Fish1avgR2 <- mean(head(Fish1_sorted_slopes$r2, 3))

Fish1finalRMR <- matrix(c(Fish1, Fish1avgslope, Fish1avgslopehour, Fish1avgR2), nrow=1, ncol=4)

Fish2avgslopehour <- mean(head(Fish2_sorted_slopes$Slope.hour, 3))
Fish2avgslope <- mean(head(Fish2_sorted_slopes$Slope, 3))
Fish2avgR2 <- mean(head(Fish2_sorted_slopes$r2, 3))

Fish2finalRMR <- matrix(c(Fish2, Fish2avgslope, Fish2avgslopehour, Fish2avgR2), nrow=1, ncol=4)

Fish3avgslopehour <- mean(head(Fish3_sorted_slopes$Slope.hour, 3))
Fish3avgslope <- mean(head(Fish3_sorted_slopes$Slope, 3))
Fish3avgR2 <- mean(head(Fish3_sorted_slopes$r2, 3))

Fish3finalRMR <- matrix(c(Fish3, Fish3avgslope, Fish3avgslopehour, Fish3avgR2), nrow=1, ncol=4)

Fish4avgslopehour <- mean(head(Fish4_sorted_slopes$Slope.hour, 3))
Fish4avgslope <- mean(head(Fish4_sorted_slopes$Slope, 3))
Fish4avgR2 <- mean(head(Fish4_sorted_slopes$r2, 3))

Fish4finalRMR <- matrix(c(Fish4, Fish4avgslope, Fish4avgslopehour, Fish4avgR2), nrow=1, ncol=4)

# Bind all fish from this trial together: 
average.slopes <- rbind(Fish1finalRMR, Fish2finalRMR, Fish3finalRMR, Fish4finalRMR)

#Add mean temp of this trial to final file: 
average.slopes <- cbind(average.slopes, mean(RMR$Temp))
colnames(average.slopes) <- c("FishID", "FinalSlope", "FinalSlopeHour", "FinalR2", "meanTemp")

slopes.all.final <- rbind(average.slopes, slopes.all.final)
```

#### D4_B3_P

```{r}
# Load txt file
RMR_raw <- readcleanplanktivore("2018_burbot_resp_D4_B3_P_raw.txt")

# Assign names for this trial: 

"Fish1" <- "D4_B3_P1"
"Fish2" <- "D4_B3_P2"
"Fish3" <- "D4_B3_P3"
"Fish4" <- "D4_B3_P4"

# Create a new column with the time in minutes from the start of the file: 

RMR_raw$Time.m <- sapply(seq_along(RMR_raw$DateTime),
function(i) as.numeric(difftime(RMR_raw$DateTime[i], RMR_raw$DateTime[1], units='mins')))


# Pull measure periods. Grep finds all of the data in the Phase column that contains the letter M. 

RMR <- RMR_raw[grep("M", RMR_raw$Phase), ]


# Pull out first value of each phase for graphing later
Phase.start <- ddply(RMR, "Phase", head, 1)
Phase.start <- Phase.start[,1:2]


# Change the column names of the chambers to the appropriate FishID:
Name.vec <- c(Fish1, Fish2, Fish3, Fish4)
names(RMR)[5:8] <- Name.vec


# Reshape the data so all O2 saturation values are in a single column:

RMR.2 <- melt(RMR, measure = Name.vec)

# Rename the columns. 
names(RMR.2) <-c("DateTime","Phase","Salinity","Temp","Time.m","FishID","O2.sat")

# Plot the measurement periods of all fish from this trial:
p=ggplot(data=RMR.2, aes(x=Time.m, y=O2.sat, group=Phase))
p+geom_point(aes(color=FishID))+theme_bw()


# Separate out individual fish for graphing/analysis:

## Separate each fish to it's own RMR file: 
Fish1_RMR <- filter(RMR.2, FishID == Fish1)
Fish2_RMR <- filter(RMR.2, FishID == Fish2)
Fish3_RMR <- filter(RMR.2, FishID == Fish3)
Fish4_RMR <- filter(RMR.2, FishID == Fish4)

# Determine length of measurment period because they vary between trials (ugh). I chose measurement period 5 so it's not in the first few measurement periods where we were switching them manually but not the last measurement period either in case it was cut short. 
(nrow(Fish1_RMR[Fish1_RMR$Phase == "M5   ",]))/60

# Determine total time in chambers (in hours) because this also slightly varied between trials (ugh). 
(nrow(RMR_raw))/60/60
```

```{r eval=FALSE}
## Plot individual measurement periods for each fish: 

p=ggplot(data=Fish1_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase), group=1)+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish1) 

p=ggplot(data=Fish2_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish2) 

p=ggplot(data=Fish3_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish3) 

p=ggplot(data=Fish4_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish4) 

##Plot individual measurement periods with the line of best fit: 

p=ggplot(data=Fish1_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish1) 

p=ggplot(data=Fish2_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish2) 

p=ggplot(data=Fish3_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish3) 

p=ggplot(data=Fish4_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish4) 
```

```{r}
# Calculate slopes of lines for each fish and convert slope from minutes to hours:
O2slopel1 <- dlply(Fish1_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope1 <- ldply(O2slopel1, function(d) coef(d))
names(O2slope1) <- c("Phase", "Intercept","Slope")
O2slope1<- mutate(O2slope1, FishID = Fish1)
O2slope1<-ddply(O2slope1, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel2 <- dlply(Fish2_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope2 <- ldply(O2slopel2, function(d) coef(d))
names(O2slope2) <- c("Phase", "Intercept","Slope")
O2slope2 <- mutate(O2slope2, FishID = Fish2)
O2slope2<-ddply(O2slope2, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel3 <- dlply(Fish3_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope3 <- ldply(O2slopel3, function(d) coef(d))
names(O2slope3) <- c("Phase", "Intercept","Slope")
O2slope3 <- mutate(O2slope3, FishID = Fish3)
O2slope3<-ddply(O2slope3, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel4 <- dlply(Fish4_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope4 <- ldply(O2slopel4, function(d) coef(d))
names(O2slope4) <- c("Phase", "Intercept","Slope")
O2slope4 <- mutate(O2slope4, FishID = Fish4)
O2slope4<-ddply(O2slope4, .(Phase), mutate, Slope.hour=Slope*60)


# Calculating the fit of each slope: 
O2.r2.1 <- dlply(Fish1_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit1<-ldply(O2.r2.1, function(d) d$r.squared)
slopefit1
names(slopefit1) <-c("Phase","r2")

O2.r2.2 <- dlply(Fish2_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit2<-ldply(O2.r2.2, function(d) d$r.squared)
slopefit2
names(slopefit2) <-c("Phase","r2")

O2.r2.3 <- dlply(Fish3_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit3<-ldply(O2.r2.3, function(d) d$r.squared)
slopefit3
names(slopefit3) <-c("Phase","r2")

O2.r2.4 <- dlply(Fish4_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit4<-ldply(O2.r2.4, function(d) d$r.squared)
slopefit4
names(slopefit4) <-c("Phase","r2")


# merge together slope and r2:
O2slope.r2.1<-merge(O2slope1, slopefit1, by=c("Phase"))
O2slope.r2.1<- O2slope.r2.1[mixedorder(O2slope.r2.1$Phase),]
O2slope.r2.1

O2slope.r2.2<-merge(O2slope2, slopefit2, by=c("Phase"))
O2slope.r2.2<- O2slope.r2.2[mixedorder(O2slope.r2.2$Phase),]
O2slope.r2.2

O2slope.r2.3<-merge(O2slope3, slopefit3, by=c("Phase"))
O2slope.r2.3<- O2slope.r2.3[mixedorder(O2slope.r2.3$Phase),]
O2slope.r2.3

O2slope.r2.4<-merge(O2slope4, slopefit4, by=c("Phase"))
O2slope.r2.4<- O2slope.r2.4[mixedorder(O2slope.r2.4$Phase),]
O2slope.r2.4

# bind all slope and r2 dataframes and sort the phases so they're in order:
slopes.r2.all <- rbind(O2slope.r2.1,O2slope.r2.2,O2slope.r2.3,O2slope.r2.4)
slopes.r2.all <- merge(slopes.r2.all, Phase.start, by=c("Phase"))
phase.sort <- unique(mixedsort(slopes.r2.all$Phase))
slopes.r2.all$Phase <- factor(slopes.r2.all$Phase, levels = phase.sort)


# Add mean temperature for that trial to the slopes.r2.all file. 
slopes.r2.all$meanTemp <- mean(RMR$Temp)

# Add in time from start of file

trial.first<- ddply(slopes.r2.all,"DateTime", head,1)
slopes.r2.all$Time.m <- difftime(slopes.r2.all$DateTime, head(trial.first$DateTime,1), units="mins", tz = "America/Los_Angeles")

# As you go through the text files from autoresp, you can consecutively add all of the slopes data, etc. to the slopes.all file, which is your big giant master file with all the data. After I calculate the slopes & r2 etc. for each file, then load the morphometrics data file and merge them together based on FishId. Bind days together first, then everything. 
slopes.all <- rbind(slopes.all, slopes.r2.all)

# Plot
ggplot(slopes.r2.all, aes(x=DateTime, y=(-1*Slope)))+
  geom_point(aes(color=FishID))+
  theme_bw()

# Sort based on slope value for every fish: 

Fish1_sorted_slopes <- O2slope.r2.1[order(-O2slope.r2.1$Slope.hour),]

Fish2_sorted_slopes <- O2slope.r2.2[order(-O2slope.r2.2$Slope.hour),]

Fish3_sorted_slopes <- O2slope.r2.3[order(-O2slope.r2.3$Slope.hour),]

Fish4_sorted_slopes <- O2slope.r2.4[order(-O2slope.r2.4$Slope.hour),]

# Remove the first two measurement periods. We don't want to include the first chunk of time immediately post-handling because thats a priori information that the fish was stressed. 

Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M1', Phase))
Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M2', Phase))
Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M1   ', Phase))
Fish1_sorted_slopes <- dplyr::filter(Fish1_sorted_slopes, !grepl('M2   ', Phase))

Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M1', Phase))
Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M2', Phase))
Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M1   ', Phase))
Fish2_sorted_slopes <- dplyr::filter(Fish2_sorted_slopes, !grepl('M2   ', Phase))

Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M1', Phase))
Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M2', Phase))
Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M1   ', Phase))
Fish3_sorted_slopes <- dplyr::filter(Fish3_sorted_slopes, !grepl('M2   ', Phase))

Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M1', Phase))
Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M2', Phase))
Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M1   ', Phase))
Fish4_sorted_slopes <- dplyr::filter(Fish4_sorted_slopes, !grepl('M2   ', Phase))

# Average lowest three

Fish1avgslopehour <- mean(head(Fish1_sorted_slopes$Slope.hour, 3))
Fish1avgslope <- mean(head(Fish1_sorted_slopes$Slope, 3))
Fish1avgR2 <- mean(head(Fish1_sorted_slopes$r2, 3))

Fish1finalRMR <- matrix(c(Fish1, Fish1avgslope, Fish1avgslopehour, Fish1avgR2), nrow=1, ncol=4)

Fish2avgslopehour <- mean(head(Fish2_sorted_slopes$Slope.hour, 3))
Fish2avgslope <- mean(head(Fish2_sorted_slopes$Slope, 3))
Fish2avgR2 <- mean(head(Fish2_sorted_slopes$r2, 3))

Fish2finalRMR <- matrix(c(Fish2, Fish2avgslope, Fish2avgslopehour, Fish2avgR2), nrow=1, ncol=4)

Fish3avgslopehour <- mean(head(Fish3_sorted_slopes$Slope.hour, 3))
Fish3avgslope <- mean(head(Fish3_sorted_slopes$Slope, 3))
Fish3avgR2 <- mean(head(Fish3_sorted_slopes$r2, 3))

Fish3finalRMR <- matrix(c(Fish3, Fish3avgslope, Fish3avgslopehour, Fish3avgR2), nrow=1, ncol=4)

Fish4avgslopehour <- mean(head(Fish4_sorted_slopes$Slope.hour, 3))
Fish4avgslope <- mean(head(Fish4_sorted_slopes$Slope, 3))
Fish4avgR2 <- mean(head(Fish4_sorted_slopes$r2, 3))

Fish4finalRMR <- matrix(c(Fish4, Fish4avgslope, Fish4avgslopehour, Fish4avgR2), nrow=1, ncol=4)

# Bind all fish from this trial together: 
average.slopes <- rbind(Fish1finalRMR, Fish2finalRMR, Fish3finalRMR, Fish4finalRMR)

#Add mean temp of this trial to final file: 
average.slopes <- cbind(average.slopes, mean(RMR$Temp))
colnames(average.slopes) <- c("FishID", "FinalSlope", "FinalSlopeHour", "FinalR2", "meanTemp")

slopes.all.final <- rbind(average.slopes, slopes.all.final)

```


### Blanks

#### D1_blank_C

```{r}
# Load txt file
RMR_raw <- readcleancannibal("2018_burbot_resp_D1_blank_C_raw.txt")

# Assign names for this trial: 

"Fish1" <- "D1_blank_C1"
"Fish2" <- "D1_blank_C2"
"Fish3" <- "D1_blank_C3"
"Fish4" <- "D1_blank_C4"

# Create a new column with the time in minutes from the start of the file: 

RMR_raw$Time.m <- sapply(seq_along(RMR_raw$DateTime),
function(i) as.numeric(difftime(RMR_raw$DateTime[i], RMR_raw$DateTime[1], units='mins')))


# Pull measure periods. Grep finds all of the data in the Phase column that contains the letter M. 

RMR <- RMR_raw[grep("M", RMR_raw$Phase), ]


# Pull out first value of each phase for graphing later
Phase.start <- ddply(RMR, "Phase", head, 1)
Phase.start <- Phase.start[,1:2]


# Change the column names of the chambers to the appropriate FishID:
Name.vec <- c(Fish1, Fish2, Fish3, Fish4)
names(RMR)[5:8] <- Name.vec


# Reshape the data so all O2 saturation values are in a single column:

RMR.2 <- melt(RMR, measure = Name.vec)

# Rename the columns. 
names(RMR.2) <-c("DateTime","Phase","Salinity","Temp","Time.m","FishID","O2.sat")

# Plot the measurement periods of all fish from this trial:
p=ggplot(data=RMR.2, aes(x=Time.m, y=O2.sat, group=Phase))
p+geom_point(aes(color=FishID))+theme_bw()


# Separate out individual fish for graphing/analysis:

## Separate each fish to it's own RMR file: 
Fish1_RMR <- filter(RMR.2, FishID == Fish1)
Fish2_RMR <- filter(RMR.2, FishID == Fish2)
Fish3_RMR <- filter(RMR.2, FishID == Fish3)
Fish4_RMR <- filter(RMR.2, FishID == Fish4)
```

```{r eval=FALSE}
## Plot individual measurement periods for each fish: 
p=ggplot(data=Fish1_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase), group=1)+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish1) 

p=ggplot(data=Fish2_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish2) 

p=ggplot(data=Fish3_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish3) 

p=ggplot(data=Fish4_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish4) 

##Plot individual measurement periods with the line of best fit: 

p=ggplot(data=Fish1_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish1) 

p=ggplot(data=Fish2_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish2) 

p=ggplot(data=Fish3_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish3) 

p=ggplot(data=Fish4_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish4) 
```

```{r}
# Calculate slopes of lines for each fish and convert slope from minutes to hours:
O2slopel1 <- dlply(Fish1_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope1 <- ldply(O2slopel1, function(d) coef(d))
names(O2slope1) <- c("Phase", "Intercept","Slope")
O2slope1<- mutate(O2slope1, FishID = Fish1)
O2slope1<-ddply(O2slope1, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel2 <- dlply(Fish2_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope2 <- ldply(O2slopel2, function(d) coef(d))
names(O2slope2) <- c("Phase", "Intercept","Slope")
O2slope2 <- mutate(O2slope2, FishID = Fish2)
O2slope2<-ddply(O2slope2, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel3 <- dlply(Fish3_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope3 <- ldply(O2slopel3, function(d) coef(d))
names(O2slope3) <- c("Phase", "Intercept","Slope")
O2slope3 <- mutate(O2slope3, FishID = Fish3)
O2slope3<-ddply(O2slope3, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel4 <- dlply(Fish4_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope4 <- ldply(O2slopel4, function(d) coef(d))
names(O2slope4) <- c("Phase", "Intercept","Slope")
O2slope4 <- mutate(O2slope4, FishID = Fish4)
O2slope4<-ddply(O2slope4, .(Phase), mutate, Slope.hour=Slope*60)


# Calculating the fit of each slope: 
O2.r2.1 <- dlply(Fish1_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit1<-ldply(O2.r2.1, function(d) d$r.squared)
slopefit1
names(slopefit1) <-c("Phase","r2")

O2.r2.2 <- dlply(Fish2_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit2<-ldply(O2.r2.2, function(d) d$r.squared)
slopefit2
names(slopefit2) <-c("Phase","r2")

O2.r2.3 <- dlply(Fish3_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit3<-ldply(O2.r2.3, function(d) d$r.squared)
slopefit3
names(slopefit3) <-c("Phase","r2")

O2.r2.4 <- dlply(Fish4_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit4<-ldply(O2.r2.4, function(d) d$r.squared)
slopefit4
names(slopefit4) <-c("Phase","r2")


# merge together slope and r2:
O2slope.r2.1<-merge(O2slope1, slopefit1, by=c("Phase"))
O2slope.r2.1<- O2slope.r2.1[mixedorder(O2slope.r2.1$Phase),]
O2slope.r2.1

O2slope.r2.2<-merge(O2slope2, slopefit2, by=c("Phase"))
O2slope.r2.2<- O2slope.r2.2[mixedorder(O2slope.r2.2$Phase),]
O2slope.r2.2

O2slope.r2.3<-merge(O2slope3, slopefit3, by=c("Phase"))
O2slope.r2.3<- O2slope.r2.3[mixedorder(O2slope.r2.3$Phase),]
O2slope.r2.3

O2slope.r2.4<-merge(O2slope4, slopefit4, by=c("Phase"))
O2slope.r2.4<- O2slope.r2.4[mixedorder(O2slope.r2.4$Phase),]
O2slope.r2.4

# bind all slope and r2 dataframes and sort the phases so they're in order:
slopes.r2.all <- rbind(O2slope.r2.1,O2slope.r2.2,O2slope.r2.3,O2slope.r2.4)
slopes.r2.all <- merge(slopes.r2.all, Phase.start, by=c("Phase"))
phase.sort <- unique(mixedsort(slopes.r2.all$Phase))
slopes.r2.all$Phase <- factor(slopes.r2.all$Phase, levels = phase.sort)


# Add mean temperature for that trial to the slopes.r2.all file. 
slopes.r2.all$meanTemp <- mean(RMR$Temp)

# Add in time from start of file

trial.first<- ddply(slopes.r2.all,"DateTime", head,1)
slopes.r2.all$Time.m <- difftime(slopes.r2.all$DateTime, head(trial.first$DateTime,1), units="mins", tz = "America/Los_Angeles")

# As you go through the text files from autoresp, you can consecutively add all of the slopes data, etc. to the slopes.all file, which is your big giant master file with all the data. After I calculate the slopes & r2 etc. for each file, then load the morphometrics data file and merge them together based on FishId. Bind days together first, then everything. 
slopes.all <- rbind(slopes.all, slopes.r2.all)


# Plot
ggplot(slopes.r2.all, aes(x=DateTime, y=Slope))+
  geom_point(aes(color=FishID))+
  theme_bw()


# Average all of the blank measurements: 

Fish1avgslopehour <- mean(O2slope.r2.1$Slope.hour)
Fish1avgslope <- mean(O2slope.r2.1$Slope)
Fish1avgR2 <- mean(O2slope.r2.1$r2)

Fish1finalRMR <- matrix(c(Fish1, Fish1avgslope, Fish1avgslopehour, Fish1avgR2), nrow=1, ncol=4)

Fish2avgslopehour <- mean(O2slope.r2.2$Slope.hour)
Fish2avgslope <- mean(O2slope.r2.2$Slope)
Fish2avgR2 <- mean(O2slope.r2.2$r2)

Fish2finalRMR <- matrix(c(Fish2, Fish2avgslope, Fish2avgslopehour, Fish2avgR2), nrow=1, ncol=4)

Fish3avgslopehour <- mean(O2slope.r2.3$Slope.hour)
Fish3avgslope <- mean(O2slope.r2.3$Slope)
Fish3avgR2 <- mean(O2slope.r2.3$r2)

Fish3finalRMR <- matrix(c(Fish3, Fish3avgslope, Fish3avgslopehour, Fish3avgR2), nrow=1, ncol=4)

Fish4avgslopehour <- mean(O2slope.r2.4$Slope.hour)
Fish4avgslope <- mean(O2slope.r2.4$Slope)
Fish4avgR2 <- mean(O2slope.r2.4$r2)

Fish4finalRMR <- matrix(c(Fish4, Fish4avgslope, Fish4avgslopehour, Fish4avgR2), nrow=1, ncol=4)

# Bind all blanks from this trial together: 
average.slopes <- rbind(Fish1finalRMR, Fish2finalRMR, Fish3finalRMR, Fish4finalRMR)

#Add mean temp of this trial to final file: 
average.slopes <- cbind(average.slopes, mean(RMR$Temp))
colnames(average.slopes) <- c("FishID", "FinalSlope", "FinalSlopeHour", "FinalR2", "meanTemp")

# Create a file for the blanks; 
slopes.all.final.blanks <- average.slopes # Note that you only run this line for the very first batch to generate the slopes.all file! 

```

#### D1_blank_P

```{r}
# Load txt file
RMR_raw <- readcleanplanktivore("2018_burbot_resp_D1_blank_P_raw.txt")

# Assign names for this trial: 

"Fish1" <- "D1_blank_P1"
"Fish2" <- "D1_blank_P2"
"Fish3" <- "D1_blank_P3"
"Fish4" <- "D1_blank_P4"

# Create a new column with the time in minutes from the start of the file: 

RMR_raw$Time.m <- sapply(seq_along(RMR_raw$DateTime),
function(i) as.numeric(difftime(RMR_raw$DateTime[i], RMR_raw$DateTime[1], units='mins')))


# Pull measure periods. Grep finds all of the data in the Phase column that contains the letter M. 

RMR <- RMR_raw[grep("M", RMR_raw$Phase), ]


# Pull out first value of each phase for graphing later
Phase.start <- ddply(RMR, "Phase", head, 1)
Phase.start <- Phase.start[,1:2]


# Change the column names of the chambers to the appropriate FishID:
Name.vec <- c(Fish1, Fish2, Fish3, Fish4)
names(RMR)[5:8] <- Name.vec


# Reshape the data so all O2 saturation values are in a single column:

RMR.2 <- melt(RMR, measure = Name.vec)

# Rename the columns. 
names(RMR.2) <-c("DateTime","Phase","Salinity","Temp","Time.m","FishID","O2.sat")

# Plot the measurement periods of all fish from this trial:
p=ggplot(data=RMR.2, aes(x=Time.m, y=O2.sat, group=Phase))
p+geom_point(aes(color=FishID))+theme_bw()


# Separate out individual fish for graphing/analysis:

## Separate each fish to it's own RMR file: 
Fish1_RMR <- filter(RMR.2, FishID == Fish1)
Fish2_RMR <- filter(RMR.2, FishID == Fish2)
Fish3_RMR <- filter(RMR.2, FishID == Fish3)
Fish4_RMR <- filter(RMR.2, FishID == Fish4)
```

```{r eval=FALSE}
## Plot individual measurement periods for each fish: 
p=ggplot(data=Fish1_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase), group=1)+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish1) 

p=ggplot(data=Fish2_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish2) 

p=ggplot(data=Fish3_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish3) 

p=ggplot(data=Fish4_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish4) 

##Plot individual measurement periods with the line of best fit: 

p=ggplot(data=Fish1_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish1) 

p=ggplot(data=Fish2_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish2) 

p=ggplot(data=Fish3_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish3) 

p=ggplot(data=Fish4_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish4) 
```

```{r}
# Calculate slopes of lines for each fish and convert slope from minutes to hours:
O2slopel1 <- dlply(Fish1_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope1 <- ldply(O2slopel1, function(d) coef(d))
names(O2slope1) <- c("Phase", "Intercept","Slope")
O2slope1<- mutate(O2slope1, FishID = Fish1)
O2slope1<-ddply(O2slope1, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel2 <- dlply(Fish2_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope2 <- ldply(O2slopel2, function(d) coef(d))
names(O2slope2) <- c("Phase", "Intercept","Slope")
O2slope2 <- mutate(O2slope2, FishID = Fish2)
O2slope2<-ddply(O2slope2, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel3 <- dlply(Fish3_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope3 <- ldply(O2slopel3, function(d) coef(d))
names(O2slope3) <- c("Phase", "Intercept","Slope")
O2slope3 <- mutate(O2slope3, FishID = Fish3)
O2slope3<-ddply(O2slope3, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel4 <- dlply(Fish4_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope4 <- ldply(O2slopel4, function(d) coef(d))
names(O2slope4) <- c("Phase", "Intercept","Slope")
O2slope4 <- mutate(O2slope4, FishID = Fish4)
O2slope4<-ddply(O2slope4, .(Phase), mutate, Slope.hour=Slope*60)


# Calculating the fit of each slope: 
O2.r2.1 <- dlply(Fish1_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit1<-ldply(O2.r2.1, function(d) d$r.squared)
slopefit1
names(slopefit1) <-c("Phase","r2")

O2.r2.2 <- dlply(Fish2_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit2<-ldply(O2.r2.2, function(d) d$r.squared)
slopefit2
names(slopefit2) <-c("Phase","r2")

O2.r2.3 <- dlply(Fish3_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit3<-ldply(O2.r2.3, function(d) d$r.squared)
slopefit3
names(slopefit3) <-c("Phase","r2")

O2.r2.4 <- dlply(Fish4_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit4<-ldply(O2.r2.4, function(d) d$r.squared)
slopefit4
names(slopefit4) <-c("Phase","r2")


# merge together slope and r2:
O2slope.r2.1<-merge(O2slope1, slopefit1, by=c("Phase"))
O2slope.r2.1<- O2slope.r2.1[mixedorder(O2slope.r2.1$Phase),]
O2slope.r2.1

O2slope.r2.2<-merge(O2slope2, slopefit2, by=c("Phase"))
O2slope.r2.2<- O2slope.r2.2[mixedorder(O2slope.r2.2$Phase),]
O2slope.r2.2

O2slope.r2.3<-merge(O2slope3, slopefit3, by=c("Phase"))
O2slope.r2.3<- O2slope.r2.3[mixedorder(O2slope.r2.3$Phase),]
O2slope.r2.3

O2slope.r2.4<-merge(O2slope4, slopefit4, by=c("Phase"))
O2slope.r2.4<- O2slope.r2.4[mixedorder(O2slope.r2.4$Phase),]
O2slope.r2.4

# bind all slope and r2 dataframes and sort the phases so they're in order:
slopes.r2.all <- rbind(O2slope.r2.1,O2slope.r2.2,O2slope.r2.3,O2slope.r2.4)
slopes.r2.all <- merge(slopes.r2.all, Phase.start, by=c("Phase"))
phase.sort <- unique(mixedsort(slopes.r2.all$Phase))
slopes.r2.all$Phase <- factor(slopes.r2.all$Phase, levels = phase.sort)


# Add mean temperature for that trial to the slopes.r2.all file. 
slopes.r2.all$meanTemp <- mean(RMR$Temp)

# Add in time from start of file

trial.first<- ddply(slopes.r2.all,"DateTime", head,1)
slopes.r2.all$Time.m <- difftime(slopes.r2.all$DateTime, head(trial.first$DateTime,1), units="mins", tz = "America/Los_Angeles")

# As you go through the text files from autoresp, you can consecutively add all of the slopes data, etc. to the slopes.all file, which is your big giant master file with all the data. After I calculate the slopes & r2 etc. for each file, then load the morphometrics data file and merge them together based on FishId. Bind days together first, then everything. 
slopes.all <- rbind(slopes.all, slopes.r2.all)


# Plot
ggplot(slopes.r2.all, aes(x=DateTime, y=(-1*Slope)))+
  geom_point(aes(color=FishID))+
  theme_bw()


# Average all of the blank measurements: 

Fish1avgslopehour <- mean(O2slope.r2.1$Slope.hour)
Fish1avgslope <- mean(O2slope.r2.1$Slope)
Fish1avgR2 <- mean(O2slope.r2.1$r2)

Fish1finalRMR <- matrix(c(Fish1, Fish1avgslope, Fish1avgslopehour, Fish1avgR2), nrow=1, ncol=4)

Fish2avgslopehour <- mean(O2slope.r2.2$Slope.hour)
Fish2avgslope <- mean(O2slope.r2.2$Slope)
Fish2avgR2 <- mean(O2slope.r2.2$r2)

Fish2finalRMR <- matrix(c(Fish2, Fish2avgslope, Fish2avgslopehour, Fish2avgR2), nrow=1, ncol=4)

Fish3avgslopehour <- mean(O2slope.r2.3$Slope.hour)
Fish3avgslope <- mean(O2slope.r2.3$Slope)
Fish3avgR2 <- mean(O2slope.r2.3$r2)

Fish3finalRMR <- matrix(c(Fish3, Fish3avgslope, Fish3avgslopehour, Fish3avgR2), nrow=1, ncol=4)

Fish4avgslopehour <- mean(O2slope.r2.4$Slope.hour)
Fish4avgslope <- mean(O2slope.r2.4$Slope)
Fish4avgR2 <- mean(O2slope.r2.4$r2)

Fish4finalRMR <- matrix(c(Fish4, Fish4avgslope, Fish4avgslopehour, Fish4avgR2), nrow=1, ncol=4)

# Bind all blanks from this trial together: 
average.slopes <- rbind(Fish1finalRMR, Fish2finalRMR, Fish3finalRMR, Fish4finalRMR)

#Add mean temp of this trial to final file: 
average.slopes <- cbind(average.slopes, mean(RMR$Temp))
colnames(average.slopes) <- c("FishID", "FinalSlope", "FinalSlopeHour", "FinalR2", "meanTemp")


slopes.all.final.blanks <- rbind(average.slopes, slopes.all.final.blanks)


```

#### D2_blank_C

```{r}
# Load txt file
RMR_raw <- readcleancannibal("2018_burbot_resp_D2_blank_C_raw.txt")

# Assign names for this trial: 

"Fish1" <- "D2_blank_C1"
"Fish2" <- "D2_blank_C2"
"Fish3" <- "D2_blank_C3"
"Fish4" <- "D2_blank_C4"

# Create a new column with the time in minutes from the start of the file: 

RMR_raw$Time.m <- sapply(seq_along(RMR_raw$DateTime),
function(i) as.numeric(difftime(RMR_raw$DateTime[i], RMR_raw$DateTime[1], units='mins')))


# Pull measure periods. Grep finds all of the data in the Phase column that contains the letter M. 

RMR <- RMR_raw[grep("M", RMR_raw$Phase), ]


# Pull out first value of each phase for graphing later
Phase.start <- ddply(RMR, "Phase", head, 1)
Phase.start <- Phase.start[,1:2]


# Change the column names of the chambers to the appropriate FishID:
Name.vec <- c(Fish1, Fish2, Fish3, Fish4)
names(RMR)[5:8] <- Name.vec


# Reshape the data so all O2 saturation values are in a single column:

RMR.2 <- melt(RMR, measure = Name.vec)

# Rename the columns. 
names(RMR.2) <-c("DateTime","Phase","Salinity","Temp","Time.m","FishID","O2.sat")

# Plot the measurement periods of all fish from this trial:
p=ggplot(data=RMR.2, aes(x=Time.m, y=O2.sat, group=Phase))
p+geom_point(aes(color=FishID))+theme_bw()


# Separate out individual fish for graphing/analysis:

## Separate each fish to it's own RMR file: 
Fish1_RMR <- filter(RMR.2, FishID == Fish1)
Fish2_RMR <- filter(RMR.2, FishID == Fish2)
Fish3_RMR <- filter(RMR.2, FishID == Fish3)
Fish4_RMR <- filter(RMR.2, FishID == Fish4)
```

```{r eval=FALSE}
## Plot individual measurement periods for each fish: 
p=ggplot(data=Fish1_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase), group=1)+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish1) 

p=ggplot(data=Fish2_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish2) 

p=ggplot(data=Fish3_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish3) 

p=ggplot(data=Fish4_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish4) 

##Plot individual measurement periods with the line of best fit: 

p=ggplot(data=Fish1_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish1) 

p=ggplot(data=Fish2_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish2) 

p=ggplot(data=Fish3_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish3) 

p=ggplot(data=Fish4_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish4) 
```

```{r}
# Calculate slopes of lines for each fish and convert slope from minutes to hours:
O2slopel1 <- dlply(Fish1_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope1 <- ldply(O2slopel1, function(d) coef(d))
names(O2slope1) <- c("Phase", "Intercept","Slope")
O2slope1<- mutate(O2slope1, FishID = Fish1)
O2slope1<-ddply(O2slope1, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel2 <- dlply(Fish2_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope2 <- ldply(O2slopel2, function(d) coef(d))
names(O2slope2) <- c("Phase", "Intercept","Slope")
O2slope2 <- mutate(O2slope2, FishID = Fish2)
O2slope2<-ddply(O2slope2, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel3 <- dlply(Fish3_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope3 <- ldply(O2slopel3, function(d) coef(d))
names(O2slope3) <- c("Phase", "Intercept","Slope")
O2slope3 <- mutate(O2slope3, FishID = Fish3)
O2slope3<-ddply(O2slope3, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel4 <- dlply(Fish4_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope4 <- ldply(O2slopel4, function(d) coef(d))
names(O2slope4) <- c("Phase", "Intercept","Slope")
O2slope4 <- mutate(O2slope4, FishID = Fish4)
O2slope4<-ddply(O2slope4, .(Phase), mutate, Slope.hour=Slope*60)


# Calculating the fit of each slope: 
O2.r2.1 <- dlply(Fish1_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit1<-ldply(O2.r2.1, function(d) d$r.squared)
slopefit1
names(slopefit1) <-c("Phase","r2")

O2.r2.2 <- dlply(Fish2_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit2<-ldply(O2.r2.2, function(d) d$r.squared)
slopefit2
names(slopefit2) <-c("Phase","r2")

O2.r2.3 <- dlply(Fish3_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit3<-ldply(O2.r2.3, function(d) d$r.squared)
slopefit3
names(slopefit3) <-c("Phase","r2")

O2.r2.4 <- dlply(Fish4_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit4<-ldply(O2.r2.4, function(d) d$r.squared)
slopefit4
names(slopefit4) <-c("Phase","r2")


# merge together slope and r2:
O2slope.r2.1<-merge(O2slope1, slopefit1, by=c("Phase"))
O2slope.r2.1<- O2slope.r2.1[mixedorder(O2slope.r2.1$Phase),]
O2slope.r2.1

O2slope.r2.2<-merge(O2slope2, slopefit2, by=c("Phase"))
O2slope.r2.2<- O2slope.r2.2[mixedorder(O2slope.r2.2$Phase),]
O2slope.r2.2

O2slope.r2.3<-merge(O2slope3, slopefit3, by=c("Phase"))
O2slope.r2.3<- O2slope.r2.3[mixedorder(O2slope.r2.3$Phase),]
O2slope.r2.3

O2slope.r2.4<-merge(O2slope4, slopefit4, by=c("Phase"))
O2slope.r2.4<- O2slope.r2.4[mixedorder(O2slope.r2.4$Phase),]
O2slope.r2.4

# bind all slope and r2 dataframes and sort the phases so they're in order:
slopes.r2.all <- rbind(O2slope.r2.1,O2slope.r2.2,O2slope.r2.3,O2slope.r2.4)
slopes.r2.all <- merge(slopes.r2.all, Phase.start, by=c("Phase"))
phase.sort <- unique(mixedsort(slopes.r2.all$Phase))
slopes.r2.all$Phase <- factor(slopes.r2.all$Phase, levels = phase.sort)

# Add mean temperature for that trial to the slopes.r2.all file. 
slopes.r2.all$meanTemp <- mean(RMR$Temp)

# Add in time from start of file

trial.first<- ddply(slopes.r2.all,"DateTime", head,1)
slopes.r2.all$Time.m <- difftime(slopes.r2.all$DateTime, head(trial.first$DateTime,1), units="mins", tz = "America/Los_Angeles")

# As you go through the text files from autoresp, you can consecutively add all of the slopes data, etc. to the slopes.all file, which is your big giant master file with all the data. After I calculate the slopes & r2 etc. for each file, then load the morphometrics data file and merge them together based on FishId. Bind days together first, then everything. 
slopes.all <- rbind(slopes.all, slopes.r2.all)


# Plot
ggplot(slopes.r2.all, aes(x=DateTime, y=(-1*Slope)))+
  geom_point(aes(color=FishID))+
  theme_bw()


# Average all of the blank measurements: 

Fish1avgslopehour <- mean(O2slope.r2.1$Slope.hour)
Fish1avgslope <- mean(O2slope.r2.1$Slope)
Fish1avgR2 <- mean(O2slope.r2.1$r2)

Fish1finalRMR <- matrix(c(Fish1, Fish1avgslope, Fish1avgslopehour, Fish1avgR2), nrow=1, ncol=4)

Fish2avgslopehour <- mean(O2slope.r2.2$Slope.hour)
Fish2avgslope <- mean(O2slope.r2.2$Slope)
Fish2avgR2 <- mean(O2slope.r2.2$r2)

Fish2finalRMR <- matrix(c(Fish2, Fish2avgslope, Fish2avgslopehour, Fish2avgR2), nrow=1, ncol=4)

Fish3avgslopehour <- mean(O2slope.r2.3$Slope.hour)
Fish3avgslope <- mean(O2slope.r2.3$Slope)
Fish3avgR2 <- mean(O2slope.r2.3$r2)

Fish3finalRMR <- matrix(c(Fish3, Fish3avgslope, Fish3avgslopehour, Fish3avgR2), nrow=1, ncol=4)

Fish4avgslopehour <- mean(O2slope.r2.4$Slope.hour)
Fish4avgslope <- mean(O2slope.r2.4$Slope)
Fish4avgR2 <- mean(O2slope.r2.4$r2)

Fish4finalRMR <- matrix(c(Fish4, Fish4avgslope, Fish4avgslopehour, Fish4avgR2), nrow=1, ncol=4)

# Bind all blanks from this trial together: 
average.slopes <- rbind(Fish1finalRMR, Fish2finalRMR, Fish3finalRMR, Fish4finalRMR)

#Add mean temp of this trial to final file: 
average.slopes <- cbind(average.slopes, mean(RMR$Temp))
colnames(average.slopes) <- c("FishID", "FinalSlope", "FinalSlopeHour", "FinalR2", "meanTemp")

slopes.all.final.blanks <- rbind(average.slopes, slopes.all.final.blanks)


```

#### D2_blank_P

```{r}
# Load txt file
RMR_raw <- readcleanplanktivore("2018_burbot_resp_D2_blank_P_raw.txt")

# Assign names for this trial: 

"Fish1" <- "D2_blank_P1"
"Fish2" <- "D2_blank_P2"
"Fish3" <- "D2_blank_P3"
"Fish4" <- "D2_blank_P4"

# Create a new column with the time in minutes from the start of the file: 

RMR_raw$Time.m <- sapply(seq_along(RMR_raw$DateTime),
function(i) as.numeric(difftime(RMR_raw$DateTime[i], RMR_raw$DateTime[1], units='mins')))


# Pull measure periods. Grep finds all of the data in the Phase column that contains the letter M. 

RMR <- RMR_raw[grep("M", RMR_raw$Phase), ]


# Pull out first value of each phase for graphing later
Phase.start <- ddply(RMR, "Phase", head, 1)
Phase.start <- Phase.start[,1:2]


# Change the column names of the chambers to the appropriate FishID:
Name.vec <- c(Fish1, Fish2, Fish3, Fish4)
names(RMR)[5:8] <- Name.vec


# Reshape the data so all O2 saturation values are in a single column:

RMR.2 <- melt(RMR, measure = Name.vec)

# Rename the columns. 
names(RMR.2) <-c("DateTime","Phase","Salinity","Temp","Time.m","FishID","O2.sat")

# Plot the measurement periods of all fish from this trial:
p=ggplot(data=RMR.2, aes(x=Time.m, y=O2.sat, group=Phase))
p+geom_point(aes(color=FishID))+theme_bw()


# Separate out individual fish for graphing/analysis:

## Separate each fish to it's own RMR file: 
Fish1_RMR <- filter(RMR.2, FishID == Fish1)
Fish2_RMR <- filter(RMR.2, FishID == Fish2)
Fish3_RMR <- filter(RMR.2, FishID == Fish3)
Fish4_RMR <- filter(RMR.2, FishID == Fish4)
```

```{r eval=FALSE}
## Plot individual measurement periods for each fish: 
p=ggplot(data=Fish1_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase), group=1)+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish1) 

p=ggplot(data=Fish2_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish2) 

p=ggplot(data=Fish3_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish3) 

p=ggplot(data=Fish4_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish4) 

##Plot individual measurement periods with the line of best fit: 

p=ggplot(data=Fish1_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish1) 

p=ggplot(data=Fish2_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish2) 

p=ggplot(data=Fish3_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish3) 

p=ggplot(data=Fish4_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish4) 
```

```{r}
# Calculate slopes of lines for each fish and convert slope from minutes to hours:
O2slopel1 <- dlply(Fish1_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope1 <- ldply(O2slopel1, function(d) coef(d))
names(O2slope1) <- c("Phase", "Intercept","Slope")
O2slope1<- mutate(O2slope1, FishID = Fish1)
O2slope1<-ddply(O2slope1, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel2 <- dlply(Fish2_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope2 <- ldply(O2slopel2, function(d) coef(d))
names(O2slope2) <- c("Phase", "Intercept","Slope")
O2slope2 <- mutate(O2slope2, FishID = Fish2)
O2slope2<-ddply(O2slope2, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel3 <- dlply(Fish3_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope3 <- ldply(O2slopel3, function(d) coef(d))
names(O2slope3) <- c("Phase", "Intercept","Slope")
O2slope3 <- mutate(O2slope3, FishID = Fish3)
O2slope3<-ddply(O2slope3, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel4 <- dlply(Fish4_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope4 <- ldply(O2slopel4, function(d) coef(d))
names(O2slope4) <- c("Phase", "Intercept","Slope")
O2slope4 <- mutate(O2slope4, FishID = Fish4)
O2slope4<-ddply(O2slope4, .(Phase), mutate, Slope.hour=Slope*60)


# Calculating the fit of each slope: 
O2.r2.1 <- dlply(Fish1_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit1<-ldply(O2.r2.1, function(d) d$r.squared)
slopefit1
names(slopefit1) <-c("Phase","r2")

O2.r2.2 <- dlply(Fish2_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit2<-ldply(O2.r2.2, function(d) d$r.squared)
slopefit2
names(slopefit2) <-c("Phase","r2")

O2.r2.3 <- dlply(Fish3_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit3<-ldply(O2.r2.3, function(d) d$r.squared)
slopefit3
names(slopefit3) <-c("Phase","r2")

O2.r2.4 <- dlply(Fish4_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit4<-ldply(O2.r2.4, function(d) d$r.squared)
slopefit4
names(slopefit4) <-c("Phase","r2")


# merge together slope and r2:
O2slope.r2.1<-merge(O2slope1, slopefit1, by=c("Phase"))
O2slope.r2.1<- O2slope.r2.1[mixedorder(O2slope.r2.1$Phase),]
O2slope.r2.1

O2slope.r2.2<-merge(O2slope2, slopefit2, by=c("Phase"))
O2slope.r2.2<- O2slope.r2.2[mixedorder(O2slope.r2.2$Phase),]
O2slope.r2.2

O2slope.r2.3<-merge(O2slope3, slopefit3, by=c("Phase"))
O2slope.r2.3<- O2slope.r2.3[mixedorder(O2slope.r2.3$Phase),]
O2slope.r2.3

O2slope.r2.4<-merge(O2slope4, slopefit4, by=c("Phase"))
O2slope.r2.4<- O2slope.r2.4[mixedorder(O2slope.r2.4$Phase),]
O2slope.r2.4

# bind all slope and r2 dataframes and sort the phases so they're in order:
slopes.r2.all <- rbind(O2slope.r2.1,O2slope.r2.2,O2slope.r2.3,O2slope.r2.4)
slopes.r2.all <- merge(slopes.r2.all, Phase.start, by=c("Phase"))
phase.sort <- unique(mixedsort(slopes.r2.all$Phase))
slopes.r2.all$Phase <- factor(slopes.r2.all$Phase, levels = phase.sort)


# Add mean temperature for that trial to the slopes.r2.all file. 
slopes.r2.all$meanTemp <- mean(RMR$Temp)

# Add in time from start of file

trial.first<- ddply(slopes.r2.all,"DateTime", head,1)
slopes.r2.all$Time.m <- difftime(slopes.r2.all$DateTime, head(trial.first$DateTime,1), units="mins", tz = "America/Los_Angeles")

# As you go through the text files from autoresp, you can consecutively add all of the slopes data, etc. to the slopes.all file, which is your big giant master file with all the data. After I calculate the slopes & r2 etc. for each file, then load the morphometrics data file and merge them together based on FishId. Bind days together first, then everything. 
slopes.all <- rbind(slopes.all, slopes.r2.all)


# Plot
ggplot(slopes.r2.all, aes(x=DateTime, y=Slope))+
  geom_point(aes(color=FishID))+
  theme_bw()


# Average all of the blank measurements: 

Fish1avgslopehour <- mean(O2slope.r2.1$Slope.hour)
Fish1avgslope <- mean(O2slope.r2.1$Slope)
Fish1avgR2 <- mean(O2slope.r2.1$r2)

Fish1finalRMR <- matrix(c(Fish1, Fish1avgslope, Fish1avgslopehour, Fish1avgR2), nrow=1, ncol=4)

Fish2avgslopehour <- mean(O2slope.r2.2$Slope.hour)
Fish2avgslope <- mean(O2slope.r2.2$Slope)
Fish2avgR2 <- mean(O2slope.r2.2$r2)

Fish2finalRMR <- matrix(c(Fish2, Fish2avgslope, Fish2avgslopehour, Fish2avgR2), nrow=1, ncol=4)

Fish3avgslopehour <- mean(O2slope.r2.3$Slope.hour)
Fish3avgslope <- mean(O2slope.r2.3$Slope)
Fish3avgR2 <- mean(O2slope.r2.3$r2)

Fish3finalRMR <- matrix(c(Fish3, Fish3avgslope, Fish3avgslopehour, Fish3avgR2), nrow=1, ncol=4)

Fish4avgslopehour <- mean(O2slope.r2.4$Slope.hour)
Fish4avgslope <- mean(O2slope.r2.4$Slope)
Fish4avgR2 <- mean(O2slope.r2.4$r2)

Fish4finalRMR <- matrix(c(Fish4, Fish4avgslope, Fish4avgslopehour, Fish4avgR2), nrow=1, ncol=4)

# Bind all blanks from this trial together: 
average.slopes <- rbind(Fish1finalRMR, Fish2finalRMR, Fish3finalRMR, Fish4finalRMR)

#Add mean temp of this trial to final file: 
average.slopes <- cbind(average.slopes, mean(RMR$Temp))
colnames(average.slopes) <- c("FishID", "FinalSlope", "FinalSlopeHour", "FinalR2", "meanTemp")

slopes.all.final.blanks <- rbind(average.slopes, slopes.all.final.blanks)


```


####D3_blank_C

```{r}
# Load txt file
RMR_raw <- readcleancannibal("2018_burbot_resp_D3_blank_C_raw.txt")

# Assign names for this trial: 

"Fish1" <- "D3_blank_C1"
"Fish2" <- "D3_blank_C2"
"Fish3" <- "D3_blank_C3"
"Fish4" <- "D3_blank_C4"

# Create a new column with the time in minutes from the start of the file: 

RMR_raw$Time.m <- sapply(seq_along(RMR_raw$DateTime),
function(i) as.numeric(difftime(RMR_raw$DateTime[i], RMR_raw$DateTime[1], units='mins')))


# Pull measure periods. Grep finds all of the data in the Phase column that contains the letter M. 

RMR <- RMR_raw[grep("M", RMR_raw$Phase), ]


# Pull out first value of each phase for graphing later
Phase.start <- ddply(RMR, "Phase", head, 1)
Phase.start <- Phase.start[,1:2]


# Change the column names of the chambers to the appropriate FishID:
Name.vec <- c(Fish1, Fish2, Fish3, Fish4)
names(RMR)[5:8] <- Name.vec


# Reshape the data so all O2 saturation values are in a single column:

RMR.2 <- melt(RMR, measure = Name.vec)

# Rename the columns. 
names(RMR.2) <-c("DateTime","Phase","Salinity","Temp","Time.m","FishID","O2.sat")

# Plot the measurement periods of all fish from this trial:
p=ggplot(data=RMR.2, aes(x=Time.m, y=O2.sat, group=Phase))
p+geom_point(aes(color=FishID))+theme_bw()


# Separate out individual fish for graphing/analysis:

## Separate each fish to it's own RMR file: 
Fish1_RMR <- filter(RMR.2, FishID == Fish1)
Fish2_RMR <- filter(RMR.2, FishID == Fish2)
Fish3_RMR <- filter(RMR.2, FishID == Fish3)
Fish4_RMR <- filter(RMR.2, FishID == Fish4)
```

```{r eval=FALSE}
## Plot individual measurement periods for each fish: 
p=ggplot(data=Fish1_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase), group=1)+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish1) 

p=ggplot(data=Fish2_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish2) 

p=ggplot(data=Fish3_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish3) 

p=ggplot(data=Fish4_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish4) 

##Plot individual measurement periods with the line of best fit: 

p=ggplot(data=Fish1_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish1) 

p=ggplot(data=Fish2_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish2) 

p=ggplot(data=Fish3_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish3) 

p=ggplot(data=Fish4_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish4) 
```

```{r}
# Calculate slopes of lines for each fish and convert slope from minutes to hours:
O2slopel1 <- dlply(Fish1_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope1 <- ldply(O2slopel1, function(d) coef(d))
names(O2slope1) <- c("Phase", "Intercept","Slope")
O2slope1<- mutate(O2slope1, FishID = Fish1)
O2slope1<-ddply(O2slope1, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel2 <- dlply(Fish2_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope2 <- ldply(O2slopel2, function(d) coef(d))
names(O2slope2) <- c("Phase", "Intercept","Slope")
O2slope2 <- mutate(O2slope2, FishID = Fish2)
O2slope2<-ddply(O2slope2, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel3 <- dlply(Fish3_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope3 <- ldply(O2slopel3, function(d) coef(d))
names(O2slope3) <- c("Phase", "Intercept","Slope")
O2slope3 <- mutate(O2slope3, FishID = Fish3)
O2slope3<-ddply(O2slope3, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel4 <- dlply(Fish4_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope4 <- ldply(O2slopel4, function(d) coef(d))
names(O2slope4) <- c("Phase", "Intercept","Slope")
O2slope4 <- mutate(O2slope4, FishID = Fish4)
O2slope4<-ddply(O2slope4, .(Phase), mutate, Slope.hour=Slope*60)


# Calculating the fit of each slope: 
O2.r2.1 <- dlply(Fish1_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit1<-ldply(O2.r2.1, function(d) d$r.squared)
slopefit1
names(slopefit1) <-c("Phase","r2")

O2.r2.2 <- dlply(Fish2_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit2<-ldply(O2.r2.2, function(d) d$r.squared)
slopefit2
names(slopefit2) <-c("Phase","r2")

O2.r2.3 <- dlply(Fish3_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit3<-ldply(O2.r2.3, function(d) d$r.squared)
slopefit3
names(slopefit3) <-c("Phase","r2")

O2.r2.4 <- dlply(Fish4_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit4<-ldply(O2.r2.4, function(d) d$r.squared)
slopefit4
names(slopefit4) <-c("Phase","r2")


# merge together slope and r2:
O2slope.r2.1<-merge(O2slope1, slopefit1, by=c("Phase"))
O2slope.r2.1<- O2slope.r2.1[mixedorder(O2slope.r2.1$Phase),]
O2slope.r2.1

O2slope.r2.2<-merge(O2slope2, slopefit2, by=c("Phase"))
O2slope.r2.2<- O2slope.r2.2[mixedorder(O2slope.r2.2$Phase),]
O2slope.r2.2

O2slope.r2.3<-merge(O2slope3, slopefit3, by=c("Phase"))
O2slope.r2.3<- O2slope.r2.3[mixedorder(O2slope.r2.3$Phase),]
O2slope.r2.3

O2slope.r2.4<-merge(O2slope4, slopefit4, by=c("Phase"))
O2slope.r2.4<- O2slope.r2.4[mixedorder(O2slope.r2.4$Phase),]
O2slope.r2.4

# bind all slope and r2 dataframes and sort the phases so they're in order:
slopes.r2.all <- rbind(O2slope.r2.1,O2slope.r2.2,O2slope.r2.3,O2slope.r2.4)
slopes.r2.all <- merge(slopes.r2.all, Phase.start, by=c("Phase"))
phase.sort <- unique(mixedsort(slopes.r2.all$Phase))
slopes.r2.all$Phase <- factor(slopes.r2.all$Phase, levels = phase.sort)

# Add mean temperature for that trial to the slopes.r2.all file. 
slopes.r2.all$meanTemp <- mean(RMR$Temp)

# Add in time from start of file

trial.first<- ddply(slopes.r2.all,"DateTime", head,1)
slopes.r2.all$Time.m <- difftime(slopes.r2.all$DateTime, head(trial.first$DateTime,1), units="mins", tz = "America/Los_Angeles")

# As you go through the text files from autoresp, you can consecutively add all of the slopes data, etc. to the slopes.all file, which is your big giant master file with all the data. After I calculate the slopes & r2 etc. for each file, then load the morphometrics data file and merge them together based on FishId. Bind days together first, then everything. 
slopes.all <- rbind(slopes.all, slopes.r2.all)


# Plot
ggplot(slopes.r2.all, aes(x=DateTime, y=Slope))+
  geom_point(aes(color=FishID))+
  theme_bw()

# Average all of the blank measurements: 

Fish1avgslopehour <- mean(O2slope.r2.1$Slope.hour)
Fish1avgslope <- mean(O2slope.r2.1$Slope)
Fish1avgR2 <- mean(O2slope.r2.1$r2)

Fish1finalRMR <- matrix(c(Fish1, Fish1avgslope, Fish1avgslopehour, Fish1avgR2), nrow=1, ncol=4)

Fish2avgslopehour <- mean(O2slope.r2.2$Slope.hour)
Fish2avgslope <- mean(O2slope.r2.2$Slope)
Fish2avgR2 <- mean(O2slope.r2.2$r2)

Fish2finalRMR <- matrix(c(Fish2, Fish2avgslope, Fish2avgslopehour, Fish2avgR2), nrow=1, ncol=4)

Fish3avgslopehour <- mean(O2slope.r2.3$Slope.hour)
Fish3avgslope <- mean(O2slope.r2.3$Slope)
Fish3avgR2 <- mean(O2slope.r2.3$r2)

Fish3finalRMR <- matrix(c(Fish3, Fish3avgslope, Fish3avgslopehour, Fish3avgR2), nrow=1, ncol=4)

Fish4avgslopehour <- mean(O2slope.r2.4$Slope.hour)
Fish4avgslope <- mean(O2slope.r2.4$Slope)
Fish4avgR2 <- mean(O2slope.r2.4$r2)

Fish4finalRMR <- matrix(c(Fish4, Fish4avgslope, Fish4avgslopehour, Fish4avgR2), nrow=1, ncol=4)

# Bind all blanks from this trial together: 
average.slopes <- rbind(Fish1finalRMR, Fish2finalRMR, Fish3finalRMR, Fish4finalRMR)

#Add mean temp of this trial to final file: 
average.slopes <- cbind(average.slopes, mean(RMR$Temp))
colnames(average.slopes) <- c("FishID", "FinalSlope", "FinalSlopeHour", "FinalR2", "meanTemp")

slopes.all.final.blanks <- rbind(average.slopes, slopes.all.final.blanks)


```

#### D3_blank_P

```{r}
# Load txt file
RMR_raw <- readcleanplanktivore("2018_burbot_resp_D3_blank_P_raw.txt")

# Assign names for this trial: 

"Fish1" <- "D3_blank_P1"
"Fish2" <- "D3_blank_P2"
"Fish3" <- "D3_blank_P3"
"Fish4" <- "D3_blank_P4"

# Create a new column with the time in minutes from the start of the file: 

RMR_raw$Time.m <- sapply(seq_along(RMR_raw$DateTime),
function(i) as.numeric(difftime(RMR_raw$DateTime[i], RMR_raw$DateTime[1], units='mins')))


# Pull measure periods. Grep finds all of the data in the Phase column that contains the letter M. 

RMR <- RMR_raw[grep("M", RMR_raw$Phase), ]


# Pull out first value of each phase for graphing later
Phase.start <- ddply(RMR, "Phase", head, 1)
Phase.start <- Phase.start[,1:2]


# Change the column names of the chambers to the appropriate FishID:
Name.vec <- c(Fish1, Fish2, Fish3, Fish4)
names(RMR)[5:8] <- Name.vec


# Reshape the data so all O2 saturation values are in a single column:

RMR.2 <- melt(RMR, measure = Name.vec)

# Rename the columns. 
names(RMR.2) <-c("DateTime","Phase","Salinity","Temp","Time.m","FishID","O2.sat")

# Plot the measurement periods of all fish from this trial:
p=ggplot(data=RMR.2, aes(x=Time.m, y=O2.sat, group=Phase))
p+geom_point(aes(color=FishID))+theme_bw()


# Separate out individual fish for graphing/analysis:

## Separate each fish to it's own RMR file: 
Fish1_RMR <- filter(RMR.2, FishID == Fish1)
Fish2_RMR <- filter(RMR.2, FishID == Fish2)
Fish3_RMR <- filter(RMR.2, FishID == Fish3)
Fish4_RMR <- filter(RMR.2, FishID == Fish4)
```

```{r eval=FALSE}
## Plot individual measurement periods for each fish: 
p=ggplot(data=Fish1_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase), group=1)+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish1) 

p=ggplot(data=Fish2_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish2) 

p=ggplot(data=Fish3_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish3) 

p=ggplot(data=Fish4_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish4) 

##Plot individual measurement periods with the line of best fit: 

p=ggplot(data=Fish1_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish1) 

p=ggplot(data=Fish2_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish2) 

p=ggplot(data=Fish3_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish3) 

p=ggplot(data=Fish4_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish4) 
```

```{r}
# Calculate slopes of lines for each fish and convert slope from minutes to hours:
O2slopel1 <- dlply(Fish1_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope1 <- ldply(O2slopel1, function(d) coef(d))
names(O2slope1) <- c("Phase", "Intercept","Slope")
O2slope1<- mutate(O2slope1, FishID = Fish1)
O2slope1<-ddply(O2slope1, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel2 <- dlply(Fish2_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope2 <- ldply(O2slopel2, function(d) coef(d))
names(O2slope2) <- c("Phase", "Intercept","Slope")
O2slope2 <- mutate(O2slope2, FishID = Fish2)
O2slope2<-ddply(O2slope2, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel3 <- dlply(Fish3_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope3 <- ldply(O2slopel3, function(d) coef(d))
names(O2slope3) <- c("Phase", "Intercept","Slope")
O2slope3 <- mutate(O2slope3, FishID = Fish3)
O2slope3<-ddply(O2slope3, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel4 <- dlply(Fish4_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope4 <- ldply(O2slopel4, function(d) coef(d))
names(O2slope4) <- c("Phase", "Intercept","Slope")
O2slope4 <- mutate(O2slope4, FishID = Fish4)
O2slope4<-ddply(O2slope4, .(Phase), mutate, Slope.hour=Slope*60)


# Calculating the fit of each slope: 
O2.r2.1 <- dlply(Fish1_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit1<-ldply(O2.r2.1, function(d) d$r.squared)
slopefit1
names(slopefit1) <-c("Phase","r2")

O2.r2.2 <- dlply(Fish2_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit2<-ldply(O2.r2.2, function(d) d$r.squared)
slopefit2
names(slopefit2) <-c("Phase","r2")

O2.r2.3 <- dlply(Fish3_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit3<-ldply(O2.r2.3, function(d) d$r.squared)
slopefit3
names(slopefit3) <-c("Phase","r2")

O2.r2.4 <- dlply(Fish4_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit4<-ldply(O2.r2.4, function(d) d$r.squared)
slopefit4
names(slopefit4) <-c("Phase","r2")


# merge together slope and r2:
O2slope.r2.1<-merge(O2slope1, slopefit1, by=c("Phase"))
O2slope.r2.1<- O2slope.r2.1[mixedorder(O2slope.r2.1$Phase),]
O2slope.r2.1

O2slope.r2.2<-merge(O2slope2, slopefit2, by=c("Phase"))
O2slope.r2.2<- O2slope.r2.2[mixedorder(O2slope.r2.2$Phase),]
O2slope.r2.2

O2slope.r2.3<-merge(O2slope3, slopefit3, by=c("Phase"))
O2slope.r2.3<- O2slope.r2.3[mixedorder(O2slope.r2.3$Phase),]
O2slope.r2.3

O2slope.r2.4<-merge(O2slope4, slopefit4, by=c("Phase"))
O2slope.r2.4<- O2slope.r2.4[mixedorder(O2slope.r2.4$Phase),]
O2slope.r2.4

# bind all slope and r2 dataframes and sort the phases so they're in order:
slopes.r2.all <- rbind(O2slope.r2.1,O2slope.r2.2,O2slope.r2.3,O2slope.r2.4)
slopes.r2.all <- merge(slopes.r2.all, Phase.start, by=c("Phase"))
phase.sort <- unique(mixedsort(slopes.r2.all$Phase))
slopes.r2.all$Phase <- factor(slopes.r2.all$Phase, levels = phase.sort)


# Add mean temperature for that trial to the slopes.r2.all file. 
slopes.r2.all$meanTemp <- mean(RMR$Temp)

# Add in time from start of file

trial.first<- ddply(slopes.r2.all,"DateTime", head,1)
slopes.r2.all$Time.m <- difftime(slopes.r2.all$DateTime, head(trial.first$DateTime,1), units="mins", tz = "America/Los_Angeles")

# As you go through the text files from autoresp, you can consecutively add all of the slopes data, etc. to the slopes.all file, which is your big giant master file with all the data. After I calculate the slopes & r2 etc. for each file, then load the morphometrics data file and merge them together based on FishId. Bind days together first, then everything. 
slopes.all <- rbind(slopes.all, slopes.r2.all)

# Plot
ggplot(slopes.r2.all, aes(x=DateTime, y=Slope))+
  geom_point(aes(color=FishID))+
  theme_bw()


# Average all of the blank measurements: 

Fish1avgslopehour <- mean(O2slope.r2.1$Slope.hour)
Fish1avgslope <- mean(O2slope.r2.1$Slope)
Fish1avgR2 <- mean(O2slope.r2.1$r2)

Fish1finalRMR <- matrix(c(Fish1, Fish1avgslope, Fish1avgslopehour, Fish1avgR2), nrow=1, ncol=4)

Fish2avgslopehour <- mean(O2slope.r2.2$Slope.hour)
Fish2avgslope <- mean(O2slope.r2.2$Slope)
Fish2avgR2 <- mean(O2slope.r2.2$r2)

Fish2finalRMR <- matrix(c(Fish2, Fish2avgslope, Fish2avgslopehour, Fish2avgR2), nrow=1, ncol=4)

Fish3avgslopehour <- mean(O2slope.r2.3$Slope.hour)
Fish3avgslope <- mean(O2slope.r2.3$Slope)
Fish3avgR2 <- mean(O2slope.r2.3$r2)

Fish3finalRMR <- matrix(c(Fish3, Fish3avgslope, Fish3avgslopehour, Fish3avgR2), nrow=1, ncol=4)

Fish4avgslopehour <- mean(O2slope.r2.4$Slope.hour)
Fish4avgslope <- mean(O2slope.r2.4$Slope)
Fish4avgR2 <- mean(O2slope.r2.4$r2)

Fish4finalRMR <- matrix(c(Fish4, Fish4avgslope, Fish4avgslopehour, Fish4avgR2), nrow=1, ncol=4)

# Bind all blanks from this trial together: 
average.slopes <- rbind(Fish1finalRMR, Fish2finalRMR, Fish3finalRMR, Fish4finalRMR)

#Add mean temp of this trial to final file: 
average.slopes <- cbind(average.slopes, mean(RMR$Temp))
colnames(average.slopes) <- c("FishID", "FinalSlope", "FinalSlopeHour", "FinalR2", "meanTemp")

slopes.all.final.blanks <- rbind(average.slopes, slopes.all.final.blanks)


```

#### D4_blank_C

```{r}
# Load txt file
RMR_raw <- readcleancannibal("2018_burbot_resp_D4_blank_C_raw.txt")

# Assign names for this trial: 

"Fish1" <- "D4_blank_C1"
"Fish2" <- "D4_blank_C2"
"Fish3" <- "D4_blank_C3"
"Fish4" <- "D4_blank_C4"

# Create a new column with the time in minutes from the start of the file: 

RMR_raw$Time.m <- sapply(seq_along(RMR_raw$DateTime),
function(i) as.numeric(difftime(RMR_raw$DateTime[i], RMR_raw$DateTime[1], units='mins')))


# Pull measure periods. Grep finds all of the data in the Phase column that contains the letter M. 

RMR <- RMR_raw[grep("M", RMR_raw$Phase), ]


# Pull out first value of each phase for graphing later
Phase.start <- ddply(RMR, "Phase", head, 1)
Phase.start <- Phase.start[,1:2]

# Change the column names of the chambers to the appropriate FishID:
Name.vec <- c(Fish1, Fish2, Fish3, Fish4)
names(RMR)[5:8] <- Name.vec


# Reshape the data so all O2 saturation values are in a single column:

RMR.2 <- melt(RMR, measure = Name.vec)

# Rename the columns. 
names(RMR.2) <-c("DateTime","Phase","Salinity","Temp","Time.m","FishID","O2.sat")

# Plot the measurement periods of all fish from this trial:
p=ggplot(data=RMR.2, aes(x=Time.m, y=O2.sat, group=Phase))
p+geom_point(aes(color=FishID))+theme_bw()


# Separate out individual fish for graphing/analysis:

## Separate each fish to it's own RMR file: 
Fish1_RMR <- filter(RMR.2, FishID == Fish1)
Fish2_RMR <- filter(RMR.2, FishID == Fish2)
Fish3_RMR <- filter(RMR.2, FishID == Fish3)
Fish4_RMR <- filter(RMR.2, FishID == Fish4)
```

```{r eval=FALSE}
## Plot individual measurement periods for each fish: 
p=ggplot(data=Fish1_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase), group=1)+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish1) 

p=ggplot(data=Fish2_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish2) 

p=ggplot(data=Fish3_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish3) 

p=ggplot(data=Fish4_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish4) 

##Plot individual measurement periods with the line of best fit: 

p=ggplot(data=Fish1_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish1) 

p=ggplot(data=Fish2_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish2) 

p=ggplot(data=Fish3_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish3) 

p=ggplot(data=Fish4_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish4) 
```

```{r}
# Calculate slopes of lines for each fish and convert slope from minutes to hours:
O2slopel1 <- dlply(Fish1_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope1 <- ldply(O2slopel1, function(d) coef(d))
names(O2slope1) <- c("Phase", "Intercept","Slope")
O2slope1<- mutate(O2slope1, FishID = Fish1)
O2slope1<-ddply(O2slope1, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel2 <- dlply(Fish2_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope2 <- ldply(O2slopel2, function(d) coef(d))
names(O2slope2) <- c("Phase", "Intercept","Slope")
O2slope2 <- mutate(O2slope2, FishID = Fish2)
O2slope2<-ddply(O2slope2, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel3 <- dlply(Fish3_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope3 <- ldply(O2slopel3, function(d) coef(d))
names(O2slope3) <- c("Phase", "Intercept","Slope")
O2slope3 <- mutate(O2slope3, FishID = Fish3)
O2slope3<-ddply(O2slope3, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel4 <- dlply(Fish4_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope4 <- ldply(O2slopel4, function(d) coef(d))
names(O2slope4) <- c("Phase", "Intercept","Slope")
O2slope4 <- mutate(O2slope4, FishID = Fish4)
O2slope4<-ddply(O2slope4, .(Phase), mutate, Slope.hour=Slope*60)


# Calculating the fit of each slope: 
O2.r2.1 <- dlply(Fish1_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit1<-ldply(O2.r2.1, function(d) d$r.squared)
slopefit1
names(slopefit1) <-c("Phase","r2")

O2.r2.2 <- dlply(Fish2_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit2<-ldply(O2.r2.2, function(d) d$r.squared)
slopefit2
names(slopefit2) <-c("Phase","r2")

O2.r2.3 <- dlply(Fish3_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit3<-ldply(O2.r2.3, function(d) d$r.squared)
slopefit3
names(slopefit3) <-c("Phase","r2")

O2.r2.4 <- dlply(Fish4_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit4<-ldply(O2.r2.4, function(d) d$r.squared)
slopefit4
names(slopefit4) <-c("Phase","r2")


# merge together slope and r2:
O2slope.r2.1<-merge(O2slope1, slopefit1, by=c("Phase"))
O2slope.r2.1<- O2slope.r2.1[mixedorder(O2slope.r2.1$Phase),]
O2slope.r2.1

O2slope.r2.2<-merge(O2slope2, slopefit2, by=c("Phase"))
O2slope.r2.2<- O2slope.r2.2[mixedorder(O2slope.r2.2$Phase),]
O2slope.r2.2

O2slope.r2.3<-merge(O2slope3, slopefit3, by=c("Phase"))
O2slope.r2.3<- O2slope.r2.3[mixedorder(O2slope.r2.3$Phase),]
O2slope.r2.3

O2slope.r2.4<-merge(O2slope4, slopefit4, by=c("Phase"))
O2slope.r2.4<- O2slope.r2.4[mixedorder(O2slope.r2.4$Phase),]
O2slope.r2.4

# bind all slope and r2 dataframes and sort the phases so they're in order:
slopes.r2.all <- rbind(O2slope.r2.1,O2slope.r2.2,O2slope.r2.3,O2slope.r2.4)
slopes.r2.all <- merge(slopes.r2.all, Phase.start, by=c("Phase"))
phase.sort <- unique(mixedsort(slopes.r2.all$Phase))
slopes.r2.all$Phase <- factor(slopes.r2.all$Phase, levels = phase.sort)


# Add mean temperature for that trial to the slopes.r2.all file. 
slopes.r2.all$meanTemp <- mean(RMR$Temp)

# Add in time from start of file

trial.first<- ddply(slopes.r2.all,"DateTime", head,1)
slopes.r2.all$Time.m <- difftime(slopes.r2.all$DateTime, head(trial.first$DateTime,1), units="mins", tz = "America/Los_Angeles")

# As you go through the text files from autoresp, you can consecutively add all of the slopes data, etc. to the slopes.all file, which is your big giant master file with all the data. After I calculate the slopes & r2 etc. for each file, then load the morphometrics data file and merge them together based on FishId. Bind days together first, then everything. 
slopes.all <- rbind(slopes.all, slopes.r2.all)


# Plot
ggplot(slopes.r2.all, aes(x=DateTime, y=Slope))+
  geom_point(aes(color=FishID))+
  theme_bw()


# Average all of the blank measurements: 

Fish1avgslopehour <- mean(O2slope.r2.1$Slope.hour)
Fish1avgslope <- mean(O2slope.r2.1$Slope)
Fish1avgR2 <- mean(O2slope.r2.1$r2)

Fish1finalRMR <- matrix(c(Fish1, Fish1avgslope, Fish1avgslopehour, Fish1avgR2), nrow=1, ncol=4)

Fish2avgslopehour <- mean(O2slope.r2.2$Slope.hour)
Fish2avgslope <- mean(O2slope.r2.2$Slope)
Fish2avgR2 <- mean(O2slope.r2.2$r2)

Fish2finalRMR <- matrix(c(Fish2, Fish2avgslope, Fish2avgslopehour, Fish2avgR2), nrow=1, ncol=4)

Fish3avgslopehour <- mean(O2slope.r2.3$Slope.hour)
Fish3avgslope <- mean(O2slope.r2.3$Slope)
Fish3avgR2 <- mean(O2slope.r2.3$r2)

Fish3finalRMR <- matrix(c(Fish3, Fish3avgslope, Fish3avgslopehour, Fish3avgR2), nrow=1, ncol=4)

Fish4avgslopehour <- mean(O2slope.r2.4$Slope.hour)
Fish4avgslope <- mean(O2slope.r2.4$Slope)
Fish4avgR2 <- mean(O2slope.r2.4$r2)

Fish4finalRMR <- matrix(c(Fish4, Fish4avgslope, Fish4avgslopehour, Fish4avgR2), nrow=1, ncol=4)

# Bind all blanks from this trial together: 
average.slopes <- rbind(Fish1finalRMR, Fish2finalRMR, Fish3finalRMR, Fish4finalRMR)

#Add mean temp of this trial to final file: 
average.slopes <- cbind(average.slopes, mean(RMR$Temp))
colnames(average.slopes) <- c("FishID", "FinalSlope", "FinalSlopeHour", "FinalR2", "meanTemp")

slopes.all.final.blanks <- rbind(average.slopes, slopes.all.final.blanks)


```

#### D4_blank_P

```{r}
# Load txt file
RMR_raw <- readcleanplanktivore("2018_burbot_resp_D4_blank_P_raw.txt")

# Assign names for this trial: 

"Fish1" <- "D4_blank_P1"
"Fish2" <- "D4_blank_P2"
"Fish3" <- "D4_blank_P3"
"Fish4" <- "D4_blank_P4"

# Create a new column with the time in minutes from the start of the file: 

RMR_raw$Time.m <- sapply(seq_along(RMR_raw$DateTime),
function(i) as.numeric(difftime(RMR_raw$DateTime[i], RMR_raw$DateTime[1], units='mins')))


# Pull measure periods. Grep finds all of the data in the Phase column that contains the letter M. 

RMR <- RMR_raw[grep("M", RMR_raw$Phase), ]


# Pull out first value of each phase for graphing later
Phase.start <- ddply(RMR, "Phase", head, 1)
Phase.start <- Phase.start[,1:2]


# Change the column names of the chambers to the appropriate FishID:
Name.vec <- c(Fish1, Fish2, Fish3, Fish4)
names(RMR)[5:8] <- Name.vec


# Reshape the data so all O2 saturation values are in a single column:

RMR.2 <- melt(RMR, measure = Name.vec)

# Rename the columns. 
names(RMR.2) <-c("DateTime","Phase","Salinity","Temp","Time.m","FishID","O2.sat")

# Plot the measurement periods of all fish from this trial:
p=ggplot(data=RMR.2, aes(x=Time.m, y=O2.sat, group=Phase))
p+geom_point(aes(color=FishID))+theme_bw()


# Separate out individual fish for graphing/analysis:

## Separate each fish to it's own RMR file: 
Fish1_RMR <- filter(RMR.2, FishID == Fish1)
Fish2_RMR <- filter(RMR.2, FishID == Fish2)
Fish3_RMR <- filter(RMR.2, FishID == Fish3)
Fish4_RMR <- filter(RMR.2, FishID == Fish4)
```

```{r eval=FALSE}
## Plot individual measurement periods for each fish: 
p=ggplot(data=Fish1_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase), group=1)+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish1) 

p=ggplot(data=Fish2_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish2) 

p=ggplot(data=Fish3_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish3) 

p=ggplot(data=Fish4_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  labs(title = Fish4) 

##Plot individual measurement periods with the line of best fit: 

p=ggplot(data=Fish1_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish1) 

p=ggplot(data=Fish2_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish2) 

p=ggplot(data=Fish3_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish3) 

p=ggplot(data=Fish4_RMR, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation", breaks=seq(90, 160, 50))+
  scale_x_continuous(name="Time (min)") +
  geom_smooth(method="lm", color="black") +
  labs(title = Fish4) 
```

```{r}
# Calculate slopes of lines for each fish and convert slope from minutes to hours:
O2slopel1 <- dlply(Fish1_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope1 <- ldply(O2slopel1, function(d) coef(d))
names(O2slope1) <- c("Phase", "Intercept","Slope")
O2slope1<- mutate(O2slope1, FishID = Fish1)
O2slope1<-ddply(O2slope1, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel2 <- dlply(Fish2_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope2 <- ldply(O2slopel2, function(d) coef(d))
names(O2slope2) <- c("Phase", "Intercept","Slope")
O2slope2 <- mutate(O2slope2, FishID = Fish2)
O2slope2<-ddply(O2slope2, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel3 <- dlply(Fish3_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope3 <- ldply(O2slopel3, function(d) coef(d))
names(O2slope3) <- c("Phase", "Intercept","Slope")
O2slope3 <- mutate(O2slope3, FishID = Fish3)
O2slope3<-ddply(O2slope3, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel4 <- dlply(Fish4_RMR, .(Phase), function(d) lm(O2.sat ~ Time.m, data = d))
O2slope4 <- ldply(O2slopel4, function(d) coef(d))
names(O2slope4) <- c("Phase", "Intercept","Slope")
O2slope4 <- mutate(O2slope4, FishID = Fish4)
O2slope4<-ddply(O2slope4, .(Phase), mutate, Slope.hour=Slope*60)


# Calculating the fit of each slope: 
O2.r2.1 <- dlply(Fish1_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit1<-ldply(O2.r2.1, function(d) d$r.squared)
slopefit1
names(slopefit1) <-c("Phase","r2")

O2.r2.2 <- dlply(Fish2_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit2<-ldply(O2.r2.2, function(d) d$r.squared)
slopefit2
names(slopefit2) <-c("Phase","r2")

O2.r2.3 <- dlply(Fish3_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit3<-ldply(O2.r2.3, function(d) d$r.squared)
slopefit3
names(slopefit3) <-c("Phase","r2")

O2.r2.4 <- dlply(Fish4_RMR, .(Phase), function(d) summary(lm(O2.sat ~ Time.m, data = d))) 
slopefit4<-ldply(O2.r2.4, function(d) d$r.squared)
slopefit4
names(slopefit4) <-c("Phase","r2")


# merge together slope and r2:
O2slope.r2.1<-merge(O2slope1, slopefit1, by=c("Phase"))
O2slope.r2.1<- O2slope.r2.1[mixedorder(O2slope.r2.1$Phase),]
O2slope.r2.1

O2slope.r2.2<-merge(O2slope2, slopefit2, by=c("Phase"))
O2slope.r2.2<- O2slope.r2.2[mixedorder(O2slope.r2.2$Phase),]
O2slope.r2.2

O2slope.r2.3<-merge(O2slope3, slopefit3, by=c("Phase"))
O2slope.r2.3<- O2slope.r2.3[mixedorder(O2slope.r2.3$Phase),]
O2slope.r2.3

O2slope.r2.4<-merge(O2slope4, slopefit4, by=c("Phase"))
O2slope.r2.4<- O2slope.r2.4[mixedorder(O2slope.r2.4$Phase),]
O2slope.r2.4

# bind all slope and r2 dataframes and sort the phases so they're in order:
slopes.r2.all <- rbind(O2slope.r2.1,O2slope.r2.2,O2slope.r2.3,O2slope.r2.4)
slopes.r2.all <- merge(slopes.r2.all, Phase.start, by=c("Phase"))
phase.sort <- unique(mixedsort(slopes.r2.all$Phase))
slopes.r2.all$Phase <- factor(slopes.r2.all$Phase, levels = phase.sort)


# Add mean temperature for that trial to the slopes.r2.all file. 
slopes.r2.all$meanTemp <- mean(RMR$Temp)

# Add in time from start of file

trial.first<- ddply(slopes.r2.all,"DateTime", head,1)
slopes.r2.all$Time.m <- difftime(slopes.r2.all$DateTime, head(trial.first$DateTime,1), units="mins", tz = "America/Los_Angeles")

# As you go through the text files from autoresp, you can consecutively add all of the slopes data, etc. to the slopes.all file, which is your big giant master file with all the data. After I calculate the slopes & r2 etc. for each file, then load the morphometrics data file and merge them together based on FishId. Bind days together first, then everything. 
slopes.all <- rbind(slopes.all, slopes.r2.all)

# Plot
ggplot(slopes.r2.all, aes(x=DateTime, y=Slope))+
  geom_point(aes(color=FishID))+
  theme_bw()

ggplot(slopes.all, aes(x=Time.m, y=Slope))+
  geom_point(aes(color=FishID))+
  theme_bw()

# Average all of the blank measurements: 

Fish1avgslopehour <- mean(O2slope.r2.1$Slope.hour)
Fish1avgslope <- mean(O2slope.r2.1$Slope)
Fish1avgR2 <- mean(O2slope.r2.1$r2)

Fish1finalRMR <- matrix(c(Fish1, Fish1avgslope, Fish1avgslopehour, Fish1avgR2), nrow=1, ncol=4)

Fish2avgslopehour <- mean(O2slope.r2.2$Slope.hour)
Fish2avgslope <- mean(O2slope.r2.2$Slope)
Fish2avgR2 <- mean(O2slope.r2.2$r2)

Fish2finalRMR <- matrix(c(Fish2, Fish2avgslope, Fish2avgslopehour, Fish2avgR2), nrow=1, ncol=4)

Fish3avgslopehour <- mean(O2slope.r2.3$Slope.hour)
Fish3avgslope <- mean(O2slope.r2.3$Slope)
Fish3avgR2 <- mean(O2slope.r2.3$r2)

Fish3finalRMR <- matrix(c(Fish3, Fish3avgslope, Fish3avgslopehour, Fish3avgR2), nrow=1, ncol=4)

Fish4avgslopehour <- mean(O2slope.r2.4$Slope.hour)
Fish4avgslope <- mean(O2slope.r2.4$Slope)
Fish4avgR2 <- mean(O2slope.r2.4$r2)

Fish4finalRMR <- matrix(c(Fish4, Fish4avgslope, Fish4avgslopehour, Fish4avgR2), nrow=1, ncol=4)

# Bind all blanks from this trial together: 
average.slopes <- rbind(Fish1finalRMR, Fish2finalRMR, Fish3finalRMR, Fish4finalRMR)

#Add mean temp of this trial to final file: 
average.slopes <- cbind(average.slopes, mean(RMR$Temp))
colnames(average.slopes) <- c("FishID", "FinalSlope", "FinalSlopeHour", "FinalR2", "meanTemp")

slopes.all.final.blanks <- rbind(average.slopes, slopes.all.final.blanks)


```

# Transform final data 
```{r}

# Transform the final slopes.all.final file into a dataframe. Only run this after appending all of the slopes for every trial to slopes.all.final. 

slopes.all.final <-as.data.frame(slopes.all.final) 

str(slopes.all.final)

slopes.all.final <- transform(slopes.all.final, FinalSlope = as.numeric(as.character(FinalSlope)), FinalSlopeHour = as.numeric(as.character(FinalSlopeHour)), FinalR2 = as.numeric(as.character(FinalR2)), meanTemp = as.numeric(as.character(meanTemp)))

str(slopes.all.final)

# Transform the same thing but for the blank slopes file

slopes.all.final.blanks <-as.data.frame(slopes.all.final.blanks) 

str(slopes.all.final.blanks)

slopes.all.final.blanks <- transform(slopes.all.final.blanks, FinalSlope = as.numeric(as.character(FinalSlope)), FinalSlopeHour = as.numeric(as.character(FinalSlopeHour)), FinalR2 = as.numeric(as.character(FinalR2)), meanTemp = as.numeric(as.character(meanTemp)))

str(slopes.all.final.blanks)

```


# Subtract blanks 

```{r}

names(slopes.all.final.blanks) <- c("BlankFishID", "BlankFinalSlope", "BlankFinalSlopeHour", "BlankFinalR2", "BlankmeanTemp")


slopes.all.final <- separate(slopes.all.final, FishID, c("Day", "Batch", "Chamber"), sep = "_", remove=FALSE)
blank <- separate(slopes.all.final.blanks, BlankFishID, c("Day", "Batch", "Chamber"), sep = "_", remove=FALSE)


joined <- inner_join(blank, slopes.all.final, by = c("Day", "Chamber"))

joined$CorrectedSlope <- (joined$FinalSlope - joined$BlankFinalSlope)
joined$CorrectedSlopeHour <- (joined$FinalSlopeHour - joined$BlankFinalSlopeHour)

corrected.slopes <- subset(joined, select=c("FishID", "meanTemp", "CorrectedSlope", "CorrectedSlopeHour", "FinalR2"))

```

# O2 Saturation Function: 
```{r}

# Function: 
O2.saturation<-function(salinity, temp, measured.atmP, perc.sat) {
  
  a=4.9e1
  b=-1.335
  c=2.759e-2
  d=-3.235e-4
  e=1.598e-6
  p=5.516e-1
  q=-1.759e-2
  r=2.253e-4
  s=-2.654e-7
  t=5.362e-8
  A=5.257e1
  B=6.69e3
  C=4.681
  TK=temp+273
  Chloride=(salinity-0.03)/1.805
  atmPsealevel=1013
  MolVol=22.414
  MWO2=32
  
  alpha=a+(b*temp)+(c*temp^2)+(d*temp^3)+(e*temp^4)-(Chloride*(p+(q*temp)+(r*temp^2)+(s*temp^3)+(t*temp^4)))
  bunsen=alpha/1000
  vapP=exp(A-(B/TK)-(C*log(TK)))
  
  umoleO2.per.L<-(((measured.atmP-vapP)/atmPsealevel)*(perc.sat/100)*0.2095*bunsen*1e6*(1/MolVol))
  mgO2.per.L<-umoleO2.per.L*(MWO2/1000)
  pO2.torr<-((measured.atmP-vapP)*((perc.sat/100)*0.2095))*0.75
  pO2.mbar<-pO2.torr/0.75
  pO2.kPa<-pO2.mbar/10
  
  output<-data.frame(salinity, temp, measured.atmP, perc.sat, umoleO2.per.L, mgO2.per.L, pO2.torr, pO2.mbar, pO2.kPa)
  print(output) # I changed this so it only gives me umoleO2.per.L, take out the [5] if you want all the variables
}

```

## O2 calcs, all slopes

### Load morphometrics data file
```{r, eval=FALSE}
MorphometricsData<-read.csv("2018BurbotRespirometryMorphometrics.csv")
O2.all<-merge(slopes.all, MorphometricsData, by=c("FishID"), all.x=TRUE)
# O2.all<-merge(slopes.all, MorphometricsData, by=c("FishID"), all.x=TRUE)
# Use the commented out line after you have your big giant slopes file from all the trials. 

```

### O2 saturation
```{r, eval=FALSE}

#O2.sol <- as.numeric(O2.saturation(0, test.Temp, BP.mBar, 100))[[6]] #The 6th one is mg.O2.L, salinity was set to 0

# Add columns for 100% saturation in two units. This use salinity, temperature, and barometric pressure of the trial to calculate what 100% oxygen would be. 
O2.all$mgO2perL <-O2.saturation(0,O2.all$meanTemp,O2.all$BaroPressure.hPa., 100)[[6]]
O2.all$umoleO2.per.L <-O2.saturation(0,O2.all$meanTemp,O2.all$BaroPressure.hPa., 100)[[5]]

# The function just needs salinity, temp, barometric pressure in hPa, and percent saturation, usually 100% for our purposes. 

```

### O2 units
```{r, eval=FALSE}
# convert from %saturation to mgO2/L*h and mmolO2/L*h
O2.all$mgO2Lh<-(O2.all$Slope.hour/100)*O2.all$mgO2perL
O2.all$mmolO2Lh<-(O2.all$Slope.hour/100)*(O2.all$umoleO2.per.L/1000)

# Remove fish mass from chamber volume because fish is displacing water volume. 

O2.all$Net.vol <- (O2.all$ChamberVolume.mL. - O2.all$Weight.g.)


# Remove liters from calculation (net.vol in mL) mgO2/h and mmolO2/h
# Net volume is in mL, but O2 saturation is in L, so you have to divide by 1000.
O2.all$mgO2h<-O2.all$mgO2Lh*O2.all$Net.vol/1000
O2.all$mmolO2h<-O2.all$mmolO2Lh*O2.all$Net.vol/1000

# Multiply by -1 to have a positive O2 rate
O2.all<- mutate(O2.all, mgO2h.pos = mgO2h*-1)
O2.all<- mutate(O2.all, mmolO2h.pos = mmolO2h*-1)

# Calculate mass specific metabolic rates (mass in g)
O2.all$mass.specific.rate.mgO2kghr <- (O2.all$mgO2h.pos/(O2.all$Weight.g./1000))
O2.all$mass.specific.rate.mmolO2kghr <- (O2.all$mmolO2h.pos/(O2.all$Weight.g./1000))
O2.all$mass.specific.rate.mgO2kgmin <- (O2.all$mass.specific.rate.mgO2kghr/60)
O2.all$mass.specific.rate.mmolO2kgmin <- (O2.all$mass.specific.rate.mmolO2kghr/60)

```

### Plot 
```{r, eval=FALSE}

ggplot(O2.all, aes(x=Time.m, y=mass.specific.rate.mmolO2kghr)) + 
  geom_point(aes(color=FeedStrat))


```

## O2 calcs, final slopes

### Load morphometrics data file
```{r}
MorphometricsData<-read.csv("2018BurbotRespirometryMorphometrics.csv")
O2.all.final<-merge(corrected.slopes, MorphometricsData, by=c("FishID"), all.x=TRUE)
# O2.all<-merge(slopes.all, MorphometricsData, by=c("FishID"), all.x=TRUE)
# Use the commented out line after you have your big giant slopes file from all the trials. 

```

### O2 saturation
```{r}

#O2.sol <- as.numeric(O2.saturation(0, test.Temp, BP.mBar, 100))[[6]] #The 6th one is mg.O2.L, salinity was set to 0

# Add columns for 100% saturation in two units. This use salinity, temperature, and barometric pressure of the trial to calculate what 100% oxygen would be. 
O2.all.final$mgO2perL <-O2.saturation(0,O2.all.final$meanTemp,O2.all.final$BaroPressure.hPa., 100)[[6]]
O2.all.final$umoleO2perL <-O2.saturation(0,O2.all.final$meanTemp,O2.all.final$BaroPressure.hPa., 100)[[5]]

# The function just needs salinity, temp, barometric pressure in hPa, and percent saturation, usually 100% for our purposes. 

```

### O2 units
```{r Converting from % Oxygen Saturation to mmolO2/L*h}
# convert from %saturation to mgO2/L*h and mmolO2/L*h
O2.all.final$mgO2Lh<-(O2.all.final$CorrectedSlopeHour/100)*O2.all.final$mgO2perL
O2.all.final$mmolO2Lh<-(O2.all.final$CorrectedSlopeHour/100)*(O2.all.final$umoleO2perL/1000)

# Remove fish mass from chamber volume because fish is displacing water volume. 

O2.all.final$Net.vol <- (O2.all.final$ChamberVolume.mL. - O2.all.final$Weight.g.)


# Remove liters from calculation (net.vol in mL) mgO2/h and mmolO2/h
# Net volume is in mL, but O2 saturation is in L, so you have to divide by 1000.
O2.all.final$mgO2h<-O2.all.final$mgO2Lh*O2.all.final$Net.vol/1000
O2.all.final$mmolO2h<-O2.all.final$mmolO2Lh*O2.all.final$Net.vol/1000

# Multiply by -1 to have a positive O2 rate
O2.all.final<- mutate(O2.all.final, mgO2h.pos = mgO2h*-1)
O2.all.final<- mutate(O2.all.final, mmolO2h.pos = mmolO2h*-1)

# Calculate mass specific metabolic rates (mass in g)
O2.all.final$mass.specific.rate.mgO2kghr <- (O2.all.final$mgO2h.pos/(O2.all.final$Weight.g./1000))
O2.all.final$mass.specific.rate.mmolO2kghr <- (O2.all.final$mmolO2h.pos/(O2.all.final$Weight.g./1000))
O2.all.final$mass.specific.rate.mgO2kgmin <- (O2.all.final$mass.specific.rate.mgO2kghr/60)
O2.all.final$mass.specific.rate.mmolO2kgmin <- (O2.all.final$mass.specific.rate.mmolO2kghr/60)

O2.all.final$mass.specific.rate.umolO2ghr <- ((O2.all.final$mmolO2h.pos*1000)/O2.all.final$Weight.g.)

O2.all.final$mass.specific.rate.mgO2per25gperhr <- 
  ((O2.all.final$mass.specific.rate.mgO2kghr/1000)*25)

```

### Plot 
```{r}

ggplot(O2.all.final, aes(x=FishID, y=mass.specific.rate.umolO2ghr)) + 
  geom_point()

```



# Exploring
```{r, eval=FALSE}

ggplot(O2.all.final, aes(x=Weight.g., y=mass.specific.rate.umolO2ghr)) +
  geom_point(aes(color=FeedStrat))


# Graph metabolic rate against weight with one linear model 
ggplot(O2.all.final, aes(x=Weight.g., y=mass.specific.rate.umolO2ghr)) +
  geom_point(aes(color=FeedStrat)) +
  geom_smooth(method='lm', se=T)

mod1 <- lm(mass.specific.rate.umolO2ghr ~ Weight.g., data = O2.all.final)
summary(mod1)

# Graph metabolic rate against weight with linear models for each feeding strategy 
ggplot(O2.all.final, aes(x=Weight.g., y=mass.specific.rate.umolO2ghr, group = FeedStrat)) +
  geom_point(aes(color=FeedStrat)) +
  geom_smooth(method='lm', se=T)

mod2 <- lm(mass.specific.rate.umolO2ghr ~ FeedStrat*Weight.g., data = O2.all.final)
summary(mod2)

ggplot(O2.all.final, aes(x=FishID, y=Weight.g.)) +
  geom_point(aes())

```


## Data exploration
```{r}

# The final data MO2 that we want to look at is O2.all.final. These are the average 3 lowest slopes (after removing M1 and M2) and are all blank corrected. Let's subset the data we need for stats (we don't need the MO2 values in ten different units). 

select.O2.all.final <- subset(O2.all.final, select = c("FishID", "meanTemp", "Day", "Batch", "Family", "FeedStrat", "Chamber", "Weight.g.", "TotalLength.mm.", "mass.specific.rate.umolO2ghr"))

select.O2.all.final <- droplevels(select.O2.all.final)

str(select.O2.all.final)

summary(select.O2.all.final)

# Check spread of mass specific metabolic rates without looking at treatment: 
ggplot(select.O2.all.final, aes(x=FishID, y=mass.specific.rate.umolO2ghr)) + 
  geom_point()


# Cleveland dot plot

dotchart(select.O2.all.final$mass.specific.rate.umolO2ghr, main = "Cleveland Dotplot", xlab= "Metabolic Rate (umol O2 / (g*hr)", ylab="Order of Samples")

# Definitely looks like there could be a few outliers far right. I wonder if this is just a particularly large family? 

dotchart(select.O2.all.final$mass.specific.rate.umolO2ghr, groups = factor(select.O2.all.final$Family), main = "Cleveland Dotplot", xlab= "Metabolic Rate (umol O2 / (g*hr)", ylab="Order of Samples", gpch = O2.all.final$Family)

## Interesting, it looks like family L1 has the majority of the high values. This was also the family that was run on Day 1. Maybe it's handling stress... 

# What about by feed strat? 

dotchart(select.O2.all.final$mass.specific.rate.umolO2ghr, groups = factor(select.O2.all.final$FeedStrat), main = "Cleveland Dotplot", xlab= "Metabolic Rate (umol O2 / (g*hr)", ylab="Order of Samples", gpch = O2.all.final$FeedStrat)

## Overall the spread of the data values looks the same for Family and for Feeding Strategy, the two variables of primary interest. This means we are not violating the assumption of homogeneity, which is good! There may be a few large outliers, though. 


# What about by chamber?

dotchart(select.O2.all.final$mass.specific.rate.umolO2ghr, groups = factor(select.O2.all.final$Chamber), main = "Cleveland Dotplot", xlab= "Metabolic Rate (umol O2 / (g*hr)", ylab="Order of Samples", gpch = O2.all.final$FeedStrat)

## Chamber P2 definitely looks skewed to the left compared to the rest of the data. 

# Not only should we look at dotplots of the response variable (metabolic rate), we should also examine dotplots of the explanatory variables. You can only look at numerical variables with this function: 

dotchart(select.O2.all.final$meanTemp, main="Cleveland Dotpot", xlab="meanTemp", ylab="order of samples")
dotchart(select.O2.all.final$Weight.g., main="Cleveland Dotpot", xlab="Weight of fish", ylab="order of samples")
dotchart(select.O2.all.final$TotalLength.mm., main="Cleveland Dotpot", xlab="fish Length", ylab="order of samples")


# Pairplots

pairs(select.O2.all.final)

## Really not sure what I'm supposed to be looking for here.... 


# Boxplot 

pd <-position_dodge(0.8)
p=ggplot(data=select.O2.all.final, aes(x=FeedStrat, y=mass.specific.rate.umolO2ghr))
p+geom_boxplot(position=pd) + 
  labs(x = "Feeding Strategy", y="Metabolic Rate (umol O2/(g*hr)") 

pd <-position_dodge(0.8)
p=ggplot(data=select.O2.all.final, aes(x=Family, y=mass.specific.rate.umolO2ghr))
p+geom_boxplot(position=pd) + 
  labs(x = "Family", y="Metabolic Rate (umol O2/(g*hr)") 

# Potentially a few high outliers (3 for each feeding strategy). However, Zurr et al. says that just because boxplot picks these few out doesn't mean you should definitely remove them! You should only remove outliers if you have a biological reason to (I think). 

```

## Modeling
You need to decide which model to test before running statistics. The model should be based on the biological understanding of the system. To chose a model: 
1) Include everything that you think is biologically important
2) If you do test multiple models and they are not significantly different, choose the simpler model. 
It's okay to look at different models if they all make sense biologically, but don't just go randomly testing models. Think about the question and the biological system and then test a few relevant models. 
```{r}

library(nlme)

# Just feeding strategy
mod1 <- lm(mass.specific.rate.umolO2ghr~FeedStrat, data = select.O2.all.final)

# Should I include family? 

## Family as a fixed effect
mod2 <- lm(mass.specific.rate.umolO2ghr~FeedStrat*Family, data = select.O2.all.final)

# Family as a random effect
mod3 <- lmer(mass.specific.rate.umolO2ghr~FeedStrat + (1|Family), data=select.O2.all.final)


AIC(mod1, mod2, mod3)
anova(mod1, mod2, mod3)

## mod2, which includes family as a fixed effect, is the best. 

## A note on AIC from Zuur: "AIC quantifies the relative proximity to absolute reality amongst a candidate set of models, ideally chosen a priori."

# During the experiment and while calculating slopes, I noticed that one of the chambers (P2) seemed strange where the values all seemed very low compared to the other planktivore chambers. I'm skeptical of taking the metabolic rate from these chambers as-is because of this observation, but I also don't think that I need to remove them completely because they are still information. So, I want to see if my model improves when I include chamber as an effect. I need to create a new column for the chambers so I can group the factors properly in the model. I don't have eight different identicial chambers, really I have two levels (planktivore chambers vs. cannibal chambers) with four chambers of each type. So I need to nest four chambers per each chamber type. 
select.O2.all.final$chambernew = as.factor( str_replace_all(select.O2.all.final$Chamber,
                c("C" = "",
                  "P" = "")))

unique(select.O2.all.final$chambernew)

# Mixed effect of the interaction of feeding strategy and family with chamber as a random effect.
mod7 <- lmer(mass.specific.rate.umolO2ghr~FeedStrat*Family + (1|FeedStrat:chambernew), data = select.O2.all.final)

# Fixed effect model on the interation of feeding strategy and family with chamber as a fixed effect. 
mod8 <- lm(mass.specific.rate.umolO2ghr~FeedStrat*Family + FeedStrat:chambernew, data = select.O2.all.final)

AIC(mod7, mod8)
anova(mod7,mod8)
# The AIC values don't agree between the AIC and anova commands. What the heck does this mean? 

## Including the chamber improves the model! The best fit is model 7, which includes the chamber as a random effect. That makes the most sense given the experiment, anyways. 



# BUT, do we really want to compare each family separately? Perhaps we want to compare "lake" families versus "river" families. So instead of comparing four levels for family, let's look at river vs. lake.  

select.O2.all.final$adapted = as.factor( str_replace_all(select.O2.all.final$Family,
                c("L1" = "Lake",
                  "L2" = "Lake", 
                  "R1" = "River", 
                  "R2" = "River")))

# Mixed effect model on the interaction of feeding strategy and environment adaptation with a random effect of chamber. 
mod10 <- lmer(mass.specific.rate.umolO2ghr~FeedStrat*adapted + (1|FeedStrat:chambernew), data = select.O2.all.final)


AIC(mod7, mod10)
anova(mod7, mod10)
## The model using "adaptation" instead of Family fit the data worse, so stick with just Family. 


# What about including time of day (i.e. batch)? 

mod12 <- lmer(mass.specific.rate.umolO2ghr~FeedStrat*Family + (1|FeedStrat:chambernew) + (1|Batch), data = select.O2.all.final)

AIC(mod7, mod12)
anova(mod7, mod12)

# Batch doesn't help fit the data better, don't include it in the model.


# What about fish weight and temperature? I strongly think that you should not include these in the model because they're already incorporated into the calculation of metabolic rate. If you include them then you risk pseudo correlation or auto correlation, where you are over-confident in your model because you're fitting the model to a variable that you used to generate the response values. So don't do that. 


# Best model

library(HH)

best_mod <- mod7
residuals <- resid(best_mod) 
# Residuals are the observed values inus the fitted values. 
hist(residuals)

# Check to see if the variance of treatment groups is the same. 
hov(residuals~factor(paste(FeedStrat, Family)), data=select.O2.all.final)
## It's the same. 

# Another way to statistically check the variance. 
bartlett.test(residuals, select.O2.all.final$FeedStrat)
bartlett.test(residuals, select.O2.all.final$Family)
## According to this test, the variance is the same between feeding strategies but NOT between families. This is seen in the histograms below. Apparently the Bartlett test is very sensitive to non-normality. 

plot(fitted(best_mod), residuals)
plot(select.O2.all.final$FeedStrat, residuals, xlab="FeedStrat", ylab="Residuals") 
plot(select.O2.all.final$Family, residuals, xlab="Family", ylab="Residuals")
# Variance between feeding strategies looks the same, but the variance between families is not the same. 

scatter.smooth(fitted(best_mod), resid(best_mod), main="Tukey-Anscombe Plot")
qqnorm(resid(best_mod), main="normal QQ-plot, residuals")
qqline(resid(best_mod))

# qq plot is a little questionable on the high end, we want to do a statistical test to check for normality. That is the Shapiro-Wilks test. 

shapiro.test(residuals)

## The null hypothesis is that the data IS normally distributed. The p-value is teeny tiny, which means it's the alternative hypothesis that it's NOT normally distributed. :'( Because of this I need to look at other models that could fit the data better. Let's try log transforming the data and using the same model to see if that fixes it. 


select.O2.all.final$log.mass.specific.rate.umolO2ghr = log(select.O2.all.final$mass.specific.rate.umolO2ghr)


mod72 <- lmer(log.mass.specific.rate.umolO2ghr~FeedStrat*Family + (1|FeedStrat:chambernew), data = select.O2.all.final)

residuals <- resid(mod72)
hist(residuals)
hov(residuals~factor(paste(FeedStrat, Family)), data=select.O2.all.final)
plot(fitted(mod72), residuals)
scatter.smooth(fitted(mod72), resid(mod72), main="Tukey-Anscombe Plot")
qqnorm(resid(mod72), main="normal QQ-plot, residuals")
qqline(resid(mod72))
shapiro.test(residuals)


scatter.smooth(fitted(best_mod), sqrt(abs(resid(best_mod))), main="res. var vs. fitted")
summary(best_mod)
anova(best_mod)

# Tukey test to see which groups are actually different 
TukeyTest = lsmeans(best_mod, tukey ~ FeedStrat:Family)
cld(TukeyTest)

# I think this means that none of the groups are significantly different from each other.... 


library(nmle)
mod7gls <- gls(mass.specific.rate.umolO2ghr ~ FeedStrat*Family + (1|FeedStrat:chambernew), data = select.O2.all.final)



```


## Graphing
```{r}

boxplot(select.O2.all.final$mass.specific.rate.umolO2ghr ~ select.O2.all.final$FeedStrat + select.O2.all.final$Family)

```


